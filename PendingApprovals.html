<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUAREZ ACADEMY - Aprobaciones Pendientes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navegaci√≥n Superior */
        .top-navigation {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .nav-logo .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            font-size: 1.2em;
        }

        .nav-menu {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 100%;
        }

        .nav-item {
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            color: #2c3e50;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-size: 0.9em;
            white-space: nowrap;
            min-width: fit-content;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

            .nav-item.active::before {
                content: 'üìç ';
            }

            .nav-item.close-btn {
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                border: 2px solid #ef4444;
            }

            .nav-item.close-btn:hover {
                background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            }

            /* Responsive para men√∫ */
            @media (max-width: 1200px) {
                .nav-menu {
                    gap: 6px;
                }
                
                .nav-item {
                    padding: 5px 10px;
                    font-size: 0.85em;
                }
            }

            @media (max-width: 768px) {
                .nav-menu {
                    gap: 4px;
                    flex-wrap: wrap;
                }
                
                .nav-item {
                    padding: 4px 8px;
                    font-size: 0.8em;
                    border-radius: 4px;
                }
            }

            @media (max-width: 480px) {
                .nav-menu {
                    flex-direction: column;
                    gap: 4px;
                    align-items: center;
                }
                
                .nav-item {
                    width: 100%;
                    max-width: 200px;
                    text-align: center;
                    padding: 6px 12px;
                }
            }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #fbbf24;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-item h3 {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-item p {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .approvals-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .approvals-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
        }

        .approvals-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .approvals-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef9e7;
            color: #f39c12;
        }

        .status-approved {
            background: #d5f4e6;
            color: #27ae60;
        }

        .status-rejected {
            background: #fadbd8;
            color: #e74c3c;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .file-link {
            color: #4285f4;
            text-decoration: none;
            font-size: 1.2em;
            margin: 0 2px;
            transition: color 0.3s ease;
        }

        .file-link:hover {
            color: #1a73e8;
            text-decoration: underline;
        }

        /* Animaci√≥n de carga con bal√≥n */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        .loading-text {
            display: inline-flex;
            align-items: center;
            color: #3498db;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #2c3e50;
            font-size: 1.5em;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .player-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .detail-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .detail-value {
            color: #2c3e50;
        }

        .approval-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            resize: vertical;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        /* Estilos para la vista de detalles mejorada */
        .approval-details {
            max-height: 70vh;
            overflow-y: auto;
            padding: 20px;
        }

        .detail-section {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }

        .detail-section h3 {
            color: #1e3a8a;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #374151;
            min-width: 150px;
        }

        .detail-value {
            color: #6b7280;
            text-align: right;
            flex: 1;
            margin-left: 15px;
        }

        .player-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .player-card h4 {
            color: #1e3a8a;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .file-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .file-link {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }

        .file-link:hover {
            color: #1e3a8a;
            text-decoration: underline;
        }

        .type-badge {
            background: #dbeafe;
            color: #1e3a8a;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .category-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        /* Mejorar la tabla */
        .approvals-table td {
            vertical-align: top;
            padding: 12px 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .approvals-table td strong {
            color: #1f2937;
            font-weight: 600;
        }

        .approvals-table td small {
            font-size: 0.8em;
            line-height: 1.3;
        }

        /* Mejorar los botones de acci√≥n */
        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 6px 8px;
            font-size: 0.8em;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        /* Bulk actions y checkboxes removidos - simplificado para usuarios finales */
        /*
        .bulk-actions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .checkbox {
            margin-right: 8px;
        }
        */

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .player-details {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .approval-actions {
                flex-direction: column;
            }
        }
        
        /* Animaciones para toasts */
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

    /* Global Loading Overlay - Bal√≥n de F√∫tbol */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }

    .loading-content {
        background: white;
        border-radius: 20px;
        padding: 40px 50px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        text-align: center;
    }

    .football-loader {
        font-size: 80px;
        animation: spin-football 1s linear infinite;
        display: inline-block;
    }

    @keyframes spin-football {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        margin-top: 20px;
        font-size: 1.3em;
        font-weight: bold;
        color: #1e3a8a;
    }
    </style>
</head>
<body>
    <!-- Global Loading Overlay -->
    <div class="loading-overlay" id="globalLoading">
        <div class="loading-content">
            <div class="football-loader">‚öΩ</div>
            <div class="loading-text">Cargando...</div>
        </div>
    </div>
    <div class="container">
        <!-- Navegaci√≥n Superior -->
        <nav class="top-navigation">
            <div class="nav-logo">
                <div class="logo-icon">‚öΩ</div>
                SUAREZ ACADEMY
            </div>
                    <div class="nav-menu">
                        <a href="#" class="nav-item" onclick="navigateTo('players')">üë• Jugadores</a>
                        <a href="#" class="nav-item" onclick="navigateTo('families')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familias</a>
                        <a href="#" class="nav-item" onclick="navigateTo('financial')">üí∞ Financiero</a>
                        <!-- <a href="#" class="nav-item" onclick="navigateTo('expenses')">üí∏ Gastos</a> -->
                        <a href="#" class="nav-item active" onclick="navigateTo('approvals')">‚úÖ Aprobaciones</a>
                        <a href="#" class="nav-item" onclick="navigateTo('tournaments')">üèÜ Torneos</a>
                        <a href="#" class="nav-item" onclick="navigateTo('historic')">üìú Hist√≥rico</a>
                        <a href="#" class="nav-item" onclick="navigateTo('config')">‚öôÔ∏è Config</a>
                        <a href="#" class="nav-item close-btn" onclick="closeWindow()">‚ùå Cerrar</a>
                    </div>
        </nav>

        <div class="header">
            <h1>‚úÖ SUAREZ ACADEMY - Aprobaciones Pendientes</h1>
        </div>

        <div class="controls">
            <input type="text" id="searchInput" class="search-box" placeholder="üîç Buscar por nombre, c√©dula o tel√©fono...">
            <select id="typeFilter" class="filter-select">
                <option value="">Todos los tipos</option>
                <option value="admision">Admisi√≥n</option>
                <option value="torneo">Torneo</option>
            </select>
            <button class="btn btn-primary" onclick="refreshApprovals()">
                üîÑ Actualizar
            </button>
        </div>
        
        <!-- Indicador de resultados de b√∫squeda -->
        <div id="searchResultsIndicator" style="display: none; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 12px 20px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #3b82f6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <span style="color: #1e3a8a; font-weight: 600; font-size: 1.05em;">
                üîç Mostrando <span id="filteredCount" style="color: #3b82f6; font-weight: 700;">0</span> de <span id="totalCount" style="color: #6b7280;">0</span> solicitudes
            </span>
            <button onclick="clearAllFilters()" style="background: #3b82f6; color: white; border: none; padding: 6px 14px; border-radius: 6px; margin-left: 15px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.2s ease;"
                    onmouseover="this.style.background='#2563eb'; this.style.transform='scale(1.05)'"
                    onmouseout="this.style.background='#3b82f6'; this.style.transform='scale(1)'">
                ‚úñ Limpiar filtros
            </button>
        </div>

        <div class="main-content">
            <!-- Bulk actions removidas - simplificado para usuarios finales -->

            <div class="stats-row">
                <div class="stat-item">
                    <h3 id="totalApprovals">0</h3>
                    <p>Total Solicitudes</p>
                </div>
                <div class="stat-item">
                    <h3 id="pendingApprovals">0</h3>
                    <p>Pendientes</p>
                </div>
                <div class="stat-item">
                    <h3 id="approvedToday">0</h3>
                    <p>Aprobados Hoy</p>
                </div>
                <div class="stat-item">
                    <h3 id="rejectedToday">0</h3>
                    <p>Rechazados Hoy</p>
                </div>
            </div>

            <div class="table-container">
                <table class="approvals-table">
                    <thead>
                        <tr>
                            <!-- Checkbox header removido - simplificado -->
                            <th>Jugador</th>
                            <th>Edad</th>
                            <th>Categor√≠a</th>
                            <th>Tutor/Padre</th>
                            <th>Tipo</th>
                            <th>Fecha</th>
                            <th>Archivos</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                            <th>ID</th>
                        </tr>
                    </thead>
                    <tbody id="approvalsTableBody">
                        <tr>
                            <td colspan="9" class="loading">Cargando aprobaciones...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalles y aprobar/rechazar -->
    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalles de Solicitud</h2>
                <span class="close" onclick="closeApprovalModal()">&times;</span>
            </div>
            <div id="approvalContent">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <!-- Modal para rechazar con motivo -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Rechazar Solicitud</h2>
                <span class="close" onclick="closeRejectModal()">&times;</span>
            </div>
            <form id="rejectForm">
                <div class="form-group">
                    <label for="rejectReason">Motivo del rechazo *</label>
                    <textarea id="rejectReason" rows="4" required placeholder="Explique el motivo del rechazo..."></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeRejectModal()" style="background: #95a5a6; color: white; margin-right: 10px;">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-danger">
                        Rechazar Solicitud
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allApprovals = [];
        let currentApprovalId = null;

        // Funci√≥n de navegaci√≥n directa - abre nueva ventana directamente
        function navigateTo(section) {
            try {
                // Si ya estamos en la secci√≥n, no hacer nada
                if (section === 'approvals') {
                    return;
                }
                
                console.log('Navegando a:', section);
                
                // Abrir nueva ventana directamente
                switch(section) {
                    case 'dashboard':
                        google.script.run.showMainDashboard();
                        break;
                    case 'players':
                        google.script.run.showPlayersManager();
                        break;
                    case 'families':
                        google.script.run.showFamilyGroupsManager();
                        break;
                    case 'financial':
                        google.script.run.showFinancialManager();
                        break;
                    case 'historic':
                        google.script.run.showHistoricPlayersManager();
                        break;
                    case 'config':
                        google.script.run.showSystemConfig();
                        break;
                }
            } catch (error) {
                console.error('Error navegando:', error);
            }
        }

        // Funci√≥n para cerrar ventana
        function closeWindow() {
            try {
                google.script.host.close();
            } catch (error) {
                console.error('Error cerrando ventana:', error);
            }
        }

        // Hacer las funciones globales para que est√©n disponibles en todas las ventanas
        window.navigateTo = navigateTo;
        window.closeWindow = closeWindow;

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            loadApprovals();
            setupEventListeners();
        });

        // Configurar event listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterApprovals);
            document.getElementById('typeFilter').addEventListener('change', filterApprovals);
            
            document.getElementById('rejectForm').addEventListener('submit', processRejection);
        }

        // Cargar aprobaciones
        function loadApprovals() {
            try {
                console.log('Cargando aprobaciones pendientes...');
                
                // Mostrar indicador de carga
                showLoadingState();
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Resultado de getPendingApprovalsData:', result);
                        console.log('Tipo de resultado:', typeof result);
                        console.log('Es array:', Array.isArray(result));
                        
                        // Ocultar indicador de carga
                        hideLoadingState();
                        
                        // Verificar si es un objeto de error
                        if (result && typeof result === 'object' && result.error) {
                            showError('Error del servidor: ' + result.message);
                            return;
                        }
                        
                        // Verificar si es un array
                        if (Array.isArray(result)) {
                            console.log(`Procesando ${result.length} aprobaciones`);
                            updateApprovalsTable(result);
                            
                            // Cargar estad√≠sticas del hist√≥rico
                            loadHistoricStats(result);
                        } else if (result === null || result === undefined) {
                            console.log('Resultado es null/undefined, mostrando mensaje');
                            updateApprovalsTable([]);
                            loadHistoricStats([]);
                        } else {
                            console.error('Resultado inesperado:', result);
                            console.error('Tipo:', typeof result);
                            console.error('Constructor:', result.constructor.name);
                            
                            // Intentar convertir a array si es posible
                            if (result && typeof result === 'object') {
                                console.log('Intentando convertir objeto a array...');
                                const arrayResult = Object.values(result);
                                if (Array.isArray(arrayResult)) {
                                    updateApprovalsTable(arrayResult);
                                    loadHistoricStats(arrayResult);
                                    return;
                                }
                            }
                            
                            showError('Error: Resultado inesperado del servidor - Tipo: ' + typeof result);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error en getPendingApprovalsData:', error);
                        console.log('Intentando con getAllApprovalsData como respaldo...');
                        loadAllApprovals();
                    })
                    .getPendingApprovalsData();
            } catch (error) {
                console.error('Error en loadApprovals:', error);
                hideLoadingState();
                showError('Error cargando aprobaciones: ' + error.message);
            }
        }

        function loadAllApprovals() {
            try {
                console.log('Cargando todas las aprobaciones como respaldo...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Resultado de getAllApprovalsData:', result);
                        console.log('Tipo de resultado:', typeof result);
                        console.log('Es array:', Array.isArray(result));
                        
                        // Ocultar indicador de carga
                        hideLoadingState();
                        
                        // Verificar si es un array
                        if (Array.isArray(result)) {
                            console.log(`Procesando ${result.length} aprobaciones (todas)`);
                            updateApprovalsTable(result);
                        } else {
                            console.log('No hay datos en getAllApprovalsData, mostrando mensaje');
                            updateApprovalsTable([]);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error en getAllApprovalsData:', error);
                        hideLoadingState();
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .getAllApprovalsData();
            } catch (error) {
                console.error('Error en loadAllApprovals:', error);
                hideLoadingState();
                showError('Error cargando todas las aprobaciones: ' + error.message);
            }
        }

        // Global Loading Functions
        function showLoading(message = 'Cargando...') {
            const loading = document.getElementById('globalLoading');
            const loadingText = loading.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = message;
            }
            loading.style.display = 'flex';
        }

        function hideLoading() {
            const loading = document.getElementById('globalLoading');
            loading.style.display = 'none';
        }

        // Mostrar estado de carga
        function showLoadingState() {
            const tbody = document.getElementById('approvalsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px;">
                        <div class="loading-text">
                            <div class="loading-spinner"></div>
                            ‚öΩ Cargando aprobaciones...
                        </div>
                    </td>
                </tr>
            `;
        }

        // Ocultar estado de carga
        function hideLoadingState() {
            // El estado de carga se oculta autom√°ticamente cuando se actualiza la tabla
        }

        // Actualizar tabla de aprobaciones
        function updateApprovalsTable(approvals) {
            allApprovals = approvals;
            filterApprovals();
            updateStats(approvals);
        }

        // Actualizar estad√≠sticas
        function updateStats(approvals) {
            const today = new Date().toDateString();
            
            const stats = {
                total: approvals.length,
                pending: approvals.filter(a => a.Estado === 'Pendiente').length,
                approvedToday: 0, // Se actualizar√° con datos del hist√≥rico
                rejectedToday: 0  // Se actualizar√° con datos del hist√≥rico
            };

            document.getElementById('totalApprovals').textContent = stats.total;
            document.getElementById('pendingApprovals').textContent = stats.pending;
            document.getElementById('approvedToday').textContent = stats.approvedToday;
            document.getElementById('rejectedToday').textContent = stats.rejectedToday;
        }

        function updateStatsWithHistoric(approvals, historicStats) {
            const stats = {
                total: approvals.length,
                pending: approvals.filter(a => a.Estado === 'Pendiente').length,
                approvedToday: historicStats.approvedToday || 0,
                rejectedToday: historicStats.rejectedToday || 0
            };

            document.getElementById('totalApprovals').textContent = stats.total;
            document.getElementById('pendingApprovals').textContent = stats.pending;
            document.getElementById('approvedToday').textContent = stats.approvedToday;
            document.getElementById('rejectedToday').textContent = stats.rejectedToday;
        }

        function loadHistoricStats(approvals) {
            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result && result.success) {
                            updateStatsWithHistoric(approvals, result.stats);
                        } else {
                            console.log('Error obteniendo estad√≠sticas del hist√≥rico:', result.message);
                            updateStats(approvals);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error cargando estad√≠sticas del hist√≥rico:', error);
                        updateStats(approvals);
                    })
                    .getHistoricStats();
            } catch (error) {
                console.error('Error en loadHistoricStats:', error);
                updateStats(approvals);
            }
        }

        // Filtrar aprobaciones
        function filterApprovals() {
            console.log('üîç filterApprovals llamada');
            console.log('allApprovals:', allApprovals);
            console.log('allApprovals.length:', allApprovals ? allApprovals.length : 'undefined');
            
            if (!allApprovals || allApprovals.length === 0) {
                console.log('‚ö†Ô∏è No hay aprobaciones para filtrar');
                return;
            }
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;

            console.log('üîç Filtrando aprobaciones:', {
                searchTerm: searchTerm,
                typeFilter: typeFilter,
                totalApprovals: allApprovals.length
            });

            const filteredApprovals = allApprovals.filter(approval => {
                // B√∫squeda flexible por nombre - usando los campos correctos del formulario
                const nombre = String(approval['Nombre completo del jugador'] || approval['Nombre del Jugador'] || approval['Nombre'] || '');
                const cedula = String(approval['N√∫mero de identificaci√≥n'] || approval['N√∫mero de Identificaci√≥n'] || approval['C√©dula'] || '');
                const telefono = String(approval['Tel√©fono de contacto'] || approval['Tel√©fono'] || '');
                const tutor = String(approval['Nombre completo del padre/tutor'] || approval['Tutor/Padre'] || '');
                
                const matchesSearch = !searchTerm || 
                    nombre.toLowerCase().includes(searchTerm) ||
                    cedula.toLowerCase().includes(searchTerm) ||
                    telefono.toLowerCase().includes(searchTerm) ||
                    tutor.toLowerCase().includes(searchTerm);

                // Filtro por tipo (m√°s flexible)
                let matchesType = true;
                if (typeFilter && typeFilter !== 'todos') {
                    const fuente = approval['Fuente'] || '';
                    const tipoAprobacion = approval['Tipo Aprobaci√≥n'] || '';
                    
                    console.log(`Filtro tipo: ${typeFilter}, Fuente: ${fuente}, Tipo: ${tipoAprobacion}`);
                    
                    if (typeFilter === 'admision') {
                        matchesType = fuente.includes('MATRICULA') || 
                                     tipoAprobacion.toLowerCase().includes('admisi√≥n') ||
                                     tipoAprobacion.toLowerCase().includes('admision');
                    } else if (typeFilter === 'torneo') {
                        matchesType = fuente.includes('TORNEO') || 
                                     tipoAprobacion.toLowerCase().includes('torneo');
                    }
                    
                    console.log(`matchesType para ${nombre}: ${matchesType}`);
                }

                console.log('Filtro para:', nombre, {
                    matchesSearch: matchesSearch,
                    matchesType: matchesType,
                    fuente: approval['Fuente']
                });

                return matchesSearch && matchesType;
            });

            console.log(`Filtro completado: ${filteredApprovals.length} de ${allApprovals.length} aprobaciones`);
            
            // Actualizar indicador de resultados
            updateSearchIndicator(filteredApprovals.length, allApprovals.length, searchTerm, typeFilter);
            
            renderApprovalsTable(filteredApprovals);
        }
        
        // Actualizar indicador de resultados de b√∫squeda
        function updateSearchIndicator(filtered, total, searchTerm, typeFilter) {
            const indicator = document.getElementById('searchResultsIndicator');
            const filteredCount = document.getElementById('filteredCount');
            const totalCount = document.getElementById('totalCount');
            
            // Mostrar indicador solo si hay filtros activos
            const hasActiveFilters = searchTerm || typeFilter;
            
            if (hasActiveFilters && filtered < total) {
                indicator.style.display = 'block';
                filteredCount.textContent = filtered;
                totalCount.textContent = total;
            } else {
                indicator.style.display = 'none';
            }
        }
        
        // Limpiar todos los filtros
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            filterApprovals();
        }

        // Renderizar tabla de aprobaciones
        function renderApprovalsTable(approvals) {
            const tbody = document.getElementById('approvalsTableBody');
            
            if (approvals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #7f8c8d;">No se encontraron aprobaciones</td></tr>';
                return;
            }

            // Debug: Mostrar campos disponibles en la consola
            if (approvals.length > 0) {
                console.log('Campos disponibles en el primer registro:', Object.keys(approvals[0]));
                console.log('Primer registro completo:', approvals[0]);
            }

            tbody.innerHTML = approvals.map(approval => {
                // Debug: Log del registro actual para debugging
                console.log('Procesando registro:', approval);
                
                // Obtener informaci√≥n del jugador principal - usando los nombres exactos del formulario
                const nombreJugador = approval['Nombre completo del jugador'] || approval['Nombre del Jugador'] || approval['Nombre'] || 'Sin nombre';
                const cedulaJugador = approval['N√∫mero de identificaci√≥n'] || approval['N√∫mero de Identificaci√≥n'] || 'Sin ID';
                const fechaNacimiento = approval['Fecha de nacimiento'] || 'N/A';
                const genero = approval['Genero del jugador'] || 'N/A';
                const telefono = approval['Tel√©fono de contacto'] || 'N/A';
                const tallaUniforme = approval['Talla de uniforme'] || 'N/A';
                
                // Informaci√≥n del tutor/padre
                const nombreTutor = approval['Nombre completo del padre/tutor'] || approval['Tutor/Padre'] || 'No especificado';
                const emailTutor = approval['Direcci√≥n de correo electr√≥nico'] || approval['Email del Tutor'] || '';
                const direccionTutor = approval['Direcci√≥n completa'] || 'No especificada';
                
                // Informaci√≥n de pago
                const metodoPago = approval['M√©todo de pago'] || 'No especificado';
                const fechaPago = approval['Fecha de pago'] || 'N/A';
                const comprobantePago = approval['Comprobante de pago'] || '';
                
                // Informaci√≥n de la solicitud
                const marcaTemporal = approval['Marca temporal'] || approval['Fecha de Solicitud'] || approval['Fecha Aplicaci√≥n'] || new Date();
                const fuente = approval['Fuente'] || 'FORM_MATRICULA';
                const estado = approval['Estado'] || 'Pendiente';
                
                // Procesar archivos adjuntos con estilo mejorado
                let filesHtml = '';
                try {
                    const archivosData = approval['Archivos Adjuntos'] || '[]';
                    const files = JSON.parse(archivosData);
                    
                    if (files && files.length > 0) {
                        // IMPORTANTE: Este orden DEBE coincidir con FormsHandler.gs
                        const fileTypes = [
                            {emoji: 'üÜî', label: 'C√©dula Frontal', color: '#3b82f6', bg: '#dbeafe'},      // 1. frontFile (M)
                            {emoji: 'üÜî', label: 'C√©dula Reverso', color: '#8b5cf6', bg: '#ede9fe'},      // 2. backFile (N)
                            {emoji: 'üí∞', label: 'Comprobante Pago', color: '#10b981', bg: '#d1fae5'},    // 3. comprobanteFile (H)
                            {emoji: 'üìÑ', label: 'Doc Tutor', color: '#f59e0b', bg: '#fef3c7'},          // 4. tFile (T)
                            {emoji: 'üìÑ', label: 'Documento U', color: '#ec4899', bg: '#fce7f3'},        // 5. uFile (U)
                            {emoji: 'üìé', label: 'Adjunto AA', color: '#06b6d4', bg: '#cffafe'},         // 6. aaFile (AA)
                            {emoji: 'üìé', label: 'Adjunto AB', color: '#64748b', bg: '#f1f5f9'}          // 7. abFile (AB)
                        ];
                        
                        filesHtml = files.map((file, idx) => {
                            let fileId = file;
                            let fileUrl = '';
                            
                            if (typeof file === 'object' && file !== null) {
                                fileId = file.id || file.fileId || file.url || '';
                            } else if (typeof file === 'string') {
                                fileId = file;
                            }
                            
                            if (fileId && typeof fileId === 'string') {
                                if (fileId.includes('drive.google.com')) {
                                    fileUrl = fileId;
                                } else if (fileId.length > 10) {
                                    fileUrl = 'https://drive.google.com/file/d/' + fileId + '/view';
                                }
                            }
                            
                            if (!fileUrl) return '';
                            
                            const fileType = fileTypes[idx] || {emoji: 'üìÑ', label: 'Archivo', color: '#6b7280', bg: '#f3f4f6'};
                            const safeNombre = nombreJugador.replace(/'/g, "\\'");
                            
                            return '<button ' +
                                'onclick="copyToClipboardAndOpen(\'' + fileUrl + '\', \'' + fileType.label + '\', \'' + safeNombre + '\'); return false;" ' +
                                'style="display: inline-block; margin: 3px; padding: 8px 14px; background: ' + fileType.bg + '; color: ' + fileType.color + '; border: 2px solid ' + fileType.color + '; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" ' +
                                'onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 8px rgba(0,0,0,0.15)\'; this.style.background=\'' + fileType.color + '\'; this.style.color=\'white\';" ' +
                                'onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.1)\'; this.style.background=\'' + fileType.bg + '\'; this.style.color=\'' + fileType.color + '\';" ' +
                                'title="' + fileType.label + ' de ' + nombreJugador + ' - Click para copiar enlace y abrir">' +
                                fileType.emoji + ' ' + fileType.label +
                                '</button>';
                        }).filter(link => link !== '').join('');
                    }
                    
                    if (!filesHtml) {
                        filesHtml = '<small style="color: #9ca3af; font-style: italic;">Sin archivos adjuntos</small>';
                    }
                } catch (e) {
                    console.error('Error procesando archivos:', e);
                    filesHtml = '<small style="color: #ef4444;">Error cargando archivos</small>';
                }

                // Contar jugadores adicionales
                let jugadoresAdicionales = 0;
                if (approval['Nombre completo del jugador 2'] && approval['Nombre completo del jugador 2'].trim() !== '') jugadoresAdicionales++;
                if (approval['Nombre completo del jugador 3'] && approval['Nombre completo del jugador 3'].trim() !== '') jugadoresAdicionales++;

                // Calcular edad
                let edad = 'N/A';
                if (fechaNacimiento && fechaNacimiento !== 'N/A') {
                    try {
                        const fechaNac = new Date(fechaNacimiento);
                        const hoy = new Date();
                        edad = hoy.getFullYear() - fechaNac.getFullYear();
                    } catch (e) {
                        edad = 'N/A';
                    }
                }

                // Determinar categor√≠a por edad y g√©nero
                let categoria = 'N/A';
                if (edad !== 'N/A' && genero !== 'N/A') {
                    const edadNum = parseInt(edad);
                    const generoCode = genero.toLowerCase().includes('masculino') || genero.toLowerCase().includes('hombre') ? 'M' : 'F';
                    
                    if (edadNum >= 6 && edadNum <= 7) categoria = `U-6 ${generoCode}`;
                    else if (edadNum >= 8 && edadNum <= 9) categoria = `U-8 ${generoCode}`;
                    else if (edadNum >= 10 && edadNum <= 11) categoria = `U-10 ${generoCode}`;
                    else if (edadNum >= 12 && edadNum <= 13) categoria = `U-12 ${generoCode}`;
                    else if (edadNum >= 14 && edadNum <= 15) categoria = `U-14 ${generoCode}`;
                    else if (edadNum >= 16 && edadNum <= 17) categoria = `U-16 ${generoCode}`;
                    else if (edadNum >= 18 && generoCode === 'F') categoria = `U-18 F`;
                    else categoria = `Categor√≠a no definida`;
                }

                return `
                    <tr>
                        <!-- Checkbox removido - simplificado -->
                        <td>
                            <strong>${nombreJugador}</strong><br>
                            <small style="color: #7f8c8d;">üÜî ${cedulaJugador}</small><br>
                            <small style="color: #7f8c8d;">üë§ ${genero} ‚Ä¢ ${edad} a√±os</small><br>
                            <small style="color: #7f8c8d;">üëï Talla: ${tallaUniforme}</small>
                            ${jugadoresAdicionales > 0 ? `<br><small style="color: #3b82f6; font-weight: bold;">‚öΩ +${jugadoresAdicionales} jugador(es) adicional(es)</small>` : ''}
                        </td>
                        <td>
                            <strong>${edad} a√±os</strong><br>
                            <small style="color: #7f8c8d;">${fechaNacimiento}</small>
                        </td>
                        <td>
                            <span class="category-badge">${categoria}</span>
                        </td>
                        <td>
                            <strong>${nombreTutor}</strong><br>
                            <small style="color: #7f8c8d;">üìû ${telefono}</small><br>
                            <small style="color: #7f8c8d;">üìß ${emailTutor}</small><br>
                            <small style="color: #7f8c8d;">üìç ${direccionTutor}</small>
                        </td>
                        <td>
                            ${fuente === 'FORM_TORNEO' 
                                ? `<span style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 0.85em; display: inline-block; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);">üèÜ TORNEO</span><br><small style="color: #7f8c8d;">‚öΩ ${approval['Nombre del Torneo'] || 'N/A'}</small>`
                                : `<span style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 0.85em; display: inline-block; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);">üìù MATR√çCULA</span>`
                            }<br>
                            <small style="color: #7f8c8d;">üí≥ ${metodoPago}</small>
                            ${fechaPago !== 'N/A' ? `<br><small style="color: #10b981;">üìÖ ${fechaPago}</small>` : ''}
                        </td>
                        <td>
                            <strong>${new Date(marcaTemporal).toLocaleDateString()}</strong><br>
                            <small style="color: #7f8c8d;">üïê ${new Date(marcaTemporal).toLocaleTimeString()}</small>
                        </td>
                        <td>
                            ${filesHtml}
                        </td>
                        <td><span class="status-badge status-${estado.toLowerCase()}">${estado}</span></td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 6px; min-width: 140px;">
                                ${estado === 'Pendiente' ? `
                                    <button onclick="approvePlayer('${approval.ID}')" 
                                            style="padding: 10px 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.4)'"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(16, 185, 129, 0.3)'"
                                            title="Aprobar jugador como normal">
                                        ‚úÖ Aprobar
                                    </button>
                                    <button onclick="approveAsScholarship('${approval.ID}')" 
                                            style="padding: 10px 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(245, 158, 11, 0.4)'"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(245, 158, 11, 0.3)'"
                                            title="Aprobar como becado (mensualidad $0)">
                                        üèÜ Becado
                                    </button>
                                    <button onclick="rejectPlayer('${approval.ID}')" 
                                            style="padding: 10px 16px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(239, 68, 68, 0.4)'"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(239, 68, 68, 0.3)'"
                                            title="Rechazar solicitud">
                                        ‚ùå Rechazar
                                    </button>
                                ` : `
                                    <span style="color: #6b7280; font-style: italic; font-size: 0.85em; padding: 8px; text-align: center;">
                                        ${estado === 'Aprobado' ? '‚úÖ Aprobado' : '‚ùå Rechazado'}
                                    </span>
                                `}
                            </div>
                        </td>
                        <td>
                            <small style="color: #9ca3af; font-size: 0.75em; font-family: monospace;">${approval.ID}</small>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Ver detalles de aprobaci√≥n
        function viewApprovalDetails(approvalId) {
            const approval = allApprovals.find(a => a.ID === approvalId);
            if (!approval) return;

            // Obtener informaci√≥n del jugador principal
            const nombreJugador = approval['Nombre completo del jugador'] || approval['Nombre del Jugador'] || approval['Nombre'] || 'Sin nombre';
            const apellidosJugador = approval['Apellidos del Jugador'] || approval['Apellidos'] || '';
            
            document.getElementById('modalTitle').textContent = `Detalles de ${nombreJugador} ${apellidosJugador}`;
            
            // Construir informaci√≥n de jugadores
            let jugadoresInfo = '';
            
            // Jugador 1 (Principal)
            const jugador1 = {
                nombre: approval['Nombre completo del jugador'] || 'No especificado',
                fechaNacimiento: approval['Fecha de nacimiento'] || 'No especificada',
                genero: approval['Genero del jugador'] || 'No especificado',
                cedula: approval['N√∫mero de identificaci√≥n'] || 'No especificada',
                tallaUniforme: approval['Talla de uniforme'] || 'No especificada'
            };
            
            jugadoresInfo += `
                <div class="player-card">
                    <h4>‚öΩ Jugador Principal</h4>
                    <div class="detail-item">
                        <span class="detail-label">Nombre:</span>
                        <span class="detail-value">${jugador1.nombre}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fecha de Nacimiento:</span>
                        <span class="detail-value">${jugador1.fechaNacimiento}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">G√©nero:</span>
                        <span class="detail-value">${jugador1.genero}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">C√©dula:</span>
                        <span class="detail-value">${jugador1.cedula}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Talla de Uniforme:</span>
                        <span class="detail-value">${jugador1.tallaUniforme}</span>
                    </div>
                </div>
            `;
            
            // Jugador 2 (si existe)
            if (approval['Nombre completo del jugador 2'] && approval['Nombre completo del jugador 2'].trim() !== '') {
                const jugador2 = {
                    nombre: approval['Nombre completo del jugador 2'] || 'No especificado',
                    fechaNacimiento: approval['Fecha de nacimiento jugador 2'] || 'No especificada',
                    cedula: approval['N√∫mero identificaci√≥n jugador 2'] || 'No especificada',
                    tallaUniforme: approval['Talla de uniforme jugador 2'] || 'No especificada'
                };
                
                jugadoresInfo += `
                    <div class="player-card">
                        <h4>‚öΩ Jugador 2</h4>
                        <div class="detail-item">
                            <span class="detail-label">Nombre:</span>
                            <span class="detail-value">${jugador2.nombre}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Fecha de Nacimiento:</span>
                            <span class="detail-value">${jugador2.fechaNacimiento}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">C√©dula:</span>
                            <span class="detail-value">${jugador2.cedula}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Talla de Uniforme:</span>
                            <span class="detail-value">${jugador2.tallaUniforme}</span>
                        </div>
                    </div>
                `;
            }
            
            // Jugador 3 (si existe)
            if (approval['Nombre completo del jugador 3'] && approval['Nombre completo del jugador 3'].trim() !== '') {
                const jugador3 = {
                    nombre: approval['Nombre completo del jugador 3'] || 'No especificado',
                    fechaNacimiento: approval['Fecha de nacimiento jugador 3'] || 'No especificada',
                    cedula: approval['N√∫mero identificaci√≥n jugador 2'] || 'No especificada', // Nota: parece que hay un error en el formulario original
                    tallaUniforme: approval['Talla de uniforme jugador 3'] || 'No especificada'
                };
                
                jugadoresInfo += `
                    <div class="player-card">
                        <h4>‚öΩ Jugador 3</h4>
                        <div class="detail-item">
                            <span class="detail-label">Nombre:</span>
                            <span class="detail-value">${jugador3.nombre}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Fecha de Nacimiento:</span>
                            <span class="detail-value">${jugador3.fechaNacimiento}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">C√©dula:</span>
                            <span class="detail-value">${jugador3.cedula}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Talla de Uniforme:</span>
                            <span class="detail-value">${jugador3.tallaUniforme}</span>
                        </div>
                    </div>
                `;
            }
            
            const content = `
                <div class="approval-details">
                    <div class="detail-section">
                        <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informaci√≥n del Tutor/Padre</h3>
                        <div class="detail-item">
                            <span class="detail-label">Nombre Completo:</span>
                            <span class="detail-value">${approval['Nombre completo del padre/tutor'] || 'No especificado'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">${approval['Direcci√≥n de correo electr√≥nico'] || 'No especificado'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Tel√©fono:</span>
                            <span class="detail-value">${approval['Tel√©fono de contacto'] || 'No especificado'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Direcci√≥n:</span>
                            <span class="detail-value">${approval['Direcci√≥n completa'] || 'No especificada'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>üí∞ Informaci√≥n de Pago</h3>
                        <div class="detail-item">
                            <span class="detail-label">M√©todo de Pago:</span>
                            <span class="detail-value">${approval['M√©todo de pago'] || 'No especificado'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Fecha de Pago:</span>
                            <span class="detail-value">${approval['Fecha de pago'] || 'No especificada'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Comprobante:</span>
                            <span class="detail-value">${approval['Comprobante de pago'] || 'No especificado'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>üìã Informaci√≥n de la Solicitud</h3>
                        <div class="detail-item">
                            <span class="detail-label">ID de Solicitud:</span>
                            <span class="detail-value">${approval.ID}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Fecha de Solicitud:</span>
                            <span class="detail-value">${new Date(approval['Marca temporal'] || approval['Fecha de Solicitud'] || approval['Fecha Aplicaci√≥n']).toLocaleString()}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Fuente:</span>
                            <span class="detail-value">${approval['Fuente'] || 'Admisi√≥n'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Estado:</span>
                            <span class="detail-value status-badge status-${approval.Estado.toLowerCase()}">${approval.Estado}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>‚öΩ Jugadores Registrados</h3>
                        ${jugadoresInfo}
                    </div>
                    
                    <div class="detail-section">
                        <h3>üìé Archivos Adjuntos</h3>
                        <div class="files-section">
                            ${getFilesHtml(approval)}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('approvalModal').style.display = 'block';
        }

        // Funci√≥n auxiliar para mostrar archivos
        function getFilesHtml(approval) {
            let filesHtml = '<div class="files-grid">';
            
            // Procesar archivos adjuntos
            try {
                const files = JSON.parse(approval['Archivos Adjuntos'] || '[]');
                if (files && files.length > 0) {
                    files.forEach((file, index) => {
                        // Manejar tanto objetos como strings
                        let fileUrl = '';
                        let fileName = '';
                        
                        if (typeof file === 'object' && file.url) {
                            fileUrl = file.url;
                            fileName = file.name || `Documento ${index + 1}`;
                        } else if (typeof file === 'string') {
                            fileUrl = file;
                            fileName = `Documento ${index + 1}`;
                        }
                        
                        // Limpiar URL si es necesario
                        if (fileUrl && fileUrl.includes('drive.google.com')) {
                            filesHtml += `
                                <div class="file-item">
                                    <a href="${fileUrl}" target="_blank" class="file-link">
                                        üìÑ ${fileName}
                                    </a>
                                </div>
                            `;
                        }
                    });
                } else {
                    filesHtml += '<p style="color: #7f8c8d;">No hay archivos adjuntos</p>';
                }
            } catch (e) {
                console.error('Error procesando archivos:', e);
                filesHtml += '<p style="color: #7f8c8d;">Error al procesar archivos</p>';
            }
            
            filesHtml += '</div>';
            return filesHtml;
        }

        // Aprobar jugador
        function approvePlayer(approvalId) {
            if (confirm('¬øEst√° seguro de aprobar este jugador?')) {
                try {
                    showLoading('‚öΩ Procesando aprobaci√≥n...');
                    
                    google.script.run
                        .withSuccessHandler(function() {
                            hideLoading();
                            showSuccess('Jugador aprobado exitosamente');
                            closeApprovalModal();
                            loadApprovals();
                        })
                        .withFailureHandler(function(error) {
                            hideLoading();
                            showError('Error aprobando jugador: ' + error.toString());
                        })
                        .approvePlayerComplete(approvalId, false);
                } catch (error) {
                    hideLoading();
                    showError('Error aprobando jugador: ' + error.message);
                }
            }
        }

        // Aprobar como becado
        function approveAsScholarship(approvalId) {
            if (confirm('¬øEst√° seguro de aprobar este jugador como becado?')) {
                try {
                    showLoading('‚öΩ Procesando aprobaci√≥n como becado...');
                    
                    google.script.run
                        .withSuccessHandler(function() {
                            hideLoading();
                            showSuccess('Jugador aprobado como becado exitosamente');
                            closeApprovalModal();
                            loadApprovals();
                        })
                        .withFailureHandler(function(error) {
                            hideLoading();
                            showError('Error aprobando jugador: ' + error.toString());
                        })
                        .approvePlayerComplete(approvalId, true);
                } catch (error) {
                    hideLoading();
                    showError('Error aprobando jugador como becado: ' + error.message);
                }
            }
        }

        // Rechazar jugador
        function rejectPlayer(approvalId) {
            currentApprovalId = approvalId;
            document.getElementById('rejectModal').style.display = 'block';
        }

        // Procesar rechazo
        function processRejection(event) {
            event.preventDefault();
            
            const reason = document.getElementById('rejectReason').value;
            
            if (!reason.trim()) {
                alert('Por favor, ingrese el motivo del rechazo');
                return;
            }

            try {
                showLoading('‚öΩ Procesando rechazo...');
                
                google.script.run
                    .withSuccessHandler(function() {
                        hideLoading();
                        showSuccess('Jugador rechazado exitosamente');
                        closeRejectModal();
                        closeApprovalModal();
                        loadApprovals();
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError(error);
                    })
                    .rejectPlayerComplete(currentApprovalId, reason);
            } catch (error) {
                hideLoading();
                showError('Error rechazando jugador: ' + error.message);
            }
        }

        // Acciones masivas - DESACTIVADAS PARA USUARIOS FINALES
        /*
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.approval-checkbox:not([disabled])');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function getSelectedApprovals() {
            const checkboxes = document.querySelectorAll('.approval-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function bulkApprove() {
            const selectedIds = getSelectedApprovals();
            if (selectedIds.length === 0) {
                alert('Por favor, seleccione al menos una aprobaci√≥n');
                return;
            }

            if (confirm(`¬øEst√° seguro de aprobar ${selectedIds.length} jugador(es)?`)) {
                processBulkAction(selectedIds, 'approve');
            }
        }

        function bulkApproveAsScholarship() {
            const selectedIds = getSelectedApprovals();
            if (selectedIds.length === 0) {
                alert('Por favor, seleccione al menos una aprobaci√≥n');
                return;
            }

            if (confirm(`¬øEst√° seguro de aprobar ${selectedIds.length} jugador(es) como becados?`)) {
                processBulkAction(selectedIds, 'scholarship');
            }
        }

        function bulkReject() {
            const selectedIds = getSelectedApprovals();
            if (selectedIds.length === 0) {
                alert('Por favor, seleccione al menos una aprobaci√≥n');
                return;
            }

            const reason = prompt('Motivo del rechazo masivo:');
            if (!reason || !reason.trim()) {
                alert('Debe ingresar un motivo para el rechazo');
                return;
            }

            if (confirm(`¬øEst√° seguro de rechazar ${selectedIds.length} jugador(es)?`)) {
                processBulkAction(selectedIds, 'reject', reason);
            }
        }

        function processBulkAction(ids, action, reason = '') {
            let completed = 0;
            let errors = 0;

            ids.forEach(id => {
                try {
                    let promise;
                    switch (action) {
                        case 'approve':
                            promise = google.script.run.approvePlayer(id, 'normal');
                            break;
                        case 'scholarship':
                            promise = google.script.run.approvePlayer(id, 'scholarship');
                            break;
                        case 'reject':
                            promise = google.script.run.rejectPlayer(id, reason);
                            break;
                    }

                    promise
                        .withSuccessHandler(() => {
                            completed++;
                            if (completed + errors === ids.length) {
                                showSuccess(`${completed} aprobaciones procesadas exitosamente`);
                                loadApprovals();
                            }
                        })
                        .withFailureHandler(() => {
                            errors++;
                            if (completed + errors === ids.length) {
                                if (errors > 0) {
                                    showError(`${errors} aprobaciones fallaron al procesarse`);
                                }
                                loadApprovals();
                            }
                        });
                } catch (error) {
                    errors++;
                }
            });
        }
        */

        // Cerrar modales
        function closeApprovalModal() {
            document.getElementById('approvalModal').style.display = 'none';
        }

        function closeRejectModal() {
            document.getElementById('rejectModal').style.display = 'none';
            document.getElementById('rejectForm').reset();
        }

        // Actualizar aprobaciones
        function refreshApprovals() {
            loadApprovals();
        }

        // Utilidades
        // Copiar enlace al portapapeles y abrir en nueva ventana
        function copyToClipboardAndOpen(url, tipoDoc, nombreJugador) {
            try {
                // Copiar al portapapeles
                navigator.clipboard.writeText(url).then(function() {
                    console.log('‚úÖ Enlace copiado al portapapeles:', url);
                    
                    // Mostrar notificaci√≥n de √©xito
                    showToast('‚úÖ Enlace copiado: ' + tipoDoc + ' de ' + nombreJugador, 'success');
                    
                    // Intentar abrir en nueva ventana
                    const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
                    
                    if (!newWindow) {
                        // Si el popup fue bloqueado, mostrar instrucciones
                        setTimeout(function() {
                            showToast('üí° Pega el enlace copiado (Ctrl+V) en una nueva pesta√±a', 'info', 5000);
                        }, 1000);
                    }
                }).catch(function(err) {
                    console.error('Error copiando:', err);
                    // Fallback: mostrar el enlace
                    prompt('Copia este enlace manualmente:', url);
                });
            } catch (error) {
                console.error('Error:', error);
                // Fallback: abrir directamente
                window.open(url, '_blank');
            }
        }
        
        // Mostrar toast notification
        function showToast(message, type, duration) {
            duration = duration || 3000;
            
            const colors = {
                success: {bg: '#10b981', icon: '‚úÖ'},
                error: {bg: '#ef4444', icon: '‚ùå'},
                info: {bg: '#3b82f6', icon: 'üí°'},
                warning: {bg: '#f59e0b', icon: '‚ö†Ô∏è'}
            };
            
            const config = colors[type] || colors.info;
            
            const toast = document.createElement('div');
            toast.style.cssText = 
                'position: fixed; top: 20px; right: 20px; z-index: 10000; ' +
                'background: ' + config.bg + '; color: white; ' +
                'padding: 16px 24px; border-radius: 8px; ' +
                'box-shadow: 0 4px 12px rgba(0,0,0,0.15); ' +
                'font-weight: 600; font-size: 0.95em; ' +
                'animation: slideInRight 0.3s ease;';
            
            toast.textContent = config.icon + ' ' + message;
            document.body.appendChild(toast);
            
            setTimeout(function() {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(function() {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        
        function showError(message) {
            console.error('Error:', message);
            showToast(message, 'error');
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const approvalModal = document.getElementById('approvalModal');
            const rejectModal = document.getElementById('rejectModal');
            
            if (event.target === approvalModal) {
                closeApprovalModal();
            }
            if (event.target === rejectModal) {
                closeRejectModal();
            }
        }
    </script>
</body>
</html>

