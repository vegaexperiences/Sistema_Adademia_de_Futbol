<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUAREZ ACADEMY - Configuraciones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navegaci√≥n Superior */
        .top-navigation {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .nav-logo .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            font-size: 1.2em;
        }

        .nav-menu {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 100%;
        }

        .nav-item {
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            color: #2c3e50;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-size: 0.9em;
            white-space: nowrap;
            min-width: fit-content;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
        }

            .nav-item.active::before {
                content: 'üìç ';
            }

            .nav-item.close-btn {
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                border: 2px solid #ef4444;
            }

            .nav-item.close-btn:hover {
                background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            }

            .nav-item.auth-btn {
                background: linear-gradient(135deg, #f59e0b, #fbbf24);
                border-color: #d97706;
            }

            .nav-item.auth-btn:hover {
                background: linear-gradient(135deg, #d97706, #f59e0b);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            }

            /* Estilos para la secci√≥n de autorizaci√≥n */
            .authorization-section {
                margin: 20px 0;
                padding: 0 20px;
            }

            .auth-card {
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                border: 2px solid #f59e0b;
                border-radius: 15px;
                padding: 25px;
                display: flex;
                align-items: center;
                gap: 20px;
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
                animation: pulseWarning 2s infinite;
            }

            .auth-icon {
                font-size: 3em;
                animation: bounce 2s infinite;
            }

            .auth-content {
                flex: 1;
            }

            .auth-content h3 {
                color: #92400e;
                margin: 0 0 10px 0;
                font-size: 1.3em;
            }

            .auth-content p {
                color: #a16207;
                margin: 0 0 15px 0;
                line-height: 1.5;
            }

            .auth-btn {
                background: linear-gradient(135deg, #f59e0b, #d97706);
                border: none;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 1em;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            }

            .auth-btn:hover {
                background: linear-gradient(135deg, #d97706, #b45309);
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
            }

            @keyframes pulseWarning {
                0%, 100% { 
                    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
                }
                50% { 
                    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
                }
            }

            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% { 
                    transform: translateY(0); 
                }
                40% { 
                    transform: translateY(-10px); 
                }
                60% { 
                    transform: translateY(-5px); 
                }
            }

            /* Estilos para la secci√≥n de wipe */
            .wipe-section {
                margin: 20px 0;
                padding: 0 20px;
            }

            .wipe-card {
                background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
                border: 2px solid #ef4444;
                border-radius: 15px;
                padding: 25px;
                display: flex;
                align-items: center;
                gap: 20px;
                box-shadow: 0 8px 25px rgba(239, 68, 68, 0.2);
                animation: pulseDanger 2s infinite;
            }

            .wipe-icon {
                font-size: 3em;
                animation: shake 2s infinite;
            }

            .wipe-content {
                flex: 1;
            }

            .wipe-content h3 {
                color: #dc2626;
                margin: 0 0 10px 0;
                font-size: 1.3em;
            }

            .wipe-content p {
                color: #b91c1c;
                margin: 0 0 15px 0;
                line-height: 1.5;
            }

            .wipe-btn {
                background: linear-gradient(135deg, #ef4444, #dc2626);
                border: none;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 1em;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            }

            .wipe-btn:hover {
                background: linear-gradient(135deg, #dc2626, #b91c1c);
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
            }

            /* Estilos espec√≠ficos para wipe de jugadores */
            .wipe-card:nth-of-type(1) {
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                border: 2px solid #f59e0b;
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
                animation: pulseWarning 2s infinite;
            }

            .wipe-card:nth-of-type(1) .wipe-icon {
                animation: bounce 2s infinite;
            }

            .wipe-card:nth-of-type(1) .wipe-content h3 {
                color: #92400e;
            }

            .wipe-card:nth-of-type(1) .wipe-content p {
                color: #a16207;
            }

            .wipe-card:nth-of-type(1) .wipe-btn {
                background: linear-gradient(135deg, #f59e0b, #d97706);
                box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            }

            .wipe-card:nth-of-type(1) .wipe-btn:hover {
                background: linear-gradient(135deg, #d97706, #b45309);
                box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
            }

            /* Estilos espec√≠ficos para wipe de jugadores y gastos */
            .wipe-card:nth-of-type(2) {
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
                border: 2px solid #3b82f6;
                box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
                animation: pulseBlue 2s infinite;
            }

            .wipe-card:nth-of-type(2) .wipe-icon {
                animation: rotate 2s infinite;
            }

            .wipe-card:nth-of-type(2) .wipe-content h3 {
                color: #1e40af;
            }

            .wipe-card:nth-of-type(2) .wipe-content p {
                color: #1d4ed8;
            }

            .wipe-card:nth-of-type(2) .wipe-btn {
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            }

            .wipe-card:nth-of-type(2) .wipe-btn:hover {
                background: linear-gradient(135deg, #2563eb, #1d4ed8);
                box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            }

            @keyframes pulseDanger {
                0%, 100% { 
                    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.2);
                }
                50% { 
                    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
                }
            }

            @keyframes shake {
                0%, 100% { 
                    transform: translateX(0); 
                }
                10%, 30%, 50%, 70%, 90% { 
                    transform: translateX(-5px); 
                }
                20%, 40%, 60%, 80% { 
                    transform: translateX(5px); 
                }
            }

            @keyframes pulseBlue {
                0%, 100% { 
                    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
                }
                50% { 
                    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
                }
            }

            @keyframes rotate {
                0% { 
                    transform: rotate(0deg); 
                }
                100% { 
                    transform: rotate(360deg); 
                }
            }

            /* Responsive para men√∫ */
            @media (max-width: 1200px) {
                .nav-menu {
                    gap: 6px;
                }
                
                .nav-item {
                    padding: 5px 10px;
                    font-size: 0.85em;
                }
            }

            /* Responsive para autorizaci√≥n */
            @media (max-width: 768px) {
                .auth-card {
                    flex-direction: column;
                    text-align: center;
                    gap: 15px;
                }
                
                .auth-icon {
                    font-size: 2.5em;
                }
                
                .auth-content h3 {
                    font-size: 1.2em;
                }
                
                .auth-btn {
                    padding: 10px 20px;
                    font-size: 0.9em;
                }
                
                .wipe-card {
                    flex-direction: column;
                    text-align: center;
                    gap: 15px;
                }
                
                .wipe-icon {
                    font-size: 2.5em;
                }
                
                .wipe-content h3 {
                    font-size: 1.2em;
                }
                
                .wipe-btn {
                    padding: 10px 20px;
                    font-size: 0.9em;
                }
            }

            @media (max-width: 768px) {
                .nav-menu {
                    gap: 4px;
                    flex-wrap: wrap;
                }
                
                .nav-item {
                    padding: 4px 8px;
                    font-size: 0.8em;
                    border-radius: 4px;
                }
            }

            @media (max-width: 480px) {
                .nav-menu {
                    flex-direction: column;
                    gap: 4px;
                    align-items: center;
                }
                
                .nav-item {
                    width: 100%;
                    max-width: 200px;
                    text-align: center;
                    padding: 6px 12px;
                }
            }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #7f8c8d;
        }

        .tab.active {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .config-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #fbbf24;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .info-box {
            background: #e0f2fe;
            border-left: 4px solid #3b82f6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0c4a6e;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #92400e;
        }

        /* Modal de Autenticaci√≥n */
        .auth-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .auth-modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-modal-content h2 {
            color: #1e3a8a;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .auth-modal-content p {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1em;
        }

        .auth-modal-content input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .auth-modal-content input[type="password"]:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .auth-error {
            color: #ef4444;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .auth-modal-content .btn {
            width: 100%;
            justify-content: center;
            margin: 0;
        }

        .content-hidden {
            display: none !important;
        }

        .success-box {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #065f46;
        }

        .color-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-input-group input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .color-input-group input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }

        .logo-preview {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .logo-preview-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .logo-preview-circle {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .logo-preview-circle::before {
            content: '‚öΩ';
            font-size: 1.8em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .logo-preview-circle::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            z-index: -1;
        }

        .logo-preview-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .logo-preview-name {
            color: #1e3a8a;
            font-size: 2em;
            font-weight: bold;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .logo-preview-subtitle {
            color: #fbbf24;
            font-size: 1em;
            font-style: italic;
            font-weight: 600;
            margin-top: -3px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .logo-preview-year {
            color: #6b7280;
            font-size: 0.8em;
            margin-top: 3px;
        }

        .logo-upload-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .logo-upload-preview {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .logo-upload-preview h5 {
            color: #1e3a8a;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .error-box {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #991b1b;
        }

        .current-config {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .current-config h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .config-value {
            color: #2c3e50;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .formula-display {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }

    /* Global Loading Overlay - Bal√≥n de F√∫tbol */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }

    .loading-content {
        background: white;
        border-radius: 20px;
        padding: 40px 50px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        text-align: center;
    }

    .football-loader {
        font-size: 80px;
        animation: spin-football 1s linear infinite;
        display: inline-block;
    }

    @keyframes spin-football {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        margin-top: 20px;
        font-size: 1.3em;
        font-weight: bold;
        color: #1e3a8a;
    }
    </style>
</head>
<body>
    <!-- Modal de Autenticaci√≥n -->
    <div class="auth-modal" id="authModal">
        <div class="auth-modal-content">
            <div style="font-size: 3em; margin-bottom: 20px;">üîí</div>
            <h2>Acceso Restringido</h2>
            <p>Por favor, ingresa la contrase√±a para acceder a las configuraciones del sistema.</p>
            <div class="auth-error" id="authError">‚ùå Contrase√±a incorrecta. Intenta nuevamente.</div>
            <input type="password" id="authPassword" placeholder="Ingresa la contrase√±a" autocomplete="off" autofocus>
            <button class="btn btn-primary" onclick="checkPassword()">üîì Acceder</button>
        </div>
    </div>

    <!-- Global Loading Overlay -->
    <div class="loading-overlay" id="globalLoading">
        <div class="loading-content">
            <div class="football-loader">‚öΩ</div>
            <div class="loading-text">Cargando...</div>
        </div>
    </div>
    <div class="container content-hidden" id="mainContent">
        <!-- Navegaci√≥n Superior -->
        <nav class="top-navigation">
            <div class="nav-logo">
                <div class="logo-icon">‚öΩ</div>
                SUAREZ ACADEMY
            </div>
                    <div class="nav-menu">
                        <a href="#" class="nav-item" onclick="navigateTo('players')">üë• Jugadores</a>
                        <a href="#" class="nav-item" onclick="navigateTo('families')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familias</a>
                        <a href="#" class="nav-item" onclick="navigateTo('financial')">üí∞ Financiero</a>
                        <!-- <a href="#" class="nav-item" onclick="navigateTo('expenses')">üí∏ Gastos</a> -->
                        <a href="#" class="nav-item" onclick="navigateTo('approvals')">‚úÖ Aprobaciones</a>
                        <a href="#" class="nav-item" onclick="navigateTo('tournaments')">üèÜ Torneos</a>
                        <a href="#" class="nav-item" onclick="navigateTo('historic')">üìú Hist√≥rico</a>
                        <a href="#" class="nav-item active" onclick="navigateTo('config')">‚öôÔ∏è Config</a>
                        <a href="#" class="nav-item close-btn" onclick="closeWindow()">‚ùå Cerrar</a>
                    </div>
        </nav>

        <div class="header">
            <h1>‚öôÔ∏è SUAREZ ACADEMY - Configuraciones del Sistema</h1>
        </div>

        <!-- Bot√≥n de Autorizaci√≥n -->
        <div class="authorization-section">
            <div class="auth-card">
                <div class="auth-icon">üîê</div>
                <div class="auth-content">
                    <h3>Autorizaci√≥n del Sistema</h3>
                    <p>Para usar el sistema desde nuevas computadoras o cuentas, necesitas autorizar el acceso.</p>
                    <button class="btn btn-warning auth-btn" onclick="showAuthorizationHelper()">
                        üîê Solicitar Autorizaci√≥n
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n de Wipe de Solo Jugadores -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">üë•</div>
                <div class="wipe-content">
                    <h3>Wipe Solo de Jugadores</h3>
                    <p>‚ö†Ô∏è Esta operaci√≥n eliminar√° SOLO los jugadores (actuales, torneo y matr√≠cula). Se mantendr√°n transacciones, familias y gastos.</p>
                    <button class="btn btn-warning wipe-btn" onclick="executePlayersWipe()">
                        üë• Borrar Solo Jugadores
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n de Wipe Solo de Gastos -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">üí∞</div>
                <div class="wipe-content">
                    <h3>Wipe Solo de Gastos</h3>
                    <p>‚ö†Ô∏è Esta operaci√≥n eliminar√° SOLO todos los gastos. Se mantendr√°n jugadores, transacciones y grupos familiares.</p>
                    <button class="btn btn-warning wipe-btn" onclick="executeExpensesWipe()">
                        üí∞ Borrar Solo Gastos
                    </button>
                    <button class="btn btn-info wipe-btn" onclick="diagnoseExpenseSheets()" style="margin-left: 10px;">
                        üîç Diagnosticar Gastos
                    </button>
                    <button class="btn btn-secondary wipe-btn" onclick="testDeleteFunctionality()" style="margin-left: 10px;">
                        üß™ Probar Eliminaci√≥n
                    </button>
                    <button class="btn btn-warning wipe-btn" onclick="diagnoseGastosSheet()" style="margin-left: 10px;">
                        üîç Diagnosticar Hoja "Gastos"
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n de Debug para updatePlayer -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">üêõ</div>
                <div class="wipe-content">
                    <h3>Debug: Actualizaci√≥n de Jugadores</h3>
                    <p>üîç Esta herramienta verifica la estructura de la funci√≥n updatePlayer y las columnas de la hoja Jugadores.</p>
                    <button class="btn btn-info wipe-btn" onclick="debugUpdatePlayer()">
                        üêõ Debug updatePlayer
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n para agregar matr√≠culas a todos los jugadores -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">üí∞</div>
                <div class="wipe-content">
                    <h3>Agregar Matr√≠culas a Todos los Jugadores</h3>
                    <p>üéØ Esta herramienta agrega el pago de matr√≠cula ($80 USD por defecto) a todos los jugadores actuales que a√∫n no lo tengan registrado. Ideal para activar las gr√°ficas con datos iniciales.</p>
                    <button class="btn btn-success wipe-btn" onclick="addMissingEnrollments()">
                        üí∞ Agregar Matr√≠culas
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n de diagn√≥stico financiero -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">üîç</div>
                <div class="wipe-content">
                    <h3>Diagn√≥stico Financiero</h3>
                    <p>üîç Esta herramienta verifica el estado de las hojas financieras y muestra los datos disponibles.</p>
                    <button class="btn btn-info wipe-btn" onclick="diagnosticoFinanciero()">
                        üîç Diagnosticar Sistema Financiero
                    </button>
                    <button class="btn btn-warning wipe-btn" onclick="corregirEstadosMatriculas()" style="margin-left: 10px;">
                        üîß Corregir Estados de Matr√≠culas
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n para limpiar FORM_MATRICULA duplicados -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">üßπ</div>
                <div class="wipe-content">
                    <h3>Limpiar FORM_MATRICULA</h3>
                    <p>üßπ Esta herramienta elimina jugadores que ya est√°n aprobados (en hoja Jugadores) de FORM_MATRICULA.</p>
                    <button class="btn btn-warning wipe-btn" onclick="limpiarFormMatriculaDuplicados()">
                        üßπ Limpiar FORM_MATRICULA
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n para limpiar aprobaciones duplicadas -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">üßπ</div>
                <div class="wipe-content">
                    <h3>Limpiar Aprobaciones Duplicadas</h3>
                    <p>üßπ Esta herramienta elimina jugadores de la lista de Aprobaciones que ya est√°n en la hoja de Jugadores activos.</p>
                    <button class="btn btn-warning wipe-btn" onclick="limpiarAprobacionesDuplicadas()">
                        üßπ Limpiar Duplicados
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n para reparar estructura de Jugadores -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">üîß</div>
                <div class="wipe-content">
                    <h3>Reparar Estructura de Jugadores</h3>
                    <p>üî® Esta herramienta elimina columnas duplicadas, agrega columnas faltantes y reorganiza la hoja de Jugadores en el orden correcto.</p>
                    <button class="btn btn-warning wipe-btn" onclick="repararEstructuraJugadores()">
                        üî® Reparar Estructura
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n de Wipe Solo de Transacciones -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">üìä</div>
                <div class="wipe-content">
                    <h3>Wipe Solo de Transacciones</h3>
                    <p>‚ö†Ô∏è Esta operaci√≥n eliminar√° SOLO las transacciones y pagos (donde est√°n los c√°lculos financieros). Se mantendr√°n jugadores, familias y gastos.</p>
                    <button class="btn btn-warning wipe-btn" onclick="executeTransactionsWipe()">
                        üìä Borrar Solo Transacciones
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n de Wipe de Datos Financieros -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">üí≥</div>
                <div class="wipe-content">
                    <h3>Wipe Datos Financieros</h3>
                    <p>‚ö†Ô∏è Esta operaci√≥n eliminar√° TODOS los datos financieros (transacciones, gastos, c√°lculos). Se mantendr√°n jugadores y grupos familiares.</p>
                    <button class="btn btn-warning wipe-btn" onclick="executeFinancialWipe()">
                        üí≥ Borrar Datos Financieros
                    </button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n de Wipe del Sistema -->
        <div class="wipe-section">
            <div class="wipe-card">
                <div class="wipe-icon">‚ö†Ô∏è</div>
                <div class="wipe-content">
                    <h3>Wipe Completo del Sistema</h3>
                    <p>‚ö†Ô∏è ADVERTENCIA: Esta operaci√≥n eliminar√° TODOS los datos del sistema excepto FORM_MATRICULA.</p>
                    <button class="btn btn-danger wipe-btn" onclick="executeSystemWipe()">
                        üóëÔ∏è Ejecutar Wipe Completo
                    </button>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('financial')">üí∞ Financiero</div>
            <!-- <div class="tab" onclick="switchTab('forms')">üìù Formularios</div> -->
            <div class="tab" onclick="switchTab('logo')">üé® Logo</div>
            <div class="tab" onclick="switchTab('system')">üîß Sistema</div>
            <div class="tab" onclick="switchTab('manual')">üìö Manual</div>
        </div>

        <!-- Tab: Configuraci√≥n Financiera -->
        <div id="financial" class="tab-content active">
            <div class="config-section">
                <h3>üí∞ Configuraci√≥n Financiera</h3>
                
                <div class="info-box">
                    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Configure los precios base del sistema. Estos valores se aplicar√°n autom√°ticamente a todos los jugadores nuevos.
                </div>

                <div class="current-config">
                    <h4>Configuraci√≥n Actual</h4>
                    <div id="currentFinancialConfig">
                        <div class="loading">Cargando configuraci√≥n actual...</div>
                    </div>
                </div>

                <form id="financialConfigForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="monthlyFee">Mensualidad Individual ($)</label>
                            <input type="number" id="monthlyFee" step="0.01" min="0" required>
                            <small>Precio mensual para el primer jugador de una familia</small>
                        </div>
                        <div class="form-group">
                            <label for="enrollmentFee">Matr√≠cula ($)</label>
                            <input type="number" id="enrollmentFee" step="0.01" min="0" required>
                            <small>Precio de inscripci√≥n inicial</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="familyMonthlyFee">Mensualidad Familiar ($)</label>
                        <input type="number" id="familyMonthlyFee" step="0.01" min="0" required>
                        <small>Precio mensual para el segundo jugador en adelante de la misma familia</small>
                    </div>

                    <div class="form-group">
                        <label for="currency">Moneda</label>
                        <select id="currency">
                            <option value="USD">USD - D√≥lar Americano</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="COP">COP - Peso Colombiano</option>
                            <option value="MXN">MXN - Peso Mexicano</option>
                        </select>
                    </div>

                    <div class="formula-display">
                        <strong>F√≥rmula de C√°lculo:</strong><br>
                        ‚Ä¢ Primer jugador: Mensualidad Individual<br>
                        ‚Ä¢ Segundo jugador en adelante: Mensualidad Familiar<br>
                        ‚Ä¢ Descuentos se aplican sobre el monto base
                    </div>

                    <button type="submit" class="btn btn-success">
                        üíæ Guardar Configuraci√≥n Financiera
                    </button>
                    <button type="button" onclick="ensureEnrollmentFeesUtility()" class="btn btn-warning" style="margin-left: 10px;">
                        üí≥ Marcar Matr√≠culas Pagadas
                    </button>
                    <button type="button" onclick="testConfigurationSystem()" class="btn btn-secondary" style="margin-left: 10px;">
                        üß™ Probar Sistema
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab: Configuraci√≥n de Formularios - DESACTIVADO PARA USUARIOS -->
        <!--
        <div id="forms" class="tab-content">
            <div class="config-section">
                <h3>üìù Configuraci√≥n de Formularios</h3>
                
                <div class="info-box">
                    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Configure los IDs de los formularios de Google Forms para que el sistema pueda procesar autom√°ticamente las solicitudes.
                </div>

                <div class="current-config">
                    <h4>Formularios Configurados</h4>
                    <div id="currentFormsConfig">
                        <div class="loading">Cargando configuraci√≥n de formularios...</div>
                    </div>
                </div>

                <form id="formsConfigForm">
                    <div class="form-group">
                        <label for="admissionFormId">ID del Formulario de Admisi√≥n</label>
                        <input type="text" id="admissionFormId" placeholder="1ABC123def456GHI789jkl">
                        <small>ID del formulario de Google Forms para admisi√≥n general de jugadores</small>
                    </div>

                    <div class="form-group">
                        <label for="tournamentFormId">ID del Formulario de Torneos</label>
                        <input type="text" id="tournamentFormId" placeholder="1XYZ789abc123DEF456ghi">
                        <small>ID del formulario de Google Forms para inscripci√≥n en torneos</small>
                    </div>

                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Importante:</strong> Los IDs de los formularios se encuentran en la URL del formulario. 
                        Ejemplo: https://docs.google.com/forms/d/<strong>1ABC123def456GHI789jkl</strong>/edit
                    </div>

                    <button type="submit" class="btn btn-success">
                        üíæ Guardar Configuraci√≥n de Formularios
                    </button>
                </form>
            </div>
        </div>
        -->

        <!-- Tab: Configuraci√≥n del Logo -->
        <div id="logo" class="tab-content">
            <div class="config-section">
                <h3>üé® Configuraci√≥n del Logo</h3>
                <p>Personaliza el logo y colores de la academia en todo el sistema.</p>
                
                <div class="form-group">
                    <label for="academyName">Nombre de la Academia:</label>
                    <input type="text" id="academyName" placeholder="SUAREZ" maxlength="20">
                </div>

                <div class="form-group">
                    <label for="academySubtitle">Subt√≠tulo:</label>
                    <input type="text" id="academySubtitle" placeholder="ACADEMY" maxlength="20">
                </div>

                <div class="form-group">
                    <label for="academyYear">A√±o de Fundaci√≥n:</label>
                    <input type="text" id="academyYear" placeholder="2018" maxlength="4">
                </div>

                <div class="form-group">
                    <label for="primaryColor">Color Primario:</label>
                    <div class="color-input-group">
                        <input type="color" id="primaryColor" value="#1e3a8a">
                        <input type="text" id="primaryColorText" placeholder="#1e3a8a" maxlength="7">
                    </div>
                </div>

                <div class="form-group">
                    <label for="secondaryColor">Color Secundario:</label>
                    <div class="color-input-group">
                        <input type="color" id="secondaryColor" value="#3b82f6">
                        <input type="text" id="secondaryColorText" placeholder="#3b82f6" maxlength="7">
                    </div>
                </div>

                <div class="form-group">
                    <label for="accentColor">Color de Acento:</label>
                    <div class="color-input-group">
                        <input type="color" id="accentColor" value="#fbbf24">
                        <input type="text" id="accentColorText" placeholder="#fbbf24" maxlength="7">
                    </div>
                </div>

                <div class="form-group">
                    <h4>üìÅ Logo Personalizado</h4>
                    <p>Sube tu propio logo para reemplazar el logo por defecto.</p>
                    
                    <div class="logo-upload-container">
                        <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                        <button class="btn btn-info" onclick="document.getElementById('logoUpload').click()">
                            üìÅ Seleccionar Logo
                        </button>
                        <button class="btn btn-warning" onclick="loadCustomLogo()">
                            üîÑ Cargar Logo Actual
                        </button>
                        <button class="btn btn-danger" onclick="deleteCustomLogo()">
                            üóëÔ∏è Eliminar Logo
                        </button>
                    </div>
                    
                    <div id="logoPreviewContainer" class="logo-upload-preview" style="display: none;">
                        <h5>Vista Previa del Logo Subido:</h5>
                        <img id="logoPreviewImage" src="" alt="Logo Preview" style="max-width: 200px; max-height: 200px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    </div>
                </div>

                <div class="form-group">
                    <h4>üëÅÔ∏è Vista Previa del Logo</h4>
                    <div id="logoPreview" class="logo-preview">
                        <div class="logo-preview-container">
                            <div class="logo-preview-circle"></div>
                            <div class="logo-preview-text">
                                <h1 class="logo-preview-name">SUAREZ</h1>
                                <div class="logo-preview-subtitle">ACADEMY</div>
                                <div class="logo-preview-year">2018</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn btn-primary" onclick="saveLogoConfig()">
                        üíæ Guardar Configuraci√≥n del Logo
                    </button>
                    <button class="btn btn-info" onclick="loadLogoConfig()">
                        üîÑ Cargar Configuraci√≥n Actual
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: Configuraci√≥n del Sistema -->
        <div id="system" class="tab-content">
            <div class="config-section">
                <h3>üîß Configuraci√≥n del Sistema</h3>
                
                <div class="info-box">
                    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Configuraciones generales del sistema y herramientas de mantenimiento.
                </div>

                <div class="form-group">
                    <h4>üîÑ Sincronizaci√≥n de Datos</h4>
                    <p>Sincroniza todos los datos del sistema y actualiza las m√©tricas.</p>
                    <button class="btn btn-info" onclick="syncAllData()">
                        üîÑ Sincronizar Datos
                    </button>
                </div>

                <div class="form-group">
                    <h4>üìä Generaci√≥n de Reportes</h4>
                    <p>Genera reportes completos del sistema.</p>
                    <button class="btn btn-primary" onclick="generateSystemReports()">
                        üìä Generar Reportes
                    </button>
                </div>

                <div class="form-group">
                    <h4>üèÜ Diagn√≥stico de Torneos</h4>
                    <p>Verifica el proceso de aprobaci√≥n de jugadores de torneos y el sistema de backup.</p>
                    <button class="btn btn-info" onclick="testTournamentApprovalSystem()">
                        üèÜ Diagnosticar Torneos
                    </button>
                </div>

                <div class="form-group">
                    <h4>üìä Diagn√≥stico de Contadores</h4>
                    <p>Diagnostica problemas con los contadores de "aprobado hoy" y "rechazado hoy".</p>
                    <button class="btn btn-warning" onclick="diagnoseTodayCounters()">
                        üìä Diagnosticar Contadores
                    </button>
                    
                    <div id="counterDiagnosticResults" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
                        <h5>Resultados del Diagn√≥stico de Contadores:</h5>
                        <pre id="counterDiagnosticResultsText" style="background: #f5f5f5; padding: 10px; border-radius: 5px; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></pre>
                    </div>
                </div>

                <div class="form-group">
                    <h4>üîç Diagn√≥stico de Jugadores de Torneo</h4>
                    <p>Diagnostica problemas espec√≠ficos con jugadores de torneo que no se eliminan de FORM_TORNEO.</p>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="diagnosticPlayerId">ID del Jugador a Diagnosticar:</label>
                        <input type="text" id="diagnosticPlayerId" placeholder="Ej: APR_1234567890_abcdef" 
                               style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-warning" onclick="diagnoseSpecificPlayer()">
                            üîç Diagnosticar Jugador
                        </button>
                        <button class="btn btn-danger" onclick="testDeleteSpecificPlayer()">
                            üóëÔ∏è Probar Eliminaci√≥n
                        </button>
                        <button class="btn btn-secondary" onclick="clearDiagnosticInput()">
                            üßπ Limpiar
                        </button>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-info" onclick="diagnoseAllTournamentPlayers()">
                            üîç Diagnosticar Todos los Jugadores de FORM_TORNEO
                        </button>
                        <button class="btn btn-secondary" onclick="testConnection()">
                            üîß Probar Conexi√≥n
                        </button>
                        <button class="btn btn-warning" onclick="checkFormTorneo()">
                            üîç Verificar FORM_TORNEO
                        </button>
                        <button class="btn btn-success" onclick="diagnoseFormTorneoSuperSimple()">
                            üîç Diagn√≥stico S√∫per Simple
                        </button>
                        <button class="btn btn-primary" onclick="getFormTorneoPlayers()">
                            üìã Obtener Jugadores de FORM_TORNEO
                        </button>
                        <button class="btn btn-info" onclick="getFormTorneoBasicInfo()">
                            üìä Informaci√≥n B√°sica de FORM_TORNEO
                        </button>
                        <button class="btn btn-warning" onclick="getFormTorneoDetailedInfo()">
                            üìã Informaci√≥n Detallada de FORM_TORNEO
                        </button>
                        <button class="btn btn-danger" onclick="checkFormTorneoPlayersInAprobaciones()">
                            üîç Verificar Jugadores en Aprobaciones
                        </button>
                        <button class="btn btn-primary" onclick="runUpdatePlayerCategories()">
                            üè∑Ô∏è Recalcular Categor√≠as de Jugadores
                        </button>
                        <button class="btn btn-secondary" onclick="diagnoseAprobacionesColumnQ()">
                            üîç Diagnosticar Columna Q de Aprobaciones
                        </button>
                    </div>
                    
                    <div id="diagnosticResults" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
                        <h5>Resultados del Diagn√≥stico:</h5>
                        <pre id="diagnosticResultsText" style="background: #f5f5f5; padding: 10px; border-radius: 5px; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></pre>
                    </div>
                </div>

                <div class="form-group">
                    <h4>üèÜ Limpieza de FORM_TORNEO</h4>
                    <p>Busca y elimina jugadores de torneo que ya fueron procesados pero a√∫n est√°n en FORM_TORNEO.</p>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-info" onclick="findOrphanedTournamentPlayers()">
                            üîç Buscar Jugadores Hu√©rfanos
                        </button>
                        <button class="btn btn-success" onclick="cleanupOrphanedPlayers()">
                            üßπ Limpiar Jugadores Hu√©rfanos
                        </button>
                    </div>
                    
                    <div id="cleanupResults" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
                        <h5>Resultados de la Limpieza:</h5>
                        <pre id="cleanupResultsText" style="background: #f5f5f5; padding: 10px; border-radius: 5px; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></pre>
                    </div>
                </div>

                <!-- ========================================
                     SECCIONES T√âCNICAS OCULTAS (NO BORRAR)
                     Para reactivar, descomentar el bloque siguiente
                     ======================================== -->
                
                <!--
                <div class="form-group">
                    <h4>üßπ Limpieza de Datos</h4>
                    <p>Limpia logs antiguos y datos temporales.</p>
                    <button class="btn btn-warning" onclick="cleanOldData()">
                        üßπ Limpiar Datos Antiguos
                    </button>
                </div>

                <div class="form-group">
                    <h4>üì§ Exportaci√≥n de Datos</h4>
                    <p>Exporta todos los datos del sistema en formato CSV.</p>
                    <button class="btn btn-success" onclick="exportAllData()">
                        üì§ Exportar Datos
                    </button>
                </div>

                <div class="form-group">
                    <h4>üîß Herramientas de Diagn√≥stico</h4>
                    <p>Prueba la conexi√≥n con Google Apps Script y verifica el estado del sistema.</p>
                    <button class="btn btn-info" onclick="testConnection()">
                        üîç Probar Conexi√≥n
                    </button>
                    <button class="btn btn-warning" onclick="runDiagnosis()">
                        üî¨ Diagn√≥stico del Sistema
                    </button>
                    <button class="btn btn-secondary" onclick="runFamilyGroupingByTutor()">
                        üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Agrupar Familias por Tutor
                    </button>
                </div>

                <div class="form-group">
                    <h4>üîß Sistema y Men√∫</h4>
                    <p>Herramientas para configurar el sistema y crear el men√∫ de acceso.</p>
                    
                    <button class="btn btn-primary" onclick="createMenu()">
                        üèÜ Crear Men√∫ del Sistema
                    </button>
                    <button class="btn btn-success" onclick="testMenuFunctions()">
                        üß™ Probar Funciones del Men√∫
                    </button>
                    <button class="btn btn-info" onclick="checkSystemStatus()">
                        üîç Verificar Estado del Sistema
                    </button>
                </div>

                <div class="form-group">
                    <h4>üìù Procesamiento de Formularios</h4>
                    <p>Procesa manualmente los datos del formulario de admisi√≥n que ya est√°n en el sistema.</p>
                    
                    <button class="btn btn-primary" onclick="processFormMatriculaData()">
                        üìã Procesar Datos de FORM_MATRICULA
                    </button>
                    <button class="btn btn-success" onclick="processFormMatriculaDataImproved()">
                        üöÄ Procesar Datos (Mejorado)
                    </button>
                    <button class="btn btn-primary" onclick="reprocessFormDataWithFiles()">
                        üìé Reprocesar Datos con Archivos Corregidos
                    </button>
                    <button class="btn btn-warning" onclick="diagnoseFileData()">
                        üîç Diagnosticar Datos de Archivos
                    </button>
                    <button class="btn btn-success" onclick="createTestData()">
                        üß™ Crear Datos de Prueba
                    </button>
                    <button class="btn btn-info" onclick="checkData()">
                        üîç Verificar Datos
                    </button>
                    <button class="btn btn-warning" onclick="getAllApprovalsData()">
                        üìä Obtener Todos los Datos
                    </button>
                    <button class="btn btn-info" onclick="diagnoseFormMatricula()">
                        üîç Diagnosticar FORM_MATRICULA
                    </button>
                    <button class="btn btn-secondary" onclick="diagnoseAllSheets()">
                        üìã Diagnosticar Todas las Hojas
                    </button>
                    <button class="btn btn-success" onclick="simpleDiagnostic()">
                        üîß Diagn√≥stico Simple
                    </button>
                    <button class="btn btn-primary" onclick="simpleCheckFormMatricula()">
                        üìã Verificar FORM_MATRICULA Simple
                    </button>
                    <button class="btn btn-warning" onclick="testPendingApprovals()">
                        ‚úÖ Probar Aprobaciones Pendientes
                    </button>
                </div>

                <div class="form-group">
                    <h4>üìé Diagn√≥stico de Archivos de C√©dulas</h4>
                    <p>Diagnostica y corrige problemas con archivos adjuntos de c√©dulas.</p>
                    
                    <button class="btn btn-info" onclick="diagnosticarHojaJugadores()">
                        üîç Ver Estructura de Hoja Jugadores
                    </button>
                    <button class="btn btn-warning" onclick="diagnosticarArchivosEnAprobaciones()">
                        üìã Ver Archivos en Aprobaciones
                    </button>
                    <button class="btn btn-success" onclick="agregarColumnasURLsCedulas()">
                        ‚ûï Agregar Columnas de URLs (si no existen)
                    </button>
                </div>

                <div class="form-group">
                    <h4>üí∞ Sistema Financiero</h4>
                    <p>Verifica y configura las hojas financieras del sistema.</p>
                    <button class="btn btn-success" onclick="ensureFinancialSheets()">
                        üí∞ Verificar Hojas Financieras
                    </button>
                    <button class="btn btn-primary" onclick="testMonthlyBilling()">
                        üí≥ Probar Cobro Mensual
                    </button>
                    <button class="btn btn-info" onclick="showMonthlyFeeInfo()">
                        ‚ÑπÔ∏è Ver Informaci√≥n de Mensualidades
                    </button>
                </div>
                -->

                <div class="form-group">
                    <h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Limpieza de Familias</h4>
                    <p>Herramientas para analizar y limpiar asignaciones incorrectas de Familia ID en jugadores.</p>
                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Importante:</strong> Siempre crear un backup antes de ejecutar la limpieza.
                    </div>
                    <button class="btn btn-success" onclick="createPlayersBackup()">
                        üíæ Crear Backup Completo de Jugadores
                    </button>
                    <button class="btn btn-info" onclick="analyzeFamilyAssignmentsUI()">
                        üîç Analizar Asignaciones de Familias
                    </button>
                    <button class="btn btn-warning" onclick="cleanFamilyAssignmentsUI()">
                        üßπ Limpiar Familias ID
                    </button>
                </div>

                <div class="form-group">
                    <h4>üí∞ Actualizaci√≥n de Cuotas</h4>
                    <p>Actualiza las cuotas mensuales ya emitidas (Pendientes) con los montos correctos basados en la nueva l√≥gica de familias.</p>
                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Importante:</strong> La primera herramienta corrige TODAS las mensualidades hist√≥ricas (Pendientes y Pagadas) con montos incorrectos, incluyendo pagos ya realizados. Esto afectar√° las m√©tricas contables. La segunda herramienta actualizar√° los montos de las cuotas pendientes. Solo afecta pagos con Estado='Pendiente'.
                    </div>
                    <button class="btn btn-danger" onclick="updateAllHistoricalMonthlyPaymentsUI()">
                        üìú Actualizar Hist√≥ricos Transaccionales
                    </button>
                    <button class="btn btn-warning" onclick="updateExistingMonthlyPaymentsUI()" style="margin-left: 10px;">
                        üí∞ Actualizar Cuotas Emitidas
                    </button>
                </div>

                <div class="form-group">
                    <h4>üìÖ Control de Generaci√≥n de Mensualidades</h4>
                    <p>Configura la fecha de inicio para la generaci√≥n autom√°tica de mensualidades y elimina mensualidades existentes.</p>
                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Importante:</strong> La generaci√≥n autom√°tica de mensualidades estar√° pausada hasta la fecha configurada. La eliminaci√≥n de mensualidades afectar√° TANTO pagos pendientes como pagados.
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                            üìÜ Fecha de Inicio de Generaci√≥n:
                        </label>
                        <input type="date" id="monthlyFeeGenerationStartDate" style="padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 14px; width: 250px; margin-right: 10px;" />
                        <button class="btn btn-primary" onclick="setMonthlyFeeGenerationStartDate()">
                            üíæ Guardar Fecha de Inicio
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="deleteAllMonthlyPaymentsUI()">
                            üóëÔ∏è Eliminar Todas las Mensualidades
                        </button>
                    </div>
                </div>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Advertencia:</strong> Algunas operaciones pueden tomar tiempo dependiendo de la cantidad de datos.
                </div>
            </div>

            <div class="config-section">
                <h3>üìà Estad√≠sticas del Sistema</h3>
                
                <div id="systemStats">
                    <div class="loading">Cargando estad√≠sticas...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Manual de Usuario -->
        <div id="manual" class="tab-content">
            <div class="config-section">
                <h3>üìö Manual de Usuario - SUAREZ ACADEMY</h3>
                
                <div class="success-box" style="text-align: center; padding: 40px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">üìñ</div>
                    <h2 style="color: #1e3a8a; margin-bottom: 15px;">Bienvenido al Manual de Usuario</h2>
                    <p style="font-size: 1.1em; color: #6b7280; margin-bottom: 30px;">
                        Aprende a usar todas las funcionalidades del sistema de gesti√≥n de la academia.
                    </p>
                    
                    <button class="btn btn-primary" onclick="openFullManual()" style="font-size: 1.2em; padding: 20px 40px;">
                        üìö Abrir Manual Completo
                    </button>
                </div>

                <div style="margin-top: 40px;">
                    <h4 style="color: #1e3a8a; margin-bottom: 20px; font-size: 1.3em;">üîó Accesos R√°pidos a Temas</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <!-- Card: Gesti√≥n de Jugadores -->
                        <div style="background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); padding: 25px; border-radius: 12px; border-left: 5px solid #8b5cf6; cursor: pointer; transition: transform 0.3s ease; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);" onclick="openFullManual()" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">üë•</div>
                            <h3 style="color: #6b21a8; margin-bottom: 10px;">Gesti√≥n de Jugadores</h3>
                            <p style="color: #7c3aed; font-size: 0.95em;">Agregar, editar, retirar y reactivar</p>
                        </div>

                        <!-- Card: Grupos Familiares -->
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 25px; border-radius: 12px; border-left: 5px solid #f59e0b; cursor: pointer; transition: transform 0.3s ease; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);" onclick="openFullManual()" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                            <h3 style="color: #92400e; margin-bottom: 10px;">Grupos Familiares</h3>
                            <p style="color: #d97706; font-size: 0.95em;">Tarifas familiares y pagos grupales</p>
                        </div>

                        <!-- Card: Pagos -->
                        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 25px; border-radius: 12px; border-left: 5px solid #10b981; cursor: pointer; transition: transform 0.3s ease; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);" onclick="openFullManual()" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">üí≥</div>
                            <h3 style="color: #065f46; margin-bottom: 10px;">Gesti√≥n de Pagos</h3>
                            <p style="color: #059669; font-size: 0.95em;">Registrar pagos y cobros extras</p>
                        </div>

                        <!-- Card: Gastos -->
                        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 25px; border-radius: 12px; border-left: 5px solid #ef4444; cursor: pointer; transition: transform 0.3s ease; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);" onclick="openFullManual()" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">üí∏</div>
                            <h3 style="color: #991b1b; margin-bottom: 10px;">Gastos de la Academia</h3>
                            <p style="color: #dc2626; font-size: 0.95em;">Registrar egresos y gastos recurrentes</p>
                        </div>

                        <!-- Card: Aprobaciones -->
                        <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 25px; border-radius: 12px; border-left: 5px solid #ec4899; cursor: pointer; transition: transform 0.3s ease; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);" onclick="openFullManual()" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">‚úÖ</div>
                            <h3 style="color: #9f1239; margin-bottom: 10px;">Aprobaciones</h3>
                            <p style="color: #db2777; font-size: 0.95em;">Aprobar o rechazar inscripciones</p>
                        </div>

                        <!-- Card: Reportes -->
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 25px; border-radius: 12px; border-left: 5px solid #3b82f6; cursor: pointer; transition: transform 0.3s ease; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);" onclick="openFullManual()" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">üìä</div>
                            <h3 style="color: #1e3a8a; margin-bottom: 10px;">Reportes</h3>
                            <p style="color: #1e40af; font-size: 0.95em;">Estad√≠sticas y exportaci√≥n</p>
                        </div>

                        <!-- Card: Casos Pr√°cticos -->
                        <div style="background: linear-gradient(135deg, #cffafe 0%, #a5f3fc 100%); padding: 25px; border-radius: 12px; border-left: 5px solid #06b6d4; cursor: pointer; transition: transform 0.3s ease; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);" onclick="openFullManual()" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">üìñ</div>
                            <h3 style="color: #164e63; margin-bottom: 10px;">Casos Pr√°cticos</h3>
                            <p style="color: #0891b2; font-size: 0.95em;">Ejemplos paso a paso</p>
                        </div>

                        <!-- Card: Tips -->
                        <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 25px; border-radius: 12px; border-left: 5px solid #6366f1; cursor: pointer; transition: transform 0.3s ease; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);" onclick="openFullManual()" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">üí°</div>
                            <h3 style="color: #3730a3; margin-bottom: 10px;">Tips R√°pidos</h3>
                            <p style="color: #4f46e5; font-size: 0.95em;">Tareas diarias y mensuales</p>
                        </div>
                    </div>
                </div>

                <div class="info-box" style="margin-top: 30px;">
                    <h4>üí° Contenido del Manual</h4>
                    <p>Gu√≠a pr√°ctica simplificada que cubre:</p>
                    <ul style="margin-top: 10px; margin-left: 20px;">
                        <li>üë• <strong>Gesti√≥n de Jugadores:</strong> Agregar, editar, retirar y reactivar</li>
                        <li>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ <strong>Familias:</strong> Tarifas familiares y pagos grupales</li>
                        <li>üí≥ <strong>Pagos:</strong> Registrar pagos, cobros extras, mensualidades</li>
                        <li>üí∏ <strong>Gastos:</strong> Registrar egresos y gastos recurrentes</li>
                        <li>‚úÖ <strong>Aprobaciones:</strong> Procesar solicitudes de admisi√≥n</li>
                        <li>üìä <strong>Reportes:</strong> Ver estad√≠sticas y exportar datos</li>
                        <li>üìñ <strong>Casos Pr√°cticos:</strong> Ejemplos reales paso a paso</li>
                        <li>‚ùì <strong>FAQ:</strong> Respuestas a preguntas comunes</li>
                    </ul>
                </div>

                <div class="success-box" style="margin-top: 20px;">
                    <strong>üìå Manual Simplificado:</strong> Solo incluye procesos del d√≠a a d√≠a. Enfocado en tareas de jugadores y finanzas, sin detalles t√©cnicos.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n de navegaci√≥n directa - abre nueva ventana directamente
        function navigateTo(section) {
            try {
                // Si ya estamos en la secci√≥n, no hacer nada
                if (section === 'config') {
                    return;
                }
                
                console.log('Navegando a:', section);
                
                // Abrir nueva ventana directamente
                switch(section) {
                    case 'dashboard':
                        google.script.run.showMainDashboard();
                        break;
                    case 'players':
                        google.script.run.showPlayersManager();
                        break;
                    case 'families':
                        google.script.run.showFamilyGroupsManager();
                        break;
                    case 'financial':
                        google.script.run.showFinancialManager();
                        break;
                    case 'approvals':
                        google.script.run.showApprovalsManager();
                        break;
                    case 'historic':
                        google.script.run.showHistoricPlayersManager();
                        break;
                }
            } catch (error) {
                console.error('Error navegando:', error);
            }
        }

        // Funci√≥n para cerrar ventana
        function closeWindow() {
            try {
                google.script.host.close();
            } catch (error) {
                console.error('Error cerrando ventana:', error);
            }
        }

        // Funci√≥n para mostrar helper de autorizaci√≥n
        function showAuthorizationHelper() {
            try {
                google.script.run.showAuthorizationHelper();
            } catch (error) {
                console.error('Error mostrando helper de autorizaci√≥n:', error);
                alert('Error: No se pudo abrir el helper de autorizaci√≥n. Intenta recargar la p√°gina.');
            }
        }

        // Funci√≥n para probar la eliminaci√≥n
        function testDeleteFunctionality() {
            try {
                console.log('üß™ Probando funcionalidad de eliminaci√≥n...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('‚úÖ Prueba de eliminaci√≥n completada');
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error en prueba de eliminaci√≥n:', error);
                        alert('‚ùå Error ejecutando prueba de eliminaci√≥n:\n\n' + error.toString());
                    })
                    .testDeleteFunctionality();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para diagnosticar la hoja "Gastos" espec√≠ficamente
        function diagnoseGastosSheet() {
            try {
                console.log('üîç Diagnosticando hoja "Gastos" espec√≠ficamente...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('‚úÖ Diagn√≥stico de hoja "Gastos" completado');
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error en diagn√≥stico de hoja "Gastos":', error);
                        alert('‚ùå Error ejecutando diagn√≥stico de hoja "Gastos":\n\n' + error.toString());
                    })
                    .diagnoseGastosSheet();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para debug de updatePlayer
        function debugUpdatePlayer() {
            try {
                console.log('üêõ Ejecutando debug de updatePlayer...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('‚úÖ Debug completado:', result);
                        alert('‚úÖ Debug completado\n\nRevisa la consola para ver los detalles.');
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error en debug:', error);
                        alert('‚ùå Error ejecutando debug:\n\n' + error.toString());
                    })
                    .debugUpdatePlayer();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n de diagn√≥stico financiero
        function diagnosticoFinanciero() {
            try {
                console.log('üîç Ejecutando diagn√≥stico financiero...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('‚úÖ Diagn√≥stico completado');
                        alert('‚úÖ Diagn√≥stico completado\n\nRevisa los logs de Apps Script para ver los detalles.');
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error en diagn√≥stico:', error);
                        alert('‚ùå Error ejecutando diagn√≥stico:\n\n' + error.toString());
                    })
                    .diagnosticoFinanciero();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para limpiar FORM_MATRICULA duplicados
        function limpiarFormMatriculaDuplicados() {
            try {
                const confirmAction = confirm(
                    'üßπ LIMPIAR FORM_MATRICULA\n\n' +
                    'Esta herramienta:\n' +
                    '‚Ä¢ Comparar√° jugadores activos con FORM_MATRICULA\n' +
                    '‚Ä¢ Eliminar√° jugadores que ya est√°n aprobados\n' +
                    '‚Ä¢ Usar√° la c√©dula para identificar jugadores\n' +
                    '‚Ä¢ SOLO eliminar√° de FORM_MATRICULA\n\n' +
                    '¬øContinuar?'
                );
                
                if (!confirmAction) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                console.log('üßπ Limpiando FORM_MATRICULA...');
                showLoading('üßπ Limpiando FORM_MATRICULA...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (result && result.success) {
                            let message = '‚úÖ Limpieza Completada\n\n' + result.message;
                            if (result.players && result.players.length > 0) {
                                message += '\n\nJugadores eliminados:\n';
                                message += result.players.slice(0, 10).join('\n');
                                if (result.players.length > 10) {
                                    message += `\n... y ${result.players.length - 10} m√°s`;
                                }
                            }
                            alert(message);
                            console.log('‚úÖ Limpieza completada:', result);
                        } else {
                            alert('‚ùå Error: ' + (result ? result.message : 'Desconocido'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('‚ùå Error limpiando FORM_MATRICULA:', error);
                        alert('‚ùå Error limpiando FORM_MATRICULA:\n\n' + error.toString());
                    })
                    .limpiarFormMatriculaDuplicados();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para limpiar aprobaciones duplicadas
        function limpiarAprobacionesDuplicadas() {
            try {
                const confirmAction = confirm(
                    'üßπ LIMPIAR APROBACIONES DUPLICADAS\n\n' +
                    'Esta herramienta:\n' +
                    '‚Ä¢ Comparar√° la lista de Jugadores activos con Aprobaciones\n' +
                    '‚Ä¢ Eliminar√° jugadores que ya est√°n aprobados\n' +
                    '‚Ä¢ SOLO eliminar√° de Aprobaciones, NO afecta a Jugadores\n\n' +
                    '¬øContinuar?'
                );
                
                if (!confirmAction) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                console.log('üßπ Limpiando aprobaciones duplicadas...');
                showLoading('üßπ Limpiando aprobaciones...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (result && result.success) {
                            alert('‚úÖ Limpieza Completada\n\n' + result.message);
                            console.log('‚úÖ Limpieza completada:', result);
                        } else {
                            alert('‚ùå Error: ' + (result ? result.message : 'Desconocido'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('‚ùå Error limpiando aprobaciones:', error);
                        alert('‚ùå Error limpiando aprobaciones:\n\n' + error.toString());
                    })
                    .limpiarAprobacionesDuplicadas();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para reparar estructura de Jugadores
        function repararEstructuraJugadores() {
            try {
                const confirmAction = confirm(
                    'üî® REPARAR ESTRUCTURA DE JUGADORES\n\n' +
                    'Esta herramienta:\n' +
                    '‚Ä¢ Eliminar√° columnas duplicadas\n' +
                    '‚Ä¢ Agregar√° columnas faltantes\n' +
                    '‚Ä¢ Reorganizar√° en el orden correcto\n\n' +
                    'Tus jugadores se mantendr√°n intactos.\n\n' +
                    '¬øContinuar?'
                );
                
                if (!confirmAction) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                console.log('üîß Reparando estructura de jugadores...');
                showLoading('üîß Reparando estructura...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (result && result.success) {
                            alert('‚úÖ Estructura Reparada\n\n' + result.message);
                            console.log('‚úÖ Estructura reparada:', result);
                        } else {
                            alert('‚ùå Error: ' + (result ? result.message : 'Desconocido'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('‚ùå Error reparando estructura:', error);
                        alert('‚ùå Error reparando estructura:\n\n' + error.toString());
                    })
                    .repararEstructuraJugadores();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para corregir estados de matr√≠culas
        function corregirEstadosMatriculas() {
            try {
                const confirmAction = confirm(
                    'üîß CORREGIR ESTADOS DE MATR√çCULAS\n\n' +
                    'Esta herramienta cambiar√° todos los estados de "Pendiente" a "Pagado" para las matr√≠culas.\n\n' +
                    '¬øContinuar?'
                );
                
                if (!confirmAction) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                console.log('üîß Corrigiendo estados de matr√≠culas...');
                showLoading('üîß Corrigiendo estados...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (result && result.success) {
                            alert('‚úÖ Estados Corregidos\n\n' + result.message);
                            console.log('‚úÖ Estados corregidos:', result);
                        } else {
                            alert('‚ùå Error: ' + (result ? result.message : 'Desconocido'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('‚ùå Error corrigiendo estados:', error);
                        alert('‚ùå Error corrigiendo estados:\n\n' + error.toString());
                    })
                    .corregirEstadosMatriculas();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para agregar matr√≠culas a todos los jugadores
        function addMissingEnrollments() {
            try {
                const confirmAction = confirm(
                    'üí∞ AGREGAR MATR√çCULAS A JUGADORES\n\n' +
                    'Esta herramienta agregar√° el pago de matr√≠cula ($80 USD por defecto) a todos los jugadores actuales que a√∫n no lo tengan registrado.\n\n' +
                    '¬øContinuar?'
                );
                
                if (!confirmAction) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                console.log('üí∞ Agregando matr√≠culas a jugadores...');
                showLoading('üí∞ Agregando matr√≠culas...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (result && result.success) {
                            alert('‚úÖ Matr√≠culas Agregadas\n\n' + result.message);
                            console.log('‚úÖ Matr√≠culas agregadas:', result);
                        } else {
                            alert('‚ùå Error: ' + (result ? result.message : 'Desconocido'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('‚ùå Error agregando matr√≠culas:', error);
                        alert('‚ùå Error agregando matr√≠culas:\n\n' + error.toString());
                    })
                    .addMissingEnrollments();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para diagnosticar hojas de gastos
        function diagnoseExpenseSheets() {
            try {
                console.log('üîç Diagnosticando hojas de gastos...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('‚úÖ Diagn√≥stico completado');
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error en diagn√≥stico:', error);
                        alert('‚ùå Error ejecutando diagn√≥stico:\n\n' + error.toString());
                    })
                    .diagnoseExpenseSheets();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para ejecutar wipe solo de transacciones
        function executeTransactionsWipe() {
            try {
                // Confirmar antes de proceder
                const confirmWipe = confirm(
                    '‚ö†Ô∏è WIPE DE TRANSACCIONES ‚ö†Ô∏è\n\n' +
                    'Esta operaci√≥n eliminar√° SOLO las transacciones:\n' +
                    '‚Ä¢ Todas las transacciones (hoja Transacciones)\n' +
                    '‚Ä¢ Todos los c√°lculos financieros\n\n' +
                    'Se mantendr√°n:\n' +
                    '‚Ä¢ Jugadores actuales\n' +
                    '‚Ä¢ Jugadores de torneo (FORM_TORNEO)\n' +
                    '‚Ä¢ Jugadores de matr√≠cula (FORM_MATRICULA)\n' +
                    '‚Ä¢ Aprobaciones de jugadores\n' +
                    '‚Ä¢ Hist√≥rico de jugadores\n' +
                    '‚Ä¢ Grupos familiares\n' +
                    '‚Ä¢ Hojas de gastos\n\n' +
                    '¬øContinuar?'
                );
                
                if (!confirmWipe) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                console.log('üìä Ejecutando wipe de transacciones...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result) {
                            alert('‚úÖ WIPE DE TRANSACCIONES COMPLETADO\n\nSe han eliminado todas las transacciones del sistema. Se mantuvieron jugadores, familias y gastos.');
                            console.log('‚úÖ Wipe de transacciones completado exitosamente');
                        } else {
                            alert('‚ùå Error: El wipe de transacciones no se complet√≥ correctamente');
                            console.log('‚ùå Error en el wipe de transacciones');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error ejecutando wipe de transacciones:', error);
                        alert('‚ùå Error ejecutando el wipe de transacciones:\n\n' + error.toString());
                    })
                    .wipeTransactionsOnly();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para ejecutar wipe de datos financieros
        function executeFinancialWipe() {
            try {
                // Confirmar antes de proceder
                const confirmWipe = confirm(
                    '‚ö†Ô∏è WIPE DE DATOS FINANCIEROS ‚ö†Ô∏è\n\n' +
                    'Esta operaci√≥n eliminar√° TODOS los datos financieros:\n' +
                    '‚Ä¢ Todas las transacciones\n' +
                    '‚Ä¢ Todos los gastos\n' +
                    '‚Ä¢ Todos los c√°lculos financieros\n\n' +
                    'Se mantendr√°n:\n' +
                    '‚Ä¢ Jugadores actuales\n' +
                    '‚Ä¢ Jugadores de torneo (FORM_TORNEO)\n' +
                    '‚Ä¢ Jugadores de matr√≠cula (FORM_MATRICULA)\n' +
                    '‚Ä¢ Aprobaciones de jugadores\n' +
                    '‚Ä¢ Hist√≥rico de jugadores\n' +
                    '‚Ä¢ Grupos familiares\n\n' +
                    '¬øContinuar?'
                );
                
                if (!confirmWipe) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                console.log('üí≥ Ejecutando wipe de datos financieros...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result) {
                            alert('‚úÖ WIPE DE DATOS FINANCIEROS COMPLETADO\n\nSe han eliminado todos los datos financieros del sistema. Se mantuvieron jugadores y grupos familiares.');
                            console.log('‚úÖ Wipe de datos financieros completado exitosamente');
                        } else {
                            alert('‚ùå Error: El wipe de datos financieros no se complet√≥ correctamente');
                            console.log('‚ùå Error en el wipe de datos financieros');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error ejecutando wipe de datos financieros:', error);
                        alert('‚ùå Error ejecutando el wipe de datos financieros:\n\n' + error.toString());
                    })
                    .wipeFinancialData();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para ejecutar wipe solo de gastos
        function executeExpensesWipe() {
            try {
                // Confirmar antes de proceder
                const confirmWipe = confirm(
                    '‚ö†Ô∏è WIPE SOLO DE GASTOS ‚ö†Ô∏è\n\n' +
                    'Esta operaci√≥n eliminar√° SOLO los gastos del sistema:\n' +
                    '‚Ä¢ TODOS LOS GASTOS\n\n' +
                    'Se mantendr√°n:\n' +
                    '‚Ä¢ Jugadores actuales\n' +
                    '‚Ä¢ Jugadores de torneo (FORM_TORNEO)\n' +
                    '‚Ä¢ Jugadores de matr√≠cula (FORM_MATRICULA)\n' +
                    '‚Ä¢ Aprobaciones de jugadores\n' +
                    '‚Ä¢ Hist√≥rico de jugadores\n' +
                    '‚Ä¢ Transacciones financieras\n' +
                    '‚Ä¢ Grupos familiares\n\n' +
                    '¬øContinuar?'
                );
                
                if (!confirmWipe) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                console.log('üí∞ Ejecutando wipe solo de gastos...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result) {
                            alert('‚úÖ WIPE DE GASTOS COMPLETADO\n\nSe han eliminado todos los gastos del sistema. Se mantuvieron jugadores, transacciones y grupos familiares.');
                            console.log('‚úÖ Wipe de gastos completado exitosamente');
                        } else {
                            alert('‚ùå Error: El wipe de gastos no se complet√≥ correctamente');
                            console.log('‚ùå Error en el wipe de gastos');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error ejecutando wipe de gastos:', error);
                        alert('‚ùå Error ejecutando el wipe de gastos:\n\n' + error.toString());
                    })
                    .wipeOnlyExpenses();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para ejecutar wipe solo de jugadores
        function executePlayersWipe() {
            try {
                // Confirmar antes de proceder
                const confirmWipe = confirm(
                    '‚ö†Ô∏è WIPE DE SOLO JUGADORES ‚ö†Ô∏è\n\n' +
                    'Esta operaci√≥n eliminar√° SOLO los jugadores:\n' +
                    '‚Ä¢ Jugadores actuales (hoja Jugadores)\n' +
                    '‚Ä¢ Jugadores de torneo (FORM_TORNEO)\n' +
                    '‚Ä¢ Jugadores de matr√≠cula (FORM_MATRICULA)\n' +
                    '‚Ä¢ Aprobaciones de jugadores\n' +
                    '‚Ä¢ Hist√≥rico de jugadores\n\n' +
                    'Se mantendr√°n:\n' +
                    '‚Ä¢ Transacciones financieras\n' +
                    '‚Ä¢ Grupos familiares\n' +
                    '‚Ä¢ Gastos\n\n' +
                    '¬øContinuar?'
                );
                
                if (!confirmWipe) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                console.log('üë• Ejecutando wipe de solo jugadores...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result) {
                            alert('‚úÖ WIPE DE JUGADORES COMPLETADO\n\nSe han eliminado todos los jugadores del sistema. Se mantuvieron las transacciones, familias y gastos.');
                            console.log('‚úÖ Wipe de jugadores completado exitosamente');
                        } else {
                            alert('‚ùå Error: El wipe de jugadores no se complet√≥ correctamente');
                            console.log('‚ùå Error en el wipe de jugadores');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error ejecutando wipe de jugadores:', error);
                        alert('‚ùå Error ejecutando el wipe de jugadores:\n\n' + error.toString());
                    })
                    .wipeOnlyPlayers();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para ejecutar wipe completo del sistema
        function executeSystemWipe() {
            try {
                // Confirmar antes de proceder
                const confirmWipe = confirm(
                    '‚ö†Ô∏è ADVERTENCIA CR√çTICA ‚ö†Ô∏è\n\n' +
                    'Esta operaci√≥n eliminar√° TODOS los datos del sistema:\n' +
                    '‚Ä¢ Todos los jugadores\n' +
                    '‚Ä¢ Todas las transacciones\n' +
                    '‚Ä¢ Todos los grupos familiares\n' +
                    '‚Ä¢ Todos los gastos\n' +
                    '‚Ä¢ Todas las aprobaciones\n' +
                    '‚Ä¢ Todo el hist√≥rico\n' +
                    '‚Ä¢ Todos los torneos\n\n' +
                    'SOLO se mantendr√° FORM_MATRICULA.\n\n' +
                    '¬øEst√°s ABSOLUTAMENTE seguro de que quieres continuar?'
                );
                
                if (!confirmWipe) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                // Segunda confirmaci√≥n
                const finalConfirm = confirm(
                    '‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN ‚ö†Ô∏è\n\n' +
                    'Esta acci√≥n es IRREVERSIBLE.\n' +
                    'Todos los datos ser√°n eliminados permanentemente.\n\n' +
                    '¬øConfirmas que quieres proceder con el wipe completo?'
                );
                
                if (!finalConfirm) {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                console.log('üö® Ejecutando wipe completo del sistema...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result) {
                            alert('‚úÖ WIPE COMPLETADO\n\nEl sistema ha sido limpiado completamente. Solo se mantuvieron los datos de FORM_MATRICULA.');
                            console.log('‚úÖ Wipe completado exitosamente');
                        } else {
                            alert('‚ùå Error: El wipe no se complet√≥ correctamente');
                            console.log('‚ùå Error en el wipe');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error ejecutando wipe:', error);
                        alert('‚ùå Error ejecutando el wipe:\n\n' + error.toString());
                    })
                    .manualSystemWipe();
                    
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Funci√≥n para abrir el manual completo
        function openFullManual() {
            try {
                console.log('Abriendo manual completo...');
                google.script.run.showUserManual();
            } catch (error) {
                console.error('Error abriendo manual:', error);
                alert('Error abriendo el manual: ' + error.toString());
            }
        }

        // Funci√≥n para abrir el manual en una secci√≥n espec√≠fica
        function openManualSection(section) {
            try {
                console.log('Abriendo manual en secci√≥n:', section);
                // Abrir el manual completo primero
                google.script.run.showUserManual();
                // El manual tiene su propio sistema de navegaci√≥n interna
            } catch (error) {
                console.error('Error abriendo secci√≥n del manual:', error);
                alert('Error: ' + error.toString());
            }
        }

        // Hacer las funciones globales para que est√©n disponibles en todas las ventanas
        window.navigateTo = navigateTo;
        window.closeWindow = closeWindow;
        window.openFullManual = openFullManual;
        window.openManualSection = openManualSection;
        window.checkPassword = checkPassword;

        // Contrase√±a de acceso
        const CONFIG_PASSWORD = 'BD310523';

        // Funci√≥n para verificar contrase√±a
        function checkPassword() {
            const passwordInput = document.getElementById('authPassword');
            const errorDiv = document.getElementById('authError');
            const password = passwordInput.value.trim();

            if (password === CONFIG_PASSWORD) {
                // Contrase√±a correcta - ocultar modal y mostrar contenido
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('mainContent').classList.remove('content-hidden');
                // Limpiar el campo de contrase√±a por seguridad
                passwordInput.value = '';
                // Cargar configuraciones despu√©s de autenticar
                loadCurrentConfigurations();
                setupEventListeners();
            } else {
                // Contrase√±a incorrecta - mostrar error
                errorDiv.classList.add('show');
                passwordInput.value = '';
                passwordInput.focus();
                // Agregar animaci√≥n de error
                passwordInput.style.borderColor = '#ef4444';
                setTimeout(() => {
                    passwordInput.style.borderColor = '#e0e0e0';
                }, 2000);
            }
        }

        // Permitir acceso con Enter
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('authPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
                // Enfocar el campo autom√°ticamente
                passwordInput.focus();
            }
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Formulario de configuraci√≥n financiera
            const financialForm = document.getElementById('financialConfigForm');
            if (financialForm) {
                financialForm.addEventListener('submit', saveFinancialConfig);
            }
            
            // Formulario de configuraci√≥n de formularios - DESACTIVADO
            // const formsForm = document.getElementById('formsConfigForm');
            // if (formsForm) {
            //     formsForm.addEventListener('submit', saveFormsConfig);
            // }
            
            // Botones de sistema
            const syncBtn = document.querySelector('button[onclick="syncAllData()"]');
            if (syncBtn) {
                syncBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    syncAllData();
                });
            }
            
            const reportsBtn = document.querySelector('button[onclick="generateSystemReports()"]');
            if (reportsBtn) {
                reportsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    generateSystemReports();
                });
            }
            
            const cleanBtn = document.querySelector('button[onclick="cleanOldData()"]');
            if (cleanBtn) {
                cleanBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    cleanOldData();
                });
            }
            
            const exportBtn = document.querySelector('button[onclick="exportAllData()"]');
            if (exportBtn) {
                exportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    exportAllData();
                });
            }
            
            const testBtn = document.querySelector('button[onclick="testConnection()"]');
            if (testBtn) {
                testBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    testConnection();
                });
            }
            
            const diagnosisBtn = document.querySelector('button[onclick="runDiagnosis()"]');
            if (diagnosisBtn) {
                diagnosisBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    runDiagnosis();
                });
            }
            
            const processBtn = document.querySelector('button[onclick="processFormData()"]');
            if (processBtn && !processBtn.hasAttribute('data-listener-added')) {
                processBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    processFormData();
                });
                processBtn.setAttribute('data-listener-added', 'true');
            }
            
            const processDirectBtn = document.querySelector('button[onclick="processFormDataDirectly()"]');
            if (processDirectBtn && !processDirectBtn.hasAttribute('data-listener-added')) {
                processDirectBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    processFormDataDirectly();
                });
                processDirectBtn.setAttribute('data-listener-added', 'true');
            }
            
            const createTestBtn = document.querySelector('button[onclick="createTestData()"]');
            if (createTestBtn) {
                createTestBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    createTestData();
                });
            }

            const ensureTestBtn = document.querySelector('button[onclick="ensureTestData()"]');
            if (ensureTestBtn) {
                ensureTestBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    ensureTestData();
                });
            }

            const checkDataBtn = document.querySelector('button[onclick="checkApprovalsData()"]');
            if (checkDataBtn) {
                checkDataBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    checkApprovalsData();
                });
            }

            const forceCreateBtn = document.querySelector('button[onclick="forceCreateAndReadTestData()"]');
            if (forceCreateBtn) {
                forceCreateBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    forceCreateAndReadTestData();
                });
            }

            const testSimpleBtn = document.querySelector('button[onclick="testSimpleData()"]');
            if (testSimpleBtn) {
                testSimpleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    testSimpleData();
                });
            }

            const processAllBtn = document.querySelector('button[onclick="processAllFormMatriculaData()"]');
            if (processAllBtn) {
                processAllBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    processAllFormMatriculaData();
                });
            }

            const processBatchesBtn = document.querySelector('button[onclick="processFormMatriculaDataInBatches()"]');
            if (processBatchesBtn) {
                processBatchesBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    processFormMatriculaDataInBatches();
                });
            }

            const testAllApprovalsBtn = document.querySelector('button[onclick="testGetAllApprovals()"]');
            if (testAllApprovalsBtn) {
                testAllApprovalsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    testGetAllApprovals();
                });
            }

            const cleanEmptyBtn = document.querySelector('button[onclick="cleanEmptyRecords()"]');
            if (cleanEmptyBtn && !cleanEmptyBtn.hasAttribute('data-listener-added')) {
                cleanEmptyBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    cleanEmptyRecords();
                });
                cleanEmptyBtn.setAttribute('data-listener-added', 'true');
            }
            
            // Event listeners para configuraci√≥n del logo
            const logoInputs = ['academyName', 'academySubtitle', 'academyYear', 'primaryColor', 'secondaryColor', 'accentColor'];
            logoInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', updateLogoPreview);
                }
            });

            // Sincronizar inputs de color
            const colorInputs = ['primaryColor', 'secondaryColor', 'accentColor'];
            colorInputs.forEach(colorId => {
                const colorInput = document.getElementById(colorId);
                const textInput = document.getElementById(colorId + 'Text');
                
                if (colorInput && textInput) {
                    colorInput.addEventListener('input', function() {
                        textInput.value = this.value;
                        updateLogoPreview();
                    });
                    
                    textInput.addEventListener('input', function() {
                        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
                            colorInput.value = this.value;
                            updateLogoPreview();
                        }
                    });
                }
            });

            // Event listeners para botones del logo
            const saveLogoBtn = document.querySelector('button[onclick="saveLogoConfig()"]');
            if (saveLogoBtn) {
                saveLogoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveLogoConfig();
                });
            }
            
            const loadLogoBtn = document.querySelector('button[onclick="loadLogoConfig()"]');
            if (loadLogoBtn) {
                loadLogoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadLogoConfig();
                });
            }

            // Event listener para subida de logo
            const logoUploadInput = document.getElementById('logoUpload');
            if (logoUploadInput) {
                logoUploadInput.addEventListener('change', handleLogoUpload);
            }
        }

        // Cambiar tab
        function switchTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover clase active de todos los tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(tabName).classList.add('active');
            
            // Activar tab en la navegaci√≥n
            event.target.classList.add('active');
            
            // Cargar datos espec√≠ficos del tab
            if (tabName === 'system') {
                loadSystemStats();
            }
        }

        // Cargar configuraciones actuales
        function loadCurrentConfigurations() {
            loadFinancialConfig();
            loadMonthlyFeeGenerationStartDate(); // Cargar fecha de inicio de generaci√≥n de mensualidades
            // loadFormsConfig(); // DESACTIVADO - Funcionalidad de formularios oculta para usuarios
        }

        // Cargar configuraci√≥n financiera
        function loadFinancialConfig() {
            try {
                google.script.run
                    .withSuccessHandler(updateFinancialConfigDisplay)
                    .withFailureHandler(showError)
                    .getFinancialConfig();
            } catch (error) {
                showError('Error cargando configuraci√≥n financiera: ' + error.message);
            }
        }

        // Actualizar display de configuraci√≥n financiera
        function updateFinancialConfigDisplay(config) {
            if (config) {
                // Llenar formulario
                document.getElementById('monthlyFee').value = config.MONTHLY_FEE || 130;
                document.getElementById('enrollmentFee').value = config.ENROLLMENT_FEE || 130;
                document.getElementById('familyMonthlyFee').value = config.FAMILY_MONTHLY_FEE || 110.50;
                document.getElementById('currency').value = config.CURRENCY || 'USD';

                const currencyCode = config.CURRENCY || 'USD';

                // Mostrar configuraci√≥n actual
                const currentConfigDiv = document.getElementById('currentFinancialConfig');
                currentConfigDiv.innerHTML = `
                    <div class="config-item">
                        <span class="config-label">Mensualidad Individual:</span>
                        <span class="config-value">${formatCurrency(config.MONTHLY_FEE || 130, currencyCode)}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Matr√≠cula:</span>
                        <span class="config-value">${formatCurrency(config.ENROLLMENT_FEE || 130, currencyCode)}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Mensualidad Familiar:</span>
                        <span class="config-value">${formatCurrency(config.FAMILY_MONTHLY_FEE || 110.50, currencyCode)}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Moneda:</span>
                        <span class="config-value">${config.CURRENCY || 'USD'}</span>
                    </div>
                `;
            }
        }

        // Cargar configuraci√≥n de formularios - DESACTIVADO PARA USUARIOS
        /*
        function loadFormsConfig() {
            try {
                google.script.run
                    .withSuccessHandler(updateFormsConfigDisplay)
                    .withFailureHandler(showError)
                    .getFormsConfig();
            } catch (error) {
                showError('Error cargando configuraci√≥n de formularios: ' + error.message);
            }
        }
        */

        // Actualizar display de configuraci√≥n de formularios - DESACTIVADO PARA USUARIOS
        /*
        function updateFormsConfigDisplay(config) {
            if (config) {
                // Llenar formulario
                document.getElementById('admissionFormId').value = config.ADMISSION_FORM_ID || '';
                document.getElementById('tournamentFormId').value = config.TOURNAMENT_FORM_ID || '';

                // Mostrar configuraci√≥n actual
                const currentConfigDiv = document.getElementById('currentFormsConfig');
                currentConfigDiv.innerHTML = `
                    <div class="config-item">
                        <span class="config-label">Formulario de Admisi√≥n:</span>
                        <span class="config-value">${config.ADMISSION_FORM_ID || 'No configurado'}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Formulario de Torneos:</span>
                        <span class="config-value">${config.TOURNAMENT_FORM_ID || 'No configurado'}</span>
                    </div>
                `;
            }
        }
        */

        // Guardar configuraci√≥n financiera
        function saveFinancialConfig(event) {
            event.preventDefault();
            
            const config = {
                monthlyFee: parseFloat(document.getElementById('monthlyFee').value),
                enrollmentFee: parseFloat(document.getElementById('enrollmentFee').value),
                familyMonthlyFee: parseFloat(document.getElementById('familyMonthlyFee').value),
                currency: document.getElementById('currency').value
            };

            // Validaci√≥n b√°sica
            if (config.monthlyFee < 0 || config.enrollmentFee < 0 || config.familyMonthlyFee < 0) {
                showError('Los valores no pueden ser negativos');
                return;
            }

            if (config.familyMonthlyFee >= config.monthlyFee) {
                showError('La mensualidad familiar debe ser menor que la mensualidad individual');
                return;
            }

            try {
                google.script.run
                    .withSuccessHandler(function() {
                        showSuccess('Configuraci√≥n financiera guardada exitosamente');
                        loadFinancialConfig();
                    })
                    .withFailureHandler(function(error) {
                        showError('Error guardando configuraci√≥n financiera: ' + error.toString());
                    })
                    .updateFinancialConfig(config);
            } catch (error) {
                showError('Error guardando configuraci√≥n financiera: ' + error.message);
            }
        }

        function ensureEnrollmentFeesUtility() {
            try {
                const feeInput = document.getElementById('enrollmentFee');
                if (!feeInput) {
                    showError('No se encontr√≥ el campo de matr√≠cula en la configuraci√≥n.');
                    return;
                }

                const currencySelect = document.getElementById('currency');
                const currencyCode = currencySelect ? currencySelect.value : 'USD';

                const feeValue = parseFloat(feeInput.value);
                if (isNaN(feeValue) || feeValue < 0) {
                    showError('Ingresa un valor v√°lido para la matr√≠cula.');
                    return;
                }

                const confirmationMessage =
                    'Esta utilidad registrar√° como pagada la matr√≠cula para todos los jugadores activos\n' +
                    'que a√∫n no tengan un cargo de matr√≠cula. Se utilizar√° el monto:\n\n' +
                    `   ${formatCurrency(feeValue, currencyCode)}\n\n` +
                    '¬øDeseas continuar?';

                if (!confirm(confirmationMessage)) {
                    return;
                }

                showLoading('Registrando matr√≠culas pagadas...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();

                        if (result && result.success) {
                            const appliedFee = result.enrollmentFee !== undefined ? result.enrollmentFee : feeValue;
                            const formattedFee = formatCurrency(appliedFee, currencyCode);
                            const created = result.created || 0;
                            const already = result.alreadyRegistered || 0;
                            const scholarships = result.skippedScholarships || 0;
                            const inactive = result.skippedInactive || 0;
                            const invalid = result.invalidPlayers || 0;

                            let message = 'Matr√≠culas actualizadas correctamente.\n\n';
                            message += `üí∞ Monto utilizado: ${formattedFee}\n`;
                            message += `üÜï Nuevas matr√≠culas registradas: ${created}\n`;
                            message += `üì¶ Ya contaban con matr√≠cula: ${already}\n`;
                            message += `üéì Becados omitidos: ${scholarships}\n`;
                            message += `‚è∏Ô∏è Jugadores inactivos omitidos: ${inactive}\n`;
                            if (invalid > 0) {
                                message += `‚ö†Ô∏è Filas inv√°lidas omitidas: ${invalid}\n`;
                            }

                            if (result.sample && result.sample.length) {
                                message += '\nEjemplos procesados:\n';
                                result.sample.forEach(function(item) {
                                    const playerLabel = item.nombre ? `${item.nombre} (${item.playerId})` : item.playerId;
                                    message += `‚Ä¢ ${playerLabel}\n`;
                                });
                                if (created > result.sample.length) {
                                    message += `‚Ä¢ ... y ${created - result.sample.length} m√°s\n`;
                                }
                            }

                            showSuccess(message);
                        } else {
                            const errorMessage = result && result.message ? result.message : 'No se pudo completar la utilidad de matr√≠culas.';
                            showError(errorMessage);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError('Error asegurando matr√≠culas: ' + error.toString());
                    })
                    .ensureEnrollmentFeesForApprovedPlayers(feeValue);
            } catch (error) {
                hideLoading();
                showError('Error asegurando matr√≠culas: ' + error.message);
            }
        }

        // Guardar configuraci√≥n de formularios - DESACTIVADO PARA USUARIOS
        /*
        function saveFormsConfig(event) {
            event.preventDefault();
            
            const admissionFormId = document.getElementById('admissionFormId').value.trim();
            const tournamentFormId = document.getElementById('tournamentFormId').value.trim();

            // Validaci√≥n b√°sica de IDs de formularios
            if (admissionFormId && admissionFormId.length !== 44) {
                showError('El ID del formulario de admisi√≥n debe tener 44 caracteres');
                return;
            }

            if (tournamentFormId && tournamentFormId.length !== 44) {
                showError('El ID del formulario de torneos debe tener 44 caracteres');
                return;
            }

            try {
                google.script.run
                    .withSuccessHandler(function() {
                        showSuccess('Configuraci√≥n de formularios guardada exitosamente');
                        loadFormsConfig();
                    })
                    .withFailureHandler(function(error) {
                        showError('Error guardando configuraci√≥n de formularios: ' + error.toString());
                    })
                    .updateFormsConfig(admissionFormId, tournamentFormId);
            } catch (error) {
                showError('Error guardando configuraci√≥n de formularios: ' + error.message);
            }
        }
        */

        // Cargar estad√≠sticas del sistema
        function loadSystemStats() {
            try {
                google.script.run
                    .withSuccessHandler(updateSystemStats)
                    .withFailureHandler(showError)
                    .getSystemStatistics();
            } catch (error) {
                showError('Error cargando estad√≠sticas: ' + error.message);
            }
        }

        // Actualizar estad√≠sticas del sistema
        function updateSystemStats(stats) {
            if (stats) {
                const statsDiv = document.getElementById('systemStats');
                statsDiv.innerHTML = `
                    <div class="config-item">
                        <span class="config-label">Total de Jugadores:</span>
                        <span class="config-value">${stats.totalPlayers}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Jugadores Activos:</span>
                        <span class="config-value">${stats.activePlayers}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Jugadores Becados:</span>
                        <span class="config-value">${stats.scholarshipPlayers}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Total de Familias:</span>
                        <span class="config-value">${stats.totalFamilies}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Pagos del Mes:</span>
                        <span class="config-value">${stats.monthlyPayments}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Ingresos del Mes:</span>
                        <span class="config-value">${formatCurrency(stats.monthlyIncome)}</span>
                    </div>
                `;
            }
        }

        // Funciones de sistema
        function syncAllData() {
            if (confirm('¬øEst√° seguro de sincronizar todos los datos del sistema?')) {
                try {
                    google.script.run
                        .withSuccessHandler(function() {
                            showSuccess('Datos sincronizados exitosamente');
                        })
                        .withFailureHandler(function(error) {
                            showError('Error sincronizando datos: ' + error.toString());
                        })
                        .syncAllData();
                } catch (error) {
                    showError('Error sincronizando datos: ' + error.message);
                }
            }
        }

        function generateSystemReports() {
            if (confirm('¬øEst√° seguro de generar reportes del sistema?')) {
                try {
                    google.script.run
                        .withSuccessHandler(function() {
                            showSuccess('Reportes generados exitosamente');
                        })
                        .withFailureHandler(function(error) {
                            showError('Error generando reportes: ' + error.toString());
                        })
                        .generateSystemReports();
                } catch (error) {
                    showError('Error generando reportes: ' + error.message);
                }
            }
        }

        function cleanOldData() {
            if (confirm('¬øEst√° seguro de limpiar datos antiguos? Esta acci√≥n no se puede deshacer.')) {
                try {
                    google.script.run
                        .withSuccessHandler(function() {
                            showSuccess('Datos antiguos limpiados exitosamente');
                        })
                        .withFailureHandler(function(error) {
                            showError('Error limpiando datos: ' + error.toString());
                        })
                        .cleanOldLogs();
                } catch (error) {
                    showError('Error limpiando datos: ' + error.message);
                }
            }
        }

        function exportAllData() {
            if (confirm('¬øEst√° seguro de exportar todos los datos del sistema?')) {
                try {
                    google.script.run
                        .withSuccessHandler(function() {
                            showSuccess('Datos exportados exitosamente');
                        })
                        .withFailureHandler(function(error) {
                            showError('Error exportando datos: ' + error.toString());
                        })
                        .exportAllData();
                } catch (error) {
                    showError('Error exportando datos: ' + error.message);
                }
            }
        }

        // Utilidades
        function formatCurrency(amount, currencyCode) {
            const code = currencyCode || 'USD';
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: code
            }).format(amount || 0);
        }

        function showError(message) {
            console.error('Error:', message);
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            console.log('Success:', message);
            alert('√âxito: ' + message);
        }

        function showWarning(message) {
            console.warn('Warning:', message);
            alert('Advertencia: ' + message);
        }

        // Global Loading Functions
        function showLoading(message = 'Cargando...') {
            const loading = document.getElementById('globalLoading');
            const loadingText = loading.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = message;
            }
            loading.style.display = 'flex';
        }

        function hideLoading() {
            const loading = document.getElementById('globalLoading');
            loading.style.display = 'none';
        }

        // Funci√≥n para probar el sistema de configuraciones
        function testConfigurationSystem() {
            if (!confirm('¬øEst√° seguro de probar el sistema de configuraciones? Esto cambiar√° temporalmente los precios.')) {
                return;
            }
            
            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            let message = 'üß™ PRUEBA DEL SISTEMA COMPLETADA:\n\n';
                            message += '‚úÖ Sistema de configuraciones funcionando correctamente\n\n';
                            message += 'üìä Resultados de la prueba:\n';
                            message += `‚Ä¢ Configuraci√≥n original: Matr√≠cula $${result.testResults.original.ENROLLMENT_FEE}\n`;
                            message += `‚Ä¢ Configuraci√≥n de prueba: Matr√≠cula $${result.testResults.test.ENROLLMENT_FEE}\n`;
                            message += `‚Ä¢ Configuraci√≥n restaurada: Matr√≠cula $${result.testResults.restored.ENROLLMENT_FEE}\n\n`;
                            message += 'üí° Los precios han sido restaurados a sus valores originales.';
                            
                            alert(message);
                            showSuccess('Sistema de configuraciones funcionando correctamente');
                            
                            // Recargar configuraci√≥n actual
                            loadFinancialConfig();
                        } else {
                            showError('Error en la prueba: ' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error probando sistema:', error);
                        showError('Error probando sistema: ' + error.toString());
                    })
                    .testConfigurationSystem();
                    
            } catch (error) {
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function testTournamentApprovalSystem() {
            if (!confirm('¬øEjecutar diagn√≥stico del proceso de aprobaci√≥n de torneos?')) {
                return;
            }
            
            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            let message = 'üèÜ DIAGN√ìSTICO DEL PROCESO DE APROBACI√ìN DE TORNEOS:\n\n';
                            message += '‚úÖ DIAGN√ìSTICO EXITOSO\n\n';
                            message += 'üìä Resultados:\n';
                            message += `‚Ä¢ Jugadores de torneo en Aprobaciones: ${result.details.torneoApprovals}\n`;
                            message += `‚Ä¢ Hoja FORM_TORNEO: ${result.details.formTorneoExists ? '‚úÖ Existe' : '‚ùå No existe'}\n`;
                            message += `‚Ä¢ Hoja Aprobaciones: ${result.details.approvalsExists ? '‚úÖ Existe' : '‚ùå No existe'}\n`;
                            message += `‚Ä¢ Hoja Hist√≥rico: ${result.details.historicExists ? '‚úÖ Existe' : '‚ùå No existe'}\n\n`;
                            
                            if (result.details.torneoApprovals > 0) {
                                message += 'üèÜ PROCESO FUNCIONANDO CORRECTAMENTE:\n';
                                message += '‚úÖ El sistema puede procesar aprobaciones de torneos\n';
                                message += '‚úÖ Los jugadores se mover√°n del FORM_TORNEO al backup\n';
                                message += '‚úÖ Los datos se guardar√°n en el hist√≥rico completo\n\n';
                            } else {
                                message += '‚ö†Ô∏è NO HAY JUGADORES DE TORNEO PENDIENTES\n';
                                message += '‚Ä¢ El proceso est√° listo para funcionar cuando lleguen solicitudes\n';
                                message += '‚Ä¢ Puedes probar creando una solicitud de torneo\n\n';
                            }
                            
                            message += 'üìã Para ver los logs detallados, revisa:\n';
                            message += 'Google Apps Script ‚Üí Ejecuciones ‚Üí Ver logs';
                            
                            alert(message);
                            showSuccess('Diagn√≥stico de torneos completado exitosamente');
                            
                        } else {
                            showError('Error en diagn√≥stico: ' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error en diagn√≥stico:', error);
                        showError('Error en diagn√≥stico: ' + error.toString());
                    })
                    .testTournamentApprovalProcess();
                    
            } catch (error) {
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function diagnoseSpecificPlayer() {
            const playerId = document.getElementById('diagnosticPlayerId').value.trim();
            
            if (!playerId) {
                showError('Por favor ingresa el ID del jugador a diagnosticar');
                return;
            }
            
            if (!confirm(`¬øDiagnosticar jugador ${playerId}?`)) {
                return;
            }
            
            try {
                showLoading('Diagnosticando jugador...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        
                        if (result.success) {
                            const diagnosis = result.diagnosis;
                            let message = `üîç DIAGN√ìSTICO DE JUGADOR: ${diagnosis.playerName}\n\n`;
                            message += `üìã INFORMACI√ìN B√ÅSICA:\n`;
                            message += `‚Ä¢ ID: ${diagnosis.playerId}\n`;
                            message += `‚Ä¢ Fuente: ${diagnosis.fuente}\n`;
                            message += `‚Ä¢ Timestamp: ${diagnosis.timestamp}\n\n`;
                            message += `üìç UBICACI√ìN EN HOJAS:\n`;
                            message += `‚Ä¢ En Aprobaciones: ${diagnosis.existsInAprobaciones ? '‚úÖ S√≠' : '‚ùå No'}\n`;
                            message += `‚Ä¢ En FORM_TORNEO: ${diagnosis.existsInTorneo ? '‚úÖ S√≠' : '‚ùå No'}\n`;
                            message += `‚Ä¢ En Hist√≥rico: ${diagnosis.existsInHistoric ? '‚úÖ S√≠' : '‚ùå No'}\n`;
                            if (diagnosis.torneoRowIndex !== -1) {
                                message += `‚Ä¢ Fila en FORM_TORNEO: ${diagnosis.torneoRowIndex}\n`;
                            }
                            
                            // Mostrar resultados en la interfaz
                            showDiagnosticResults(message);
                            
                            if (diagnosis.existsInTorneo && diagnosis.existsInAprobaciones) {
                                showWarning('‚ö†Ô∏è Este jugador existe tanto en Aprobaciones como en FORM_TORNEO. Esto indica que no se elimin√≥ correctamente.');
                            } else if (diagnosis.existsInAprobaciones && !diagnosis.existsInTorneo) {
                                showSuccess('‚úÖ El jugador est√° correctamente en Aprobaciones y no en FORM_TORNEO.');
                            }
                        } else {
                            showError('Error en diagn√≥stico: ' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error ejecutando diagn√≥stico:', error);
                        showError('Error ejecutando diagn√≥stico: ' + error.toString());
                    })
                    .diagnoseTournamentPlayer(playerId);
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function testDeleteSpecificPlayer() {
            const playerId = document.getElementById('diagnosticPlayerId').value.trim();
            
            if (!playerId) {
                showError('Por favor ingresa el ID del jugador a probar');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è ATENCI√ìN: Esto probar√° la eliminaci√≥n del jugador ${playerId} de FORM_TORNEO.\n\n¬øContinuar?`)) {
                return;
            }
            
            try {
                showLoading('Probando eliminaci√≥n...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        
                        if (result.success) {
                            const details = result.details;
                            let message = `üóëÔ∏è PRUEBA DE ELIMINACI√ìN: ${details.playerName}\n\n`;
                            message += `üìä RESULTADOS:\n`;
                            message += `‚Ä¢ Registros antes: ${details.recordsBefore}\n`;
                            message += `‚Ä¢ Registros despu√©s: ${details.recordsAfter}\n`;
                            message += `‚Ä¢ Fila eliminada: ${details.torneoRowIndex}\n`;
                            message += `‚Ä¢ Resultado: ${details.deleteResult.success ? '‚úÖ √âxito' : '‚ùå Error'}\n`;
                            if (!details.deleteResult.success) {
                                message += `‚Ä¢ Error: ${details.deleteResult.message}\n`;
                            }
                            
                            showDiagnosticResults(message);
                            
                            if (details.recordsBefore > details.recordsAfter) {
                                showSuccess('‚úÖ La eliminaci√≥n fue exitosa. El registro se elimin√≥ de FORM_TORNEO.');
                            } else {
                                showError('‚ùå La eliminaci√≥n fall√≥. El registro no se elimin√≥ de FORM_TORNEO.');
                            }
                        } else {
                            showError('Error en prueba: ' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error ejecutando prueba:', error);
                        showError('Error ejecutando prueba: ' + error.toString());
                    })
                    .testDeleteFromFormTorneo(playerId);
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function clearDiagnosticInput() {
            document.getElementById('diagnosticPlayerId').value = '';
            document.getElementById('diagnosticResults').style.display = 'none';
            hideLoading();
        }

        function diagnoseAllTournamentPlayers() {
            if (!confirm('¬øDiagnosticar todos los jugadores de FORM_TORNEO para identificar cu√°les no se est√°n eliminando?')) {
                return;
            }
            
            try {
                showLoading('Diagnosticando todos los jugadores de FORM_TORNEO...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado recibido:', result);
                        
                        if (result && result.success) {
                            const details = result.details;
                            let message = `üîç DIAGN√ìSTICO COMPLETO DE FORM_TORNEO\n\n`;
                            message += `üìä Total de jugadores en FORM_TORNEO: ${details.totalPlayers}\n\n`;
                            
                            if (details.players && details.players.length > 0) {
                                message += `üìã JUGADORES EN FORM_TORNEO:\n\n`;
                                
                                details.players.forEach((player, index) => {
                                    message += `${index + 1}. ${player.jugador} (${player.email})\n`;
                                    message += `   Fila: ${player.rowIndex}\n`;
                                    message += `   Timestamp: ${player.timestamp}\n`;
                                    message += `   Torneo: ${player.torneo}\n`;
                                    message += `   Padre/Tutor: ${player.padre}\n\n`;
                                });
                                
                                message += `üìä RESUMEN:\n`;
                                message += `‚Ä¢ Total de jugadores en FORM_TORNEO: ${details.totalPlayers}\n`;
                                message += `‚Ä¢ Estos jugadores deber√≠an haberse eliminado cuando se aprobaron\n`;
                                message += `‚Ä¢ Si aparecen aqu√≠, significa que el proceso de eliminaci√≥n no funcion√≥\n\n`;
                                
                                message += `‚ö†Ô∏è PROBLEMA DETECTADO: Los jugadores no se est√°n eliminando de FORM_TORNEO.\n`;
                                message += `Esto indica que el proceso de eliminaci√≥n no est√° funcionando correctamente.\n\n`;
                            } else {
                                message += `‚úÖ No hay jugadores en FORM_TORNEO.\n`;
                            }
                            
                            showDiagnosticResults(message);
                            
                            if (details.players && details.players.length > 0) {
                                showWarning('‚ö†Ô∏è Se encontraron jugadores en FORM_TORNEO que no se eliminaron. Usa la herramienta de limpieza para eliminarlos.');
                            } else {
                                showSuccess('‚úÖ No hay jugadores en FORM_TORNEO. Todo est√° limpio.');
                            }
                        } else {
                            console.error('Error en resultado:', result);
                            showError('Error en diagn√≥stico: ' + (result ? result.message : 'Resultado nulo recibido'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error ejecutando diagn√≥stico:', error);
                        showError('Error ejecutando diagn√≥stico: ' + error.toString());
                    })
                    .diagnoseFormTorneoSimple();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function showDiagnosticResults(message) {
            const resultsDiv = document.getElementById('diagnosticResults');
            const resultsText = document.getElementById('diagnosticResultsText');
            
            resultsText.textContent = message;
            resultsDiv.style.display = 'block';
            resultsDiv.style.background = '#f0f9ff';
            resultsDiv.style.border = '1px solid #0ea5e9';
        }

        function findOrphanedTournamentPlayers() {
            if (!confirm('¬øBuscar jugadores de torneo que ya fueron procesados pero a√∫n est√°n en FORM_TORNEO?')) {
                return;
            }
            
            try {
                showLoading('Buscando jugadores hu√©rfanos...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        
                        if (result.success) {
                            const orphanedPlayers = result.orphanedPlayers;
                            let message = `üîç B√öSQUEDA DE JUGADORES HU√âRFANOS\n\n`;
                            message += `üìä Total jugadores en FORM_TORNEO: ${result.totalPlayers}\n`;
                            message += `üîç Jugadores hu√©rfanos encontrados: ${orphanedPlayers.length}\n\n`;
                            
                            if (orphanedPlayers.length > 0) {
                                message += `‚ö†Ô∏è JUGADORES QUE NECESITAN LIMPIEZA:\n\n`;
                                orphanedPlayers.forEach((player, index) => {
                                    message += `${index + 1}. ${player.nombre}\n`;
                                    message += `   Timestamp: ${player.timestamp}\n`;
                                    message += `   Fila: ${player.rowIndex}\n`;
                                    message += `   Estado: ${player.status}\n\n`;
                                });
                                
                                showCleanupResults(message, '#fef3c7', '#f59e0b');
                                showWarning(`Se encontraron ${orphanedPlayers.length} jugadores hu√©rfanos que necesitan limpieza.`);
                            } else {
                                message += `‚úÖ No se encontraron jugadores hu√©rfanos.\n`;
                                message += `Todos los jugadores en FORM_TORNEO est√°n correctamente procesados.`;
                                
                                showCleanupResults(message, '#f0fdf4', '#10b981');
                                showSuccess('No hay jugadores hu√©rfanos. El sistema est√° limpio.');
                            }
                        } else {
                            showError('Error en b√∫squeda: ' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error ejecutando b√∫squeda:', error);
                        showError('Error ejecutando b√∫squeda: ' + error.toString());
                    })
                    .findOrphanedTournamentPlayers();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function cleanupOrphanedPlayers() {
            if (!confirm('‚ö†Ô∏è ATENCI√ìN: Esto eliminar√° todos los jugadores hu√©rfanos de FORM_TORNEO.\n\n¬øContinuar con la limpieza?')) {
                return;
            }
            
            try {
                showLoading('Limpiando jugadores hu√©rfanos...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        
                        if (result.success) {
                            const cleanupResults = result.cleanupResults;
                            let message = `üßπ LIMPIEZA DE JUGADORES HU√âRFANOS\n\n`;
                            message += `üìä RESULTADOS:\n`;
                            message += `‚Ä¢ Jugadores procesados: ${cleanupResults.processed}\n`;
                            message += `‚Ä¢ Eliminaciones exitosas: ${cleanupResults.successful}\n`;
                            message += `‚Ä¢ Errores: ${cleanupResults.errors}\n\n`;
                            
                            if (cleanupResults.details && cleanupResults.details.length > 0) {
                                message += `üìã DETALLES:\n`;
                                cleanupResults.details.forEach((detail, index) => {
                                    message += `${index + 1}. ${detail.playerName}\n`;
                                    message += `   Resultado: ${detail.success ? '‚úÖ Eliminado' : '‚ùå Error'}\n`;
                                    if (!detail.success) {
                                        message += `   Error: ${detail.error}\n`;
                                    }
                                    message += `\n`;
                                });
                            }
                            
                            showCleanupResults(message, '#f0fdf4', '#10b981');
                            showSuccess(`Limpieza completada: ${cleanupResults.successful} jugadores eliminados exitosamente.`);
                        } else {
                            showError('Error en limpieza: ' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error ejecutando limpieza:', error);
                        showError('Error ejecutando limpieza: ' + error.toString());
                    })
                    .cleanupOrphanedTournamentPlayers();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function showCleanupResults(message, bgColor, borderColor) {
            const resultsDiv = document.getElementById('cleanupResults');
            const resultsText = document.getElementById('cleanupResultsText');
            
            resultsText.textContent = message;
            resultsDiv.style.display = 'block';
            resultsDiv.style.background = bgColor;
            resultsDiv.style.border = `1px solid ${borderColor}`;
        }

        function diagnoseTodayCounters() {
            if (!confirm('¬øDiagnosticar problemas con los contadores de hoy?')) {
                return;
            }
            
            try {
                showLoading('Diagnosticando contadores...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        
                        if (result.success) {
                            const details = result.details;
                            let message = `üìä DIAGN√ìSTICO DE CONTADORES DE HOY\n\n`;
                            message += `üìÖ Fecha de hoy (toDateString): ${details.todayDate}\n`;
                            message += `üìÖ Fecha de hoy (ISO): ${details.todayISO}\n`;
                            message += `üìÖ Fecha de hoy (formatted): ${details.todayFormatted}\n`;
                            message += `üìã Total de registros en hist√≥rico: ${details.totalRecords}\n`;
                            message += `‚úÖ Aprobaciones de hoy: ${details.todayApprovals}\n`;
                            message += `‚ùå Rechazos de hoy: ${details.todayRejections}\n\n`;
                            
                            if (details.todayDetails && details.todayDetails.length > 0) {
                                message += `üìã REGISTROS DE HOY ENCONTRADOS:\n`;
                                details.todayDetails.forEach((detail, index) => {
                                    message += `${index + 1}. Fila ${detail.row}\n`;
                                    message += `   Fecha: ${detail.fecha}\n`;
                                    message += `   Fecha ISO: ${detail.fechaISO}\n`;
                                    message += `   Fecha Formatted: ${detail.fechaFormatted}\n`;
                                    message += `   Acci√≥n: ${detail.accion}\n`;
                                    message += `   Fecha Original: ${detail.fechaOriginal}\n\n`;
                                });
                            } else {
                                message += `‚ö†Ô∏è NO SE ENCONTRARON REGISTROS DE HOY\n`;
                                message += `Esto puede indicar un problema con:\n`;
                                message += `‚Ä¢ El formato de fechas en el hist√≥rico\n`;
                                message += `‚Ä¢ La zona horaria\n`;
                                message += `‚Ä¢ Los registros no se est√°n guardando correctamente\n\n`;
                            }
                            
                            if (details.allDates && details.allDates.length > 0) {
                                message += `üîç PRIMERAS FECHAS ENCONTRADAS EN EL HIST√ìRICO:\n`;
                                details.allDates.forEach((dateInfo, index) => {
                                    message += `${index + 1}. Fila ${dateInfo.row}\n`;
                                    message += `   Original: ${dateInfo.original}\n`;
                                    message += `   toDateString: ${dateInfo.toDateString}\n`;
                                    message += `   ISO: ${dateInfo.iso}\n`;
                                    message += `   Formatted: ${dateInfo.formatted}\n\n`;
                                });
                            }
                            
                            message += `üîç HEADERS DEL HIST√ìRICO:\n`;
                            message += `${details.headers.join(', ')}\n\n`;
                            
                            showCounterDiagnosticResults(message);
                            
                            if (details.todayApprovals === 0 && details.todayRejections === 0) {
                                showWarning('‚ö†Ô∏è No se encontraron aprobaciones o rechazos de hoy. Revisa el formato de fechas.');
                            } else {
                                showSuccess(`‚úÖ Contadores funcionando: ${details.todayApprovals} aprobaciones, ${details.todayRejections} rechazos de hoy.`);
                            }
                        } else {
                            showError('Error en diagn√≥stico: ' + result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error ejecutando diagn√≥stico:', error);
                        showError('Error ejecutando diagn√≥stico: ' + error.toString());
                    })
                    .diagnoseTodayCounters();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function showCounterDiagnosticResults(message) {
            const resultsDiv = document.getElementById('counterDiagnosticResults');
            const resultsText = document.getElementById('counterDiagnosticResultsText');
            
            resultsText.textContent = message;
            resultsDiv.style.display = 'block';
            resultsDiv.style.background = '#f0f9ff';
            resultsDiv.style.border = '1px solid #0ea5e9';
        }

        function testConnection() {
            try {
                showLoading('Probando conexi√≥n...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado de prueba:', result);
                        
                        if (result && result.success) {
                            showSuccess('‚úÖ Conexi√≥n exitosa: ' + result.message);
                            console.log('Timestamp:', result.timestamp);
                        } else {
                            showError('‚ùå Error en conexi√≥n: ' + (result ? result.message : 'Resultado nulo'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error en prueba de conexi√≥n:', error);
                        showError('‚ùå Error en conexi√≥n: ' + error.toString());
                    })
                    .testConnection();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function checkFormTorneo() {
            try {
                showLoading('Verificando FORM_TORNEO...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado de verificaci√≥n:', result);
                        
                        if (result && result.success) {
                            showSuccess(`‚úÖ FORM_TORNEO encontrado: ${result.message} - Filas: ${result.rowCount}, Columnas: ${result.colCount}`);
                        } else {
                            showError('‚ùå Error en verificaci√≥n: ' + (result ? result.message : 'Resultado nulo'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error en verificaci√≥n:', error);
                        showError('‚ùå Error en verificaci√≥n: ' + error.toString());
                    })
                    .checkFormTorneo();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function diagnoseFormTorneoSuperSimple() {
            try {
                showLoading('Diagn√≥stico s√∫per simple...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado s√∫per simple:', result);
                        
                        if (result && result.success) {
                            showSuccess(`‚úÖ Diagn√≥stico s√∫per simple: ${result.message} - Filas: ${result.rowCount}, Primer jugador: ${result.firstPlayer}`);
                        } else {
                            showError('‚ùå Error en diagn√≥stico s√∫per simple: ' + (result ? result.message : 'Resultado nulo'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error en diagn√≥stico s√∫per simple:', error);
                        showError('‚ùå Error en diagn√≥stico s√∫per simple: ' + error.toString());
                    })
                    .diagnoseFormTorneoSuperSimple();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function getFormTorneoPlayers() {
            try {
                showLoading('Obteniendo jugadores de FORM_TORNEO...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado de jugadores:', result);
                        
                        if (result && result.success) {
                            let message = `üìã JUGADORES EN FORM_TORNEO\n\n`;
                            message += `üìä Total: ${result.totalPlayers} jugadores\n\n`;
                            
                            if (result.players && result.players.length > 0) {
                                message += `üìã LISTA DE JUGADORES:\n\n`;
                                result.players.forEach((player, index) => {
                                    message += `${index + 1}. ${player.jugador}\n`;
                                    message += `   Email: ${player.email}\n`;
                                    message += `   Torneo: ${player.torneo}\n`;
                                    message += `   Padre/Tutor: ${player.padre}\n`;
                                    message += `   Timestamp: ${player.timestamp}\n`;
                                    message += `   Fila: ${player.row}\n\n`;
                                });
                            } else {
                                message += `‚úÖ No hay jugadores en FORM_TORNEO.\n`;
                            }
                            
                            showDiagnosticResults(message);
                            showSuccess(`‚úÖ ${result.message}`);
                        } else {
                            showError('‚ùå Error obteniendo jugadores: ' + (result ? result.message : 'Resultado nulo'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error obteniendo jugadores:', error);
                        showError('‚ùå Error obteniendo jugadores: ' + error.toString());
                    })
                    .getFormTorneoPlayers();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function getFormTorneoBasicInfo() {
            try {
                showLoading('Obteniendo informaci√≥n b√°sica de FORM_TORNEO...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado b√°sico:', result);
                        
                        if (result && result.success) {
                            let message = `üìä INFORMACI√ìN B√ÅSICA DE FORM_TORNEO\n\n`;
                            message += `üìã Total de filas: ${result.rowCount}\n\n`;
                            
                            if (result.rowCount > 1) {
                                message += `üë§ PRIMER JUGADOR:\n`;
                                message += `   Nombre: ${result.firstPlayer}\n`;
                                message += `   Email: ${result.firstEmail}\n\n`;
                                
                                if (result.secondPlayer !== 'No hay segundo jugador') {
                                    message += `üë§ SEGUNDO JUGADOR:\n`;
                                    message += `   Nombre: ${result.secondPlayer}\n`;
                                    message += `   Email: ${result.secondEmail}\n\n`;
                                }
                            } else {
                                message += `‚úÖ No hay jugadores en FORM_TORNEO.\n`;
                            }
                            
                            showDiagnosticResults(message);
                            showSuccess(`‚úÖ ${result.message}`);
                        } else {
                            showError('‚ùå Error obteniendo informaci√≥n b√°sica: ' + (result ? result.message : 'Resultado nulo'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error obteniendo informaci√≥n b√°sica:', error);
                        showError('‚ùå Error obteniendo informaci√≥n b√°sica: ' + error.toString());
                    })
                    .getFormTorneoBasicInfo();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function getFormTorneoDetailedInfo() {
            try {
                showLoading('Obteniendo informaci√≥n detallada de FORM_TORNEO...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado detallado:', result);
                        
                        if (result && result.success) {
                            let message = `üìã INFORMACI√ìN DETALLADA DE FORM_TORNEO\n\n`;
                            message += `üìä Total de filas: ${result.rowCount}\n`;
                            message += `üë• Total de jugadores: ${result.playerCount}\n\n`;
                            
                            if (result.playerInfo) {
                                message += `üìã LISTA DETALLADA DE JUGADORES:\n\n`;
                                message += result.playerInfo;
                            } else {
                                message += `‚úÖ No hay jugadores en FORM_TORNEO.\n`;
                            }
                            
                            showDiagnosticResults(message);
                            showSuccess(`‚úÖ ${result.message}`);
                        } else {
                            showError('‚ùå Error obteniendo informaci√≥n detallada: ' + (result ? result.message : 'Resultado nulo'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error obteniendo informaci√≥n detallada:', error);
                        showError('‚ùå Error obteniendo informaci√≥n detallada: ' + error.toString());
                    })
                    .getFormTorneoDetailedInfo();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function checkFormTorneoPlayersInAprobaciones() {
            try {
                showLoading('Verificando jugadores de FORM_TORNEO en Aprobaciones...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado de verificaci√≥n:', result);
                        
                        if (result && result.success) {
                            let message = `üîç VERIFICACI√ìN DE JUGADORES EN APROBACIONES\n\n`;
                            message += `üìä Total de filas en FORM_TORNEO: ${result.torneoRowCount}\n`;
                            message += `üë• Total de jugadores en FORM_TORNEO: ${result.torneoPlayerCount}\n\n`;
                            
                            if (result.torneoPlayers) {
                                message += `üìã JUGADORES EN FORM_TORNEO:\n\n`;
                                message += result.torneoPlayers;
                            } else {
                                message += `‚úÖ No hay jugadores en FORM_TORNEO.\n`;
                            }
                            
                            showDiagnosticResults(message);
                            showSuccess(`‚úÖ ${result.message}`);
                        } else {
                            showError('‚ùå Error verificando jugadores: ' + (result ? result.message : 'Resultado nulo'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error verificando jugadores:', error);
                        showError('‚ùå Error verificando jugadores: ' + error.toString());
                    })
                    .checkFormTorneoPlayersInAprobaciones();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function diagnoseAprobacionesColumnQ() {
            try {
                showLoading('Diagnosticando columna Q de Aprobaciones...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado de diagn√≥stico:', result);
                        
                        if (result && result.success) {
                            let message = `üîç DIAGN√ìSTICO DE COLUMNA Q EN APROBACIONES\n\n`;
                            message += `üìä Total de jugadores de torneo: ${result.playerCount}\n\n`;
                            
                            if (result.diagnosticInfo) {
                                message += `üìã INFORMACI√ìN DETALLADA:\n\n`;
                                message += result.diagnosticInfo;
                            } else {
                                message += `‚úÖ No hay jugadores de torneo en Aprobaciones.\n`;
                            }
                            
                            showDiagnosticResults(message);
                            showSuccess(`‚úÖ ${result.message}`);
                        } else {
                            showError('‚ùå Error diagnosticando columna Q: ' + (result ? result.message : 'Resultado nulo'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error diagnosticando columna Q:', error);
                        showError('‚ùå Error diagnosticando columna Q: ' + error.toString());
                    })
                    .diagnoseAprobacionesColumnQ();
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        function runUpdatePlayerCategories() {
            if (!confirm('Esto recalcular√° la categor√≠a de TODOS los jugadores usando las nuevas reglas:\n\n' +
                'Masculino:\n' +
                '‚Ä¢ U6: 2020-2021\n' +
                '‚Ä¢ U8: 2018-2019\n' +
                '‚Ä¢ U10: 2016-2017\n' +
                '‚Ä¢ U12: 2014-2015\n' +
                '‚Ä¢ U14: 2012-2013\n' +
                '‚Ä¢ U16: 2010-2011\n\n' +
                'Femenina:\n' +
                '‚Ä¢ U10: 2016-2017\n' +
                '‚Ä¢ U12: 2014-2015\n' +
                '‚Ä¢ U14: 2012-2013\n' +
                '‚Ä¢ U16: 2010-2011\n' +
                '‚Ä¢ U18: 2009 en adelante\n\n' +
                '¬øDeseas continuar?')) {
                return;
            }

            try {
                showLoading('Actualizando categor√≠as de jugadores...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado actualizaci√≥n categor√≠as:', result);

                        if (result && result.success) {
                            let message = `üè∑Ô∏è ACTUALIZACI√ìN DE CATEGOR√çAS\n\n`;
                            message += `‚úÖ ${result.message || 'Proceso completado'}\n`;
                            if (result.updated !== undefined) {
                                message += `‚Ä¢ Jugadores actualizados: ${result.updated}\n`;
                            }
                            if (result.total !== undefined) {
                                message += `‚Ä¢ Total revisados: ${result.total}\n`;
                            }
                            
                            // Mostrar detalles de cambios si est√°n disponibles
                            if (result.changes && result.changes.length > 0) {
                                message += `\nüìã DETALLES DE CAMBIOS:\n\n`;
                                result.changes.slice(0, 20).forEach(function(change) {
                                    message += `‚Ä¢ ${change.player} (${change.id}):\n`;
                                    message += `  "${change.oldCategory}" ‚Üí "${change.newCategory}"\n`;
                                    message += `  (G√©nero: ${change.gender || 'N/A'}, A√±o: ${change.birthYear || 'N/A'})\n\n`;
                                });
                                if (result.changes.length > 20) {
                                    message += `... y ${result.changes.length - 20} cambios m√°s (consulta los logs para ver todos)\n`;
                                }
                            }

                            showDiagnosticResults(message);
                            showSuccess(result.message || 'Categor√≠as actualizadas correctamente');
                        } else {
                            const errorMessage = result && result.message ? result.message : 'No se pudo actualizar las categor√≠as';
                            showError('‚ùå ' + errorMessage);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error actualizando categor√≠as:', error);
                        showError('‚ùå Error actualizando categor√≠as: ' + error.toString());
                    })
                    .updateAllPlayerCategories();

            } catch (error) {
                hideLoading();
                console.error('Error ejecutando actualizaci√≥n de categor√≠as:', error);
                showError('Error actualizando categor√≠as: ' + error.toString());
            }
        }

        function showMessage(message, type = 'info') {
            console.log(`${type.toUpperCase()}:`, message);
            alert(`${type.toUpperCase()}: ${message}`);
        }

        // Funci√≥n de debug para verificar conexi√≥n
        function testConnection() {
            try {
                console.log('Probando conexi√≥n con Google Apps Script...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Conexi√≥n exitosa:', result);
                        showSuccess('Conexi√≥n con Google Apps Script establecida correctamente');
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error de conexi√≥n:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .getSystemConfig();
            } catch (error) {
                console.error('Error en test de conexi√≥n:', error);
                showError('Error en test de conexi√≥n: ' + error.message);
            }
        }

        // Funci√≥n de diagn√≥stico del sistema
        function runDiagnosis() {
            try {
                console.log('Ejecutando diagn√≥stico del sistema...');
                google.script.run
                    .withSuccessHandler(function(diagnosis) {
                        console.log('Diagn√≥stico completado:', diagnosis);
                        displayDiagnosisResults(diagnosis);
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error en diagn√≥stico:', error);
                        showError('Error en diagn√≥stico: ' + error.toString());
                    })
                    .diagnoseSystem();
            } catch (error) {
                console.error('Error ejecutando diagn√≥stico:', error);
                showError('Error ejecutando diagn√≥stico: ' + error.message);
            }
        }

        function runFamilyGroupingByTutor() {
            if (!confirm('¬øQuieres agrupar autom√°ticamente a los jugadores que comparten tutor en grupos familiares?')) {
                return;
            }

            try {
                showLoading('Agrupando familias por tutor...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado agrupamiento por tutor:', result);

                        if (result && result.success) {
                            var message = '‚úÖ Agrupamiento completado\n\n';
                            message += 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familias procesadas: ' + (result.familiesProcessed || 0) + '\n';
                            message += 'üè† Familias creadas: ' + (result.familiesCreated || 0) + '\n';
                            message += 'üë• Jugadores actualizados: ' + (result.playersUpdated || 0) + '\n';

                            if (result.families && result.families.length) {
                                message += '\nüèÖ Primeras familias generadas/actualizadas:\n';
                                result.families.slice(0, 5).forEach(function(family, index) {
                                    message += (index + 1) + '. ' + (family.tutorName || 'Tutor sin nombre');
                                    if (family.familyId) {
                                        message += ' (' + family.familyId + ')';
                                    }
                                    message += ' ‚Üí ' + (family.players || 0) + ' jugadores\n';
                                });
                                if (result.families.length > 5) {
                                    message += '... y ' + (result.families.length - 5) + ' familias m√°s\n';
                                }
                            }

                            alert(message);
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo completar el agrupamiento';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error agrupando familias por tutor:', error);
                        showError('Error agrupando familias: ' + error.toString());
                    })
                    .createFamilyGroupsByTutor();

            } catch (error) {
                hideLoading();
                console.error('Error ejecutando agrupamiento por tutor:', error);
                showError('Error agrupando familias: ' + error.toString());
            }
        }

        // Funci√≥n para crear backup completo de jugadores
        function createPlayersBackup() {
            if (!confirm('¬øCrear backup completo de todos los jugadores?\n\nEsto crear√° una nueva hoja con todos los datos.')) {
                return;
            }

            try {
                showLoading('Creando backup completo de jugadores...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado backup:', result);

                        if (result && result.success) {
                            var message = '‚úÖ Backup creado exitosamente\n\n';
                            message += 'üìã Hoja de backup: ' + result.sheetName + '\n';
                            message += 'üë• Total de jugadores: ' + result.totalPlayers + '\n';
                            message += 'üìÖ Fecha: ' + new Date(result.timestamp).toLocaleString('es-ES') + '\n';
                            alert(message);
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo crear el backup';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error creando backup:', error);
                        showError('Error creando backup: ' + error.toString());
                    })
                    .backupAllPlayersComplete();

            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Funci√≥n para analizar asignaciones de familias
        function analyzeFamilyAssignmentsUI() {
            try {
                showLoading('Analizando asignaciones de familias...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado an√°lisis:', result);

                        if (result && result.success) {
                            var message = 'üìä AN√ÅLISIS DE ASIGNACIONES DE FAMILIAS\n\n';
                            
                            if (result.summary) {
                                message += 'üìà RESUMEN:\n';
                                message += '‚Ä¢ Total jugadores activos: ' + result.summary.totalJugadoresActivos + '\n';
                                message += '‚Ä¢ Familias reales (2+ jugadores): ' + result.summary.familiasReales + '\n';
                                message += '‚Ä¢ Jugadores en familias: ' + result.summary.totalJugadoresEnFamilias + '\n';
                                message += '‚Ä¢ Jugadores solos: ' + result.summary.jugadoresSolo + '\n';
                                message += '‚Ä¢ Jugadores a limpiar: ' + result.summary.jugadoresALimpiar + '\n\n';
                            }

                            if (result.playersToClean && result.playersToClean.length > 0) {
                                message += '‚ö†Ô∏è JUGADORES QUE NECESITAN LIMPIEZA:\n';
                                result.playersToClean.slice(0, 10).forEach(function(player, index) {
                                    message += (index + 1) + '. ' + player.nombre + ' (ID: ' + player.id + ')\n';
                                    message += '   Familia ID actual: ' + player.familiaIdActual + '\n';
                                    message += '   Raz√≥n: ' + player.razon + '\n\n';
                                });
                                if (result.playersToClean.length > 10) {
                                    message += '... y ' + (result.playersToClean.length - 10) + ' jugadores m√°s\n\n';
                                }
                            } else {
                                message += '‚úÖ No hay jugadores que necesiten limpieza\n';
                            }

                            if (result.realFamilies && result.realFamilies.length > 0) {
                                message += '\nüë®‚Äçüë©‚Äçüëß‚Äçüë¶ FAMILIAS REALES ENCONTRADAS:\n';
                                result.realFamilies.slice(0, 5).forEach(function(family, index) {
                                    message += (index + 1) + '. C√©dula Tutor: ' + family.cedulaTutor + '\n';
                                    message += '   Jugadores: ' + family.totalPlayers + '\n';
                                    family.players.slice(0, 3).forEach(function(p) {
                                        message += '   - ' + p.nombre + ' (ID: ' + p.id + ')\n';
                                    });
                                    if (family.players.length > 3) {
                                        message += '   ... y ' + (family.players.length - 3) + ' m√°s\n';
                                    }
                                    message += '\n';
                                });
                                if (result.realFamilies.length > 5) {
                                    message += '... y ' + (result.realFamilies.length - 5) + ' familias m√°s\n';
                                }
                            }

                            alert(message);
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo completar el an√°lisis';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error analizando familias:', error);
                        showError('Error analizando familias: ' + error.toString());
                    })
                    .analyzeFamilyAssignments();

            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Funci√≥n para limpiar asignaciones de familias
        function cleanFamilyAssignmentsUI() {
            // Primero mostrar preview sin confirmaci√≥n
            try {
                showLoading('Analizando jugadores para limpieza...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Preview limpieza:', result);

                        if (result && result.success) {
                            if (result.preview) {
                                // Mostrar preview y pedir confirmaci√≥n
                                var message = '‚ö†Ô∏è PREVIEW DE LIMPIEZA\n\n';
                                message += result.message + '\n\n';

                                if (result.playersToClean && result.playersToClean.length > 0) {
                                    message += 'JUGADORES QUE SER√ÅN ACTUALIZADOS:\n';
                                    result.playersToClean.slice(0, 10).forEach(function(player, index) {
                                        message += (index + 1) + '. ' + player.nombre + ' (ID: ' + player.id + ')\n';
                                        message += '   Familia ID actual: ' + player.familiaIdActual + '\n';
                                        message += '   ‚Üí Ser√° cambiado a: "sin grupo familiar"\n';
                                        message += '   Raz√≥n: ' + player.razon + '\n\n';
                                    });
                                    if (result.playersToClean.length > 10) {
                                        message += '... y ' + (result.playersToClean.length - 10) + ' jugadores m√°s\n\n';
                                    }
                                }

                                message += '\n‚ö†Ô∏è ¬øDeseas ejecutar la limpieza?';

                                if (confirm(message)) {
                                    // Ejecutar limpieza con confirm=true
                                    executeCleanFamilyAssignments();
                                }
                            } else if (result.cleaned !== undefined) {
                                // Ya se ejecut√≥ la limpieza
                                var message = '‚úÖ LIMPIEZA COMPLETADA\n\n';
                                message += '‚Ä¢ Jugadores actualizados: ' + result.cleaned + '\n';
                                message += '‚Ä¢ Jugadores omitidos: ' + (result.skipped || 0) + '\n\n';

                                if (result.cleanedPlayers && result.cleanedPlayers.length > 0) {
                                    message += 'JUGADORES ACTUALIZADOS:\n';
                                    result.cleanedPlayers.slice(0, 10).forEach(function(player, index) {
                                        message += (index + 1) + '. ' + player.nombre + ' (ID: ' + player.id + ')\n';
                                        message += '   Familia ID anterior: ' + player.familiaIdAnterior + '\n';
                                        message += '   Raz√≥n: ' + player.razon + '\n\n';
                                    });
                                    if (result.cleanedPlayers.length > 10) {
                                        message += '... y ' + (result.cleanedPlayers.length - 10) + ' jugadores m√°s\n';
                                    }
                                }

                                alert(message);
                            } else {
                                alert(result.message || 'No hay jugadores que necesiten limpieza');
                            }
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo completar la limpieza';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error en limpieza:', error);
                        showError('Error en limpieza: ' + error.toString());
                    })
                    .cleanFamilyAssignments(false); // Preview sin confirmaci√≥n

            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Funci√≥n auxiliar para ejecutar limpieza con confirmaci√≥n
        function executeCleanFamilyAssignments() {
            try {
                showLoading('Ejecutando limpieza de familias ID...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado limpieza:', result);

                        if (result && result.success) {
                            var message = '‚úÖ LIMPIEZA COMPLETADA\n\n';
                            message += '‚Ä¢ Jugadores actualizados: ' + result.cleaned + '\n';
                            message += '‚Ä¢ Jugadores omitidos: ' + (result.skipped || 0) + '\n\n';

                            if (result.cleanedPlayers && result.cleanedPlayers.length > 0) {
                                message += 'JUGADORES ACTUALIZADOS:\n';
                                result.cleanedPlayers.slice(0, 10).forEach(function(player, index) {
                                    message += (index + 1) + '. ' + player.nombre + ' (ID: ' + player.id + ')\n';
                                    message += '   Familia ID anterior: ' + player.familiaIdAnterior + '\n';
                                    message += '   Raz√≥n: ' + player.razon + '\n\n';
                                });
                                if (result.cleanedPlayers.length > 10) {
                                    message += '... y ' + (result.cleanedPlayers.length - 10) + ' jugadores m√°s\n';
                                }
                            }

                            alert(message);
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo completar la limpieza';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error ejecutando limpieza:', error);
                        showError('Error ejecutando limpieza: ' + error.toString());
                    })
                    .cleanFamilyAssignments(true); // Ejecutar con confirmaci√≥n

            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Funci√≥n para actualizar cuotas emitidas
        function updateExistingMonthlyPaymentsUI() {
            // Primero mostrar preview sin confirmaci√≥n
            try {
                showLoading('Analizando cuotas pendientes...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Preview actualizaci√≥n de cuotas:', result);

                        if (result && result.success) {
                            if (result.preview) {
                                // Mostrar preview y pedir confirmaci√≥n
                                var message = '‚ö†Ô∏è PREVIEW DE ACTUALIZACI√ìN DE CUOTAS\n\n';
                                message += result.message + '\n\n';

                                if (result.paymentsToUpdate && result.paymentsToUpdate.length > 0) {
                                    message += 'CUOTAS QUE SER√ÅN ACTUALIZADAS:\n';
                                    result.paymentsToUpdate.slice(0, 10).forEach(function(payment, index) {
                                        message += (index + 1) + '. ' + payment.playerName + ' (ID: ' + payment.playerId + ')\n';
                                        message += '   Monto actual: $' + payment.montoActual.toFixed(2) + '\n';
                                        message += '   ‚Üí Monto correcto: $' + payment.montoCorrecto.toFixed(2) + '\n';
                                        message += '   Tipo: ' + (payment.tipoMensualidad || 'N/A') + '\n';
                                        message += '   Raz√≥n: ' + payment.razon + '\n\n';
                                    });
                                    if (result.paymentsToUpdate.length > 10) {
                                        message += '... y ' + (result.paymentsToUpdate.length - 10) + ' cuotas m√°s\n\n';
                                    }
                                } else {
                                    message += '‚úÖ No hay cuotas que necesiten actualizaci√≥n\n';
                                }

                                message += '\n‚ö†Ô∏è ¬øDeseas ejecutar la actualizaci√≥n?';

                                if (confirm(message)) {
                                    // Ejecutar actualizaci√≥n con confirm=true
                                    executeUpdateMonthlyPayments();
                                }
                            } else if (result.updated !== undefined) {
                                // Ya se ejecut√≥ la actualizaci√≥n
                                var message = '‚úÖ ACTUALIZACI√ìN COMPLETADA\n\n';
                                message += '‚Ä¢ Cuotas revisadas: ' + result.reviewed + '\n';
                                message += '‚Ä¢ Cuotas actualizadas: ' + result.updated + '\n';
                                message += '‚Ä¢ Cuotas sin cambios: ' + (result.unchanged || 0) + '\n\n';

                                if (result.updatedPayments && result.updatedPayments.length > 0) {
                                    message += 'CUOTAS ACTUALIZADAS:\n';
                                    result.updatedPayments.slice(0, 10).forEach(function(payment, index) {
                                        message += (index + 1) + '. ' + payment.playerName + ' (ID: ' + payment.playerId + ')\n';
                                        message += '   Monto anterior: $' + payment.montoAnterior.toFixed(2) + '\n';
                                        message += '   Monto nuevo: $' + payment.montoNuevo.toFixed(2) + '\n';
                                        message += '   Raz√≥n: ' + payment.razon + '\n\n';
                                    });
                                    if (result.updatedPayments.length > 10) {
                                        message += '... y ' + (result.updatedPayments.length - 10) + ' cuotas m√°s\n';
                                    }
                                }

                                alert(message);
                            } else {
                                alert(result.message || 'No hay cuotas que necesiten actualizaci√≥n');
                            }
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo completar la actualizaci√≥n';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error en actualizaci√≥n de cuotas:', error);
                        showError('Error en actualizaci√≥n de cuotas: ' + error.toString());
                    })
                    .updateExistingMonthlyPayments(false); // Preview sin confirmaci√≥n

            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Funci√≥n auxiliar para ejecutar actualizaci√≥n de cuotas con confirmaci√≥n
        function executeUpdateMonthlyPayments() {
            try {
                showLoading('Ejecutando actualizaci√≥n de cuotas...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado actualizaci√≥n de cuotas:', result);

                        if (result && result.success) {
                            var message = '‚úÖ ACTUALIZACI√ìN COMPLETADA\n\n';
                            message += '‚Ä¢ Cuotas revisadas: ' + result.reviewed + '\n';
                            message += '‚Ä¢ Cuotas actualizadas: ' + result.updated + '\n';
                            message += '‚Ä¢ Cuotas sin cambios: ' + (result.unchanged || 0) + '\n\n';

                            if (result.updatedPayments && result.updatedPayments.length > 0) {
                                message += 'CUOTAS ACTUALIZADAS:\n';
                                result.updatedPayments.slice(0, 10).forEach(function(payment, index) {
                                    message += (index + 1) + '. ' + payment.playerName + ' (ID: ' + payment.playerId + ')\n';
                                    message += '   Monto anterior: $' + payment.montoAnterior.toFixed(2) + '\n';
                                    message += '   Monto nuevo: $' + payment.montoNuevo.toFixed(2) + '\n';
                                    message += '   Raz√≥n: ' + payment.razon + '\n\n';
                                });
                                if (result.updatedPayments.length > 10) {
                                    message += '... y ' + (result.updatedPayments.length - 10) + ' cuotas m√°s\n';
                                }
                            }

                            alert(message);
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo completar la actualizaci√≥n';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error ejecutando actualizaci√≥n de cuotas:', error);
                        showError('Error ejecutando actualizaci√≥n de cuotas: ' + error.toString());
                    })
                    .updateExistingMonthlyPayments(true); // Ejecutar con confirmaci√≥n

            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Funci√≥n para actualizar hist√≥ricos transaccionales
        function updateAllHistoricalMonthlyPaymentsUI() {
            // Primero mostrar preview sin confirmaci√≥n
            try {
                showLoading('Analizando hist√≥ricos transaccionales...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Preview actualizaci√≥n de hist√≥ricos:', result);

                        if (result && result.success) {
                            if (result.preview) {
                                // Mostrar preview y pedir confirmaci√≥n
                                var message = '‚ö†Ô∏è PREVIEW DE ACTUALIZACI√ìN DE HIST√ìRICOS\n\n';
                                if (result.totalPaymentsFound !== undefined) {
                                    message += '‚Ä¢ Total de pagos de mensualidad encontrados: ' + result.totalPaymentsFound + '\n';
                                }
                                if (result.totalPlayers !== undefined) {
                                    message += '‚Ä¢ Jugadores √∫nicos con pagos: ' + result.totalPlayers + '\n';
                                }
                                if (result.playersNotFound !== undefined && result.playersNotFound > 0) {
                                    message += '‚Ä¢ Pagos con jugador no encontrado: ' + result.playersNotFound + '\n';
                                    if (result.playersNotFoundList && result.playersNotFoundList.length > 0) {
                                        message += '  IDs no encontrados: ' + result.playersNotFoundList.slice(0, 5).join(', ');
                                        if (result.playersNotFoundList.length > 5) {
                                            message += ' y ' + (result.playersNotFoundList.length - 5) + ' m√°s';
                                        }
                                        message += '\n';
                                    }
                                }
                                if (result.skippedEmpty !== undefined && result.skippedEmpty > 0) {
                                    message += '‚Ä¢ Pagos sin Jugador ID: ' + result.skippedEmpty + '\n';
                                }
                                message += '\n';
                                message += result.message + '\n\n';

                                if (result.paymentsToUpdate && result.paymentsToUpdate.length > 0) {
                                    message += 'MENSUALIDADES QUE SER√ÅN ACTUALIZADAS:\n';
                                    result.paymentsToUpdate.slice(0, 10).forEach(function(payment, index) {
                                        message += (index + 1) + '. ' + (payment.playerName || payment.playerId) + ' (ID: ' + payment.playerId + ')\n';
                                        message += '   Estado: ' + payment.estado + '\n';
                                        message += '   Fecha: ' + (payment.fecha || 'N/A') + '\n';
                                        message += '   Monto actual: $' + payment.montoActual.toFixed(2) + '\n';
                                        message += '   ‚Üí Monto correcto: $' + payment.montoCorrecto.toFixed(2) + '\n';
                                        message += '   Tipo: ' + (payment.tipoMensualidad || 'N/A') + '\n';
                                        message += '   Raz√≥n: ' + payment.razon + '\n\n';
                                    });
                                    if (result.paymentsToUpdate.length > 10) {
                                        message += '... y ' + (result.paymentsToUpdate.length - 10) + ' mensualidades m√°s\n\n';
                                    }
                                } else {
                                    message += '‚úÖ No hay mensualidades hist√≥ricas que necesiten actualizaci√≥n\n';
                                }

                                message += '\n‚ö†Ô∏è IMPORTANTE: Esta operaci√≥n actualizar√° TODOS los pagos hist√≥ricos (incluyendo pagos ya realizados).\n';
                                message += 'Las m√©tricas contables se recalcular√°n autom√°ticamente.\n\n';
                                message += '¬øDeseas ejecutar la actualizaci√≥n?';

                                if (confirm(message)) {
                                    // Ejecutar actualizaci√≥n con confirm=true
                                    executeUpdateHistoricalMonthlyPayments();
                                }
                            } else if (result.updated !== undefined) {
                                // Ya se ejecut√≥ la actualizaci√≥n
                                var message = '‚úÖ ACTUALIZACI√ìN DE HIST√ìRICOS COMPLETADA\n\n';
                                if (result.totalPaymentsFound !== undefined) {
                                    message += '‚Ä¢ Total de pagos de mensualidad encontrados: ' + result.totalPaymentsFound + '\n';
                                }
                                if (result.totalPlayers !== undefined) {
                                    message += '‚Ä¢ Jugadores √∫nicos con pagos: ' + result.totalPlayers + '\n';
                                }
                                message += '‚Ä¢ Mensualidades revisadas: ' + result.reviewed + '\n';
                                message += '‚Ä¢ Mensualidades actualizadas: ' + result.updated + '\n';
                                message += '‚Ä¢ Sin cambios: ' + (result.unchanged || 0) + '\n';
                                if (result.playersNotFound !== undefined && result.playersNotFound > 0) {
                                    message += '‚Ä¢ Pagos con jugador no encontrado: ' + result.playersNotFound + '\n';
                                    if (result.playersNotFoundList && result.playersNotFoundList.length > 0) {
                                        message += '  IDs no encontrados: ' + result.playersNotFoundList.slice(0, 5).join(', ');
                                        if (result.playersNotFoundList.length > 5) {
                                            message += ' y ' + (result.playersNotFoundList.length - 5) + ' m√°s';
                                        }
                                        message += '\n';
                                    }
                                }
                                if (result.skippedEmpty !== undefined && result.skippedEmpty > 0) {
                                    message += '‚Ä¢ Omitidas (sin Jugador ID): ' + result.skippedEmpty + '\n';
                                }
                                message += '\n';

                                if (result.updatedPayments && result.updatedPayments.length > 0) {
                                    message += 'MENSUALIDADES ACTUALIZADAS:\n';
                                    result.updatedPayments.slice(0, 10).forEach(function(payment, index) {
                                        message += (index + 1) + '. ' + payment.playerName + ' (ID: ' + payment.playerId + ')\n';
                                        message += '   Estado: ' + payment.estado + '\n';
                                        message += '   Fecha: ' + (payment.fecha || 'N/A') + '\n';
                                        message += '   Monto anterior: $' + payment.montoAnterior.toFixed(2) + '\n';
                                        message += '   Monto nuevo: $' + payment.montoNuevo.toFixed(2) + '\n';
                                        message += '   Raz√≥n: ' + payment.razon + '\n\n';
                                    });
                                    if (result.updatedPayments.length > 10) {
                                        message += '... y ' + (result.updatedPayments.length - 10) + ' mensualidades m√°s\n';
                                    }
                                }

                                message += '\n‚úÖ Las m√©tricas contables se actualizar√°n autom√°ticamente en el pr√≥ximo acceso al dashboard.';

                                alert(message);
                            } else {
                                alert(result.message || 'No hay mensualidades hist√≥ricas que necesiten actualizaci√≥n');
                            }
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo completar la actualizaci√≥n';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error en actualizaci√≥n de hist√≥ricos:', error);
                        showError('Error en actualizaci√≥n de hist√≥ricos: ' + error.toString());
                    })
                    .updateAllHistoricalMonthlyPayments(false); // Preview sin confirmaci√≥n

            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Funci√≥n auxiliar para ejecutar actualizaci√≥n de hist√≥ricos con confirmaci√≥n
        function executeUpdateHistoricalMonthlyPayments() {
            try {
                showLoading('Ejecutando actualizaci√≥n de hist√≥ricos transaccionales...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado actualizaci√≥n de hist√≥ricos:', result);

                        if (result && result.success) {
                            var message = '‚úÖ ACTUALIZACI√ìN DE HIST√ìRICOS COMPLETADA\n\n';
                            if (result.totalPaymentsFound !== undefined) {
                                message += '‚Ä¢ Total de pagos de mensualidad encontrados: ' + result.totalPaymentsFound + '\n';
                            }
                            if (result.totalPlayers !== undefined) {
                                message += '‚Ä¢ Jugadores √∫nicos con pagos: ' + result.totalPlayers + '\n';
                            }
                            message += '‚Ä¢ Mensualidades revisadas: ' + result.reviewed + '\n';
                            message += '‚Ä¢ Mensualidades actualizadas: ' + result.updated + '\n';
                            message += '‚Ä¢ Sin cambios: ' + (result.unchanged || 0) + '\n';
                            if (result.playersNotFound !== undefined && result.playersNotFound > 0) {
                                message += '‚Ä¢ Pagos con jugador no encontrado: ' + result.playersNotFound + '\n';
                                if (result.playersNotFoundList && result.playersNotFoundList.length > 0) {
                                    message += '  IDs no encontrados: ' + result.playersNotFoundList.slice(0, 5).join(', ');
                                    if (result.playersNotFoundList.length > 5) {
                                        message += ' y ' + (result.playersNotFoundList.length - 5) + ' m√°s';
                                    }
                                    message += '\n';
                                }
                            }
                            if (result.skippedEmpty !== undefined && result.skippedEmpty > 0) {
                                message += '‚Ä¢ Omitidas (sin Jugador ID): ' + result.skippedEmpty + '\n';
                            }
                            message += '\n';

                            if (result.updatedPayments && result.updatedPayments.length > 0) {
                                message += 'MENSUALIDADES ACTUALIZADAS:\n';
                                result.updatedPayments.slice(0, 15).forEach(function(payment, index) {
                                    message += (index + 1) + '. ' + payment.playerName + ' (ID: ' + payment.playerId + ')\n';
                                    message += '   Estado: ' + payment.estado + '\n';
                                    message += '   Fecha: ' + (payment.fecha || 'N/A') + '\n';
                                    message += '   Monto anterior: $' + payment.montoAnterior.toFixed(2) + '\n';
                                    message += '   Monto nuevo: $' + payment.montoNuevo.toFixed(2) + '\n';
                                    message += '   Tipo: ' + (payment.tipoMensualidad || 'N/A') + '\n';
                                    message += '   Raz√≥n: ' + payment.razon + '\n\n';
                                });
                                if (result.updatedPayments.length > 15) {
                                    message += '... y ' + (result.updatedPayments.length - 15) + ' mensualidades m√°s\n';
                                }
                            }

                            message += '\n‚úÖ Las m√©tricas contables se actualizar√°n autom√°ticamente en el pr√≥ximo acceso al dashboard.';

                            alert(message);
                            showSuccess('Hist√≥ricos transaccionales actualizados exitosamente');
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo completar la actualizaci√≥n';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error ejecutando actualizaci√≥n de hist√≥ricos:', error);
                        showError('Error ejecutando actualizaci√≥n de hist√≥ricos: ' + error.toString());
                    })
                    .updateAllHistoricalMonthlyPayments(true); // Ejecutar con confirmaci√≥n

            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Configurar fecha de inicio de generaci√≥n de mensualidades
        function setMonthlyFeeGenerationStartDate() {
            try {
                const dateInput = document.getElementById('monthlyFeeGenerationStartDate');
                const dateString = dateInput.value;
                
                if (!dateString) {
                    alert('‚ùå Por favor selecciona una fecha');
                    return;
                }
                
                showLoading('Guardando fecha de inicio...');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (result && result.success) {
                            alert('‚úÖ Fecha de inicio guardada exitosamente\n\nüìÜ Fecha configurada: ' + new Date(dateString).toLocaleDateString('es-ES') + '\n\n‚è∏Ô∏è La generaci√≥n de mensualidades estar√° pausada hasta esta fecha.');
                            loadSystemConfig(); // Recargar para mostrar la fecha actualizada
                        } else {
                            showError(result && result.message ? result.message : 'Error guardando fecha');
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error:', error);
                        showError('Error guardando fecha: ' + error.toString());
                    })
                    .setMonthlyFeeGenerationStartDate(dateString);
                    
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Cargar fecha de inicio de generaci√≥n de mensualidades
        function loadMonthlyFeeGenerationStartDate() {
            try {
                google.script.run
                    .withSuccessHandler(function(startDate) {
                        if (startDate) {
                            // startDate puede ser un objeto Date serializado o un string ISO
                            let date;
                            if (typeof startDate === 'string') {
                                date = new Date(startDate);
                            } else if (startDate instanceof Date) {
                                date = startDate;
                            } else if (startDate && startDate.getTime) {
                                // Si es un objeto Date de Google Apps Script
                                date = new Date(startDate.getTime ? startDate.getTime() : startDate);
                            } else {
                                date = new Date(startDate);
                            }
                            
                            if (!isNaN(date.getTime())) {
                                const dateString = date.toISOString().split('T')[0];
                                const dateInput = document.getElementById('monthlyFeeGenerationStartDate');
                                if (dateInput) {
                                    dateInput.value = dateString;
                                }
                            }
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error cargando fecha de inicio:', error);
                    })
                    .getMonthlyFeeGenerationStartDateString();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Eliminar todas las mensualidades (pendientes y pagadas)
        function deleteAllMonthlyPaymentsUI() {
            try {
                // Primero mostrar preview sin confirmaci√≥n
                showLoading('Analizando mensualidades...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Preview eliminaci√≥n de mensualidades:', result);

                        if (result && result.success) {
                            if (result.preview) {
                                // Mostrar preview y pedir confirmaci√≥n
                                var message = '‚ö†Ô∏è PREVIEW DE ELIMINACI√ìN DE MENSUALIDADES\n\n';
                                message += 'üìä RESUMEN:\n';
                                message += '‚Ä¢ Total de mensualidades a eliminar: ' + (result.deletedPendingCount + result.deletedPaidCount) + '\n';
                                message += '‚Ä¢ Pendientes: ' + result.deletedPendingCount + ' (Monto total: $' + (result.totalPendingAmount || 0).toFixed(2) + ')\n';
                                message += '‚Ä¢ Pagadas: ' + result.deletedPaidCount + ' (Monto total: $' + (result.totalPaidAmount || 0).toFixed(2) + ')\n';
                                message += '‚Ä¢ Monto total: $' + (result.totalAmount || 0).toFixed(2) + '\n\n';

                                if (result.details && result.details.length > 0) {
                                    message += 'MENSUALIDADES QUE SER√ÅN ELIMINADAS:\n';
                                    result.details.slice(0, 15).forEach(function(payment, index) {
                                        message += (index + 1) + '. ID: ' + (payment.pagoId || 'N/A') + '\n';
                                        message += '   Jugador: ' + (payment.jugadorId || 'N/A') + '\n';
                                        message += '   Tipo: ' + (payment.tipo || 'N/A') + '\n';
                                        message += '   Estado: ' + (payment.estado || 'N/A') + '\n';
                                        message += '   Monto: $' + (payment.monto || 0).toFixed(2) + '\n';
                                        message += '   Fecha: ' + (payment.fecha || 'N/A') + '\n\n';
                                    });
                                    if (result.details.length > 15) {
                                        message += '... y ' + (result.details.length - 15) + ' mensualidades m√°s\n\n';
                                    }
                                } else {
                                    message += '‚úÖ No hay mensualidades para eliminar\n\n';
                                }

                                message += '‚ö†Ô∏è IMPORTANTE: Esta operaci√≥n eliminar√° TODAS las mensualidades (pendientes Y pagadas).\n';
                                message += 'Esta acci√≥n NO se puede deshacer. Las m√©tricas contables se ver√°n afectadas.\n\n';
                                message += '¬øEst√°s seguro de que deseas continuar?';

                                if (confirm(message)) {
                                    // Ejecutar eliminaci√≥n con confirm=true
                                    executeDeleteAllMonthlyPayments();
                                }
                            } else if (result.deletedCount !== undefined) {
                                // Ya se ejecut√≥ la eliminaci√≥n
                                var message = '‚úÖ ELIMINACI√ìN DE MENSUALIDADES COMPLETADA\n\n';
                                message += 'üìä RESUMEN:\n';
                                message += '‚Ä¢ Mensualidades eliminadas: ' + result.deletedCount + '\n';
                                message += '‚Ä¢ Pendientes eliminadas: ' + result.deletedPendingCount + '\n';
                                message += '‚Ä¢ Pagadas eliminadas: ' + result.deletedPaidCount + '\n';
                                message += '‚Ä¢ Monto total eliminado: $' + (result.totalAmount || 0).toFixed(2) + '\n\n';
                                message += '‚ö†Ô∏è Las m√©tricas contables se actualizar√°n autom√°ticamente en el pr√≥ximo acceso al dashboard.';

                                alert(message);
                            } else {
                                alert(result.message || 'No hay mensualidades para eliminar');
                            }
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo completar la eliminaci√≥n';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error en eliminaci√≥n de mensualidades:', error);
                        showError('Error en eliminaci√≥n de mensualidades: ' + error.toString());
                    })
                    .deleteAllMonthlyPayments(false); // Preview sin confirmaci√≥n

            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Funci√≥n auxiliar para ejecutar eliminaci√≥n de mensualidades con confirmaci√≥n
        function executeDeleteAllMonthlyPayments() {
            try {
                showLoading('Eliminando mensualidades...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        console.log('Resultado eliminaci√≥n de mensualidades:', result);

                        if (result && result.success) {
                            var message = '‚úÖ ELIMINACI√ìN DE MENSUALIDADES COMPLETADA\n\n';
                            message += 'üìä RESUMEN:\n';
                            message += '‚Ä¢ Mensualidades eliminadas: ' + result.deletedCount + '\n';
                            message += '‚Ä¢ Pendientes eliminadas: ' + result.deletedPendingCount + '\n';
                            message += '‚Ä¢ Pagadas eliminadas: ' + result.deletedPaidCount + '\n';
                            message += '‚Ä¢ Monto total eliminado: $' + (result.totalAmount || 0).toFixed(2) + '\n\n';
                            message += '‚ö†Ô∏è Las m√©tricas contables se actualizar√°n autom√°ticamente en el pr√≥ximo acceso al dashboard.';

                            alert(message);
                        } else {
                            var errorMsg = result && result.message ? result.message : 'No se pudo completar la eliminaci√≥n';
                            showError(errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        console.error('Error en eliminaci√≥n de mensualidades:', error);
                        showError('Error en eliminaci√≥n de mensualidades: ' + error.toString());
                    })
                    .deleteAllMonthlyPayments(true); // Ejecutar con confirmaci√≥n

            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showError('Error: ' + error.toString());
            }
        }

        // Mostrar resultados del diagn√≥stico
        function displayDiagnosisResults(diagnosis) {
            try {
                let message = 'üî¨ DIAGN√ìSTICO DEL SISTEMA\n\n';
                
                // Verificar si diagnosis es null o undefined
                if (!diagnosis) {
                    message += '‚ùå Error: No se pudo obtener el diagn√≥stico del sistema\n';
                    message += 'üí° Posibles causas:\n';
                    message += '   ‚Ä¢ Error de conexi√≥n con Google Apps Script\n';
                    message += '   ‚Ä¢ Permisos insuficientes\n';
                    message += '   ‚Ä¢ Error en la funci√≥n de diagn√≥stico\n\n';
                    message += 'üîß Soluciones:\n';
                    message += '   ‚Ä¢ Verificar conexi√≥n a internet\n';
                    message += '   ‚Ä¢ Recargar la p√°gina\n';
                    message += '   ‚Ä¢ Verificar permisos del script';
                    alert(message);
                    return;
                }
                
                // Verificar si hay error cr√≠tico
                if (diagnosis.status === 'error' || diagnosis.error) {
                    message += '‚ùå Error Cr√≠tico: ' + (diagnosis.error || diagnosis.message || 'Error desconocido');
                    alert(message);
                    return;
                }
                
                // Mostrar informaci√≥n del sistema
                message += 'üìä Estado de las Hojas:\n';
                if (diagnosis.sheets && typeof diagnosis.sheets === 'object') {
                    Object.keys(diagnosis.sheets).forEach(sheetName => {
                        const sheet = diagnosis.sheets[sheetName];
                        if (sheet) {
                            const status = sheet.exists ? '‚úÖ' : '‚ùå';
                            const dataStatus = sheet.hasData ? 'üìÑ' : 'üì≠';
                            message += `${status} ${sheetName}: ${sheet.rows || 0} filas ${dataStatus}\n`;
                            
                            if (sheetName === 'Aprobaciones' && sheet.pendingCount !== undefined) {
                                message += `   üìã Aprobaciones pendientes: ${sheet.pendingCount}\n`;
                            }
                            
                            if (sheet.error) {
                                message += `   ‚ö†Ô∏è Error: ${sheet.error}\n`;
                            }
                        }
                    });
                } else {
                    message += '‚ùå No se pudo obtener informaci√≥n de las hojas\n';
                }
                
                // Mostrar configuraci√≥n
                if (diagnosis.config && diagnosis.config.forms) {
                    message += '\nüìã Configuraci√≥n:\n';
                    message += `   ‚Ä¢ Formulario de Admisi√≥n: ${diagnosis.config.forms.ADMISSION_FORM_ID ? 'Configurado' : 'No configurado'}\n`;
                    message += `   ‚Ä¢ Formulario de Torneo: ${diagnosis.config.forms.TOURNAMENT_FORM_ID ? 'Configurado' : 'No configurado'}\n`;
                }
                
                // Mostrar triggers
                if (diagnosis.config && diagnosis.config.triggers) {
                    message += `   ‚Ä¢ Triggers activos: ${diagnosis.config.triggers.count}\n`;
                }
                
                // Mostrar errores
                if (diagnosis.errors && diagnosis.errors.length > 0) {
                    message += '\n‚ö†Ô∏è Errores encontrados:\n';
                    diagnosis.errors.forEach(error => {
                        message += `   ‚Ä¢ ${error}\n`;
                    });
                }
                
                // Mostrar recomendaciones
                message += '\nüí° Recomendaciones:\n';
                if (!diagnosis.sheets || !diagnosis.sheets.Aprobaciones || !diagnosis.sheets.Aprobaciones.exists) {
                    message += '   ‚Ä¢ Crear hoja de Aprobaciones\n';
                } else if (!diagnosis.sheets.Aprobaciones.hasData) {
                    message += '   ‚Ä¢ Procesar datos del formulario\n';
                } else if (diagnosis.sheets.Aprobaciones.pendingCount === 0) {
                    message += '   ‚Ä¢ No hay aprobaciones pendientes\n';
                }
                
                if (diagnosis.errors && diagnosis.errors.length > 0) {
                    message += '   ‚Ä¢ Revisar y corregir errores encontrados\n';
                }
                
                alert(message);
                
            } catch (error) {
                console.error('Error en displayDiagnosisResults:', error);
                alert('‚ùå Error mostrando resultados del diagn√≥stico: ' + error.message);
            }
        }

        // Funci√≥n para procesar datos del formulario
        function processFormData() {
            if (confirm('¬øEst√° seguro de procesar los datos del formulario? Esto agregar√° todos los jugadores pendientes a la cola de aprobaciones.')) {
                try {
                    console.log('Procesando datos del formulario...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Datos procesados:', result);
                            if (result.success) {
                                showSuccess(result.message);
                            } else {
                                showError(result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error procesando datos:', error);
                            showError('Error procesando datos del formulario: ' + error.toString());
                        })
                        .processManualFormData();
                } catch (error) {
                    console.error('Error en procesamiento:', error);
                    showError('Error en procesamiento: ' + error.message);
                }
            }
        }

        // Funci√≥n para procesar datos directamente
        function processFormDataDirectly() {
            if (confirm('¬øEst√° seguro de procesar los datos directamente? Esto agregar√° los jugadores de ejemplo a la cola de aprobaciones.')) {
                try {
                    console.log('Procesando datos directamente...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Datos procesados directamente:', result);
                            if (result.success) {
                                showSuccess(result.message);
                            } else {
                                showError(result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error procesando datos directamente:', error);
                            showError('Error procesando datos directamente: ' + error.toString());
                        })
                        .processFormDataDirectly();
                } catch (error) {
                    console.error('Error en procesamiento directo:', error);
                    showError('Error en procesamiento directo: ' + error.message);
                }
            }
        }

        // Funci√≥n para crear datos de prueba
        function createTestData() {
            if (confirm('¬øEst√° seguro de crear datos de prueba? Esto agregar√° 3 jugadores de prueba a la cola de aprobaciones.')) {
                try {
                    console.log('Creando datos de prueba...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Datos de prueba creados:', result);
                            if (result.success) {
                                showSuccess(result.message + ' Ahora puedes ir a Aprobaciones para ver los datos.');
                            } else {
                                showError(result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error creando datos de prueba:', error);
                            showError('Error creando datos de prueba: ' + error.toString());
                        })
                        .createTestApprovalData();
                } catch (error) {
                    console.error('Error en creaci√≥n de datos de prueba:', error);
                    showError('Error en creaci√≥n de datos de prueba: ' + error.message);
                }
            }
        }

        // Funci√≥n para asegurar que existan datos de prueba
        function ensureTestData() {
            try {
                console.log('Asegurando datos de prueba...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Verificaci√≥n de datos completada:', result);
                        if (result.success) {
                            let message = `‚úÖ ${result.message}\n\n`;
                            if (result.existingRows) {
                                message += `üìä Ya existen ${result.existingRows} jugadores en la hoja de Aprobaciones.\n\n`;
                            } else if (result.created) {
                                message += `üìä Detalles:\n`;
                                message += `‚Ä¢ Jugadores creados: ${result.created}\n`;
                                message += `‚Ä¢ Filas: ${result.rows}\n`;
                                message += `‚Ä¢ Total de filas: ${result.totalRows}\n\n`;
                            }
                            message += `üí° Ve a Aprobaciones para ver los jugadores.`;
                            alert(message);
                        } else {
                            showError(result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error asegurando datos de prueba:', error);
                        showError('Error asegurando datos de prueba: ' + error.toString());
                    })
                    .ensureTestDataExists();
            } catch (error) {
                console.error('Error en ensureTestData:', error);
                showError('Error asegurando datos de prueba: ' + error.message);
            }
        }

        // Funci√≥n para verificar datos de aprobaciones
        function checkApprovalsData() {
            try {
                console.log('Verificando datos de aprobaciones...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Verificaci√≥n de datos completada:', result);
                        if (result.success) {
                            let message = `üîç VERIFICACI√ìN DE DATOS DE APROBACIONES\n\n`;
                            message += `üìä Estado de la hoja:\n`;
                            message += `‚Ä¢ Total de filas: ${result.totalRows}\n`;
                            message += `‚Ä¢ Filas de datos: ${result.dataRows}\n`;
                            message += `‚Ä¢ Headers: ${result.headers.length} columnas\n`;
                            if (result.lastRow) {
                                message += `‚Ä¢ √öltima fila usada: ${result.lastRow}\n`;
                                message += `‚Ä¢ √öltima columna usada: ${result.lastCol}\n`;
                            }
                            message += `\n`;
                            
                            if (result.dataRows > 0) {
                                message += `‚úÖ Hay ${result.dataRows} jugadores en la hoja de Aprobaciones.\n\n`;
                                message += `üìã Headers encontrados:\n`;
                                result.headers.forEach((header, index) => {
                                    message += `   ${index + 1}. ${header}\n`;
                                });
                            } else {
                                message += `‚ùå No hay datos en la hoja de Aprobaciones.\n`;
                                message += `üí° Usa "üî• Forzar Creaci√≥n y Lectura de Datos" para solucionarlo.`;
                            }
                            
                            alert(message);
                        } else {
                            showError(result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error verificando datos:', error);
                        showError('Error verificando datos: ' + error.toString());
                    })
                    .checkApprovalsData();
            } catch (error) {
                console.error('Error en checkApprovalsData:', error);
                showError('Error verificando datos: ' + error.message);
            }
        }

        // Funci√≥n para forzar creaci√≥n y lectura de datos de prueba
        function forceCreateAndReadTestData() {
            if (confirm('¬øEst√° seguro de forzar la creaci√≥n y lectura de datos de prueba? Esto limpiar√° la hoja de Aprobaciones y crear√° nuevos datos.')) {
                try {
                    console.log('Forzando creaci√≥n y lectura de datos de prueba...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Creaci√≥n forzada completada:', result);
                            if (result.success) {
                                let message = `üî• ${result.message}\n\n`;
                                message += `üìä Detalles:\n`;
                                message += `‚Ä¢ Total de filas: ${result.totalRows}\n`;
                                message += `‚Ä¢ Filas de datos: ${result.dataRows}\n`;
                                message += `‚Ä¢ √öltima fila usada: ${result.lastRow}\n`;
                                message += `‚Ä¢ √öltima columna usada: ${result.lastCol}\n\n`;
                                message += `üí° Ahora ve a Aprobaciones para ver los jugadores.`;
                                alert(message);
                            } else {
                                showError(result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error forzando creaci√≥n:', error);
                            showError('Error forzando creaci√≥n: ' + error.toString());
                        })
                        .forceCreateAndReadTestData();
                } catch (error) {
                    console.error('Error en forceCreateAndReadTestData:', error);
                    showError('Error forzando creaci√≥n: ' + error.message);
                }
            }
        }

        // Funci√≥n para probar datos simples
        function testSimpleData() {
            try {
                console.log('Probando datos simples...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Datos simples recibidos:', result);
                        console.log('Tipo de resultado:', typeof result);
                        console.log('Es array:', Array.isArray(result));
                        
                        if (Array.isArray(result)) {
                            let message = `üß™ PRUEBA DE DATOS SIMPLES\n\n`;
                            message += `‚úÖ Datos recibidos correctamente\n`;
                            message += `‚Ä¢ Tipo: ${typeof result}\n`;
                            message += `‚Ä¢ Es array: ${Array.isArray(result)}\n`;
                            message += `‚Ä¢ Longitud: ${result.length}\n\n`;
                            message += `üìã Datos:\n`;
                            result.forEach((item, index) => {
                                message += `${index + 1}. ${item.nombre} (${item.estado})\n`;
                            });
                            message += `\nüí° La serializaci√≥n funciona correctamente.`;
                            alert(message);
                        } else if (result && result.error) {
                            showError('Error en datos simples: ' + result.message);
                        } else {
                            showError('Error: Resultado inesperado - Tipo: ' + typeof result);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error probando datos simples:', error);
                        showError('Error probando datos simples: ' + error.toString());
                    })
                    .testSimpleData();
            } catch (error) {
                console.error('Error en testSimpleData:', error);
                showError('Error probando datos simples: ' + error.message);
            }
        }

        // Funci√≥n para procesar todos los datos de FORM_MATRICULA
        function processAllFormMatriculaData() {
            if (confirm('¬øEst√° seguro de procesar TODOS los datos de FORM_MATRICULA? Esto limpiar√° la hoja de Aprobaciones y procesar√° todos los registros existentes.')) {
                try {
                    console.log('Procesando todos los datos de FORM_MATRICULA...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Procesamiento completado:', result);
                            if (result.success) {
                                let message = `üìã ${result.message}\n\n`;
                                message += `üìä Estad√≠sticas del Procesamiento:\n`;
                                message += `‚Ä¢ Total de registros en FORM_MATRICULA: ${result.total}\n`;
                                message += `‚Ä¢ Registros procesados exitosamente: ${result.processed}\n`;
                                message += `‚Ä¢ Errores encontrados: ${result.errors}\n`;
                                message += `‚Ä¢ Filas finales en Aprobaciones: ${result.finalRows}\n\n`;
                                
                                if (result.errors > 0) {
                                    message += `‚ö†Ô∏è Errores encontrados:\n`;
                                    result.errorDetails.slice(0, 5).forEach(error => {
                                        message += `‚Ä¢ ${error}\n`;
                                    });
                                    if (result.errorDetails.length > 5) {
                                        message += `‚Ä¢ ... y ${result.errorDetails.length - 5} errores m√°s\n`;
                                    }
                                    message += `\n`;
                                }
                                
                                message += `üí° Ve a Aprobaciones para ver todos los jugadores procesados.`;
                                alert(message);
                            } else {
                                showError(result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error procesando FORM_MATRICULA:', error);
                            showError('Error procesando FORM_MATRICULA: ' + error.toString());
                        })
                        .processAllFormMatriculaData();
                } catch (error) {
                    console.error('Error en processAllFormMatriculaData:', error);
                    showError('Error procesando FORM_MATRICULA: ' + error.message);
                }
            }
        }

        // Funci√≥n para procesar datos en lotes (m√°s eficiente para grandes vol√∫menes)
        function processFormMatriculaDataInBatches() {
            if (confirm('¬øEst√° seguro de procesar TODOS los datos de FORM_MATRICULA en lotes? Esto es m√°s eficiente para grandes vol√∫menes (200+ jugadores) y limpiar√° la hoja de Aprobaciones.')) {
                try {
                    console.log('Procesando datos de FORM_MATRICULA en lotes...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Procesamiento en lotes completado:', result);
                            if (result.success) {
                                let message = `üöÄ ${result.message}\n\n`;
                                message += `üìä Estad√≠sticas del Procesamiento en Lotes:\n`;
                                message += `‚Ä¢ Total de registros en FORM_MATRICULA: ${result.total}\n`;
                                message += `‚Ä¢ Registros procesados exitosamente: ${result.processed}\n`;
                                message += `‚Ä¢ Lotes procesados: ${result.batches}\n`;
                                message += `‚Ä¢ Errores encontrados: ${result.errors}\n`;
                                message += `‚Ä¢ Filas finales en Aprobaciones: ${result.finalRows}\n\n`;
                                
                                if (result.errors > 0) {
                                    message += `‚ö†Ô∏è Errores encontrados:\n`;
                                    result.errorDetails.slice(0, 5).forEach(error => {
                                        message += `‚Ä¢ ${error}\n`;
                                    });
                                    if (result.errorDetails.length > 5) {
                                        message += `‚Ä¢ ... y ${result.errorDetails.length - 5} errores m√°s\n`;
                                    }
                                    message += `\n`;
                                }
                                
                                message += `üí° Ve a Aprobaciones para ver todos los jugadores procesados.`;
                                alert(message);
                            } else {
                                showError(result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error procesando FORM_MATRICULA en lotes:', error);
                            showError('Error procesando FORM_MATRICULA en lotes: ' + error.toString());
                        })
                        .processFormMatriculaDataInBatches();
                } catch (error) {
                    console.error('Error en processFormMatriculaDataInBatches:', error);
                    showError('Error procesando FORM_MATRICULA en lotes: ' + error.message);
                }
            }
        }

        // Funci√≥n para probar obtener todas las aprobaciones
        function testGetAllApprovals() {
            try {
                console.log('Probando obtener todas las aprobaciones...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Todas las aprobaciones recibidas:', result);
                        console.log('Tipo de resultado:', typeof result);
                        console.log('Es array:', Array.isArray(result));
                        
                        if (Array.isArray(result)) {
                            let message = `üîç TODAS LAS APROBACIONES\n\n`;
                            message += `‚úÖ Datos recibidos correctamente\n`;
                            message += `‚Ä¢ Tipo: ${typeof result}\n`;
                            message += `‚Ä¢ Es array: ${Array.isArray(result)}\n`;
                            message += `‚Ä¢ Total de aprobaciones: ${result.length}\n\n`;
                            
                            if (result.length > 0) {
                                message += `üìã Primeras 5 aprobaciones:\n`;
                                result.slice(0, 5).forEach((item, index) => {
                                    const nombre = item['Nombre del Jugador'] || item['Nombre'] || 'Sin nombre';
                                    const estado = item['Estado'] || 'Sin estado';
                                    message += `${index + 1}. ${nombre} (${estado})\n`;
                                });
                                
                                if (result.length > 5) {
                                    message += `... y ${result.length - 5} aprobaciones m√°s\n`;
                                }
                            } else {
                                message += `‚ùå No hay aprobaciones en el sistema`;
                            }
                            
                            message += `\nüí° Ve a Aprobaciones para ver la lista completa.`;
                            alert(message);
                        } else if (result && result.error) {
                            showError('Error obteniendo aprobaciones: ' + result.message);
                        } else {
                            showError('Error: Resultado inesperado - Tipo: ' + typeof result);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error obteniendo aprobaciones:', error);
                        showError('Error obteniendo aprobaciones: ' + error.toString());
                    })
                    .getAllApprovals();
            } catch (error) {
                console.error('Error en testGetAllApprovals:', error);
                showError('Error obteniendo aprobaciones: ' + error.message);
            }
        }

        // Funci√≥n para limpiar registros vac√≠os
        function cleanEmptyRecords() {
            if (confirm('¬øEst√° seguro de limpiar los registros vac√≠os de la hoja de Aprobaciones? Esto eliminar√° todos los registros que no tengan nombre o estado.')) {
                try {
                    console.log('Limpiando registros vac√≠os...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Limpieza completada:', result);
                            if (result && result.success) {
                                let message = `üßπ ${result.message}\n\n`;
                                message += `üìä Estad√≠sticas de la Limpieza:\n`;
                                message += `‚Ä¢ Registros vac√≠os eliminados: ${result.cleaned}\n`;
                                message += `‚Ä¢ Registros v√°lidos restantes: ${result.remaining}\n\n`;
                                message += `üí° Ve a Aprobaciones para ver la lista limpia.`;
                                alert(message);
                            } else {
                                const errorMsg = result && result.message ? result.message : 'Error desconocido';
                                showError('Error: ' + errorMsg);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error limpiando registros:', error);
                            showError('Error de conexi√≥n limpiando registros: ' + error.toString());
                        })
                        .cleanEmptyApprovalRecords();
                } catch (error) {
                    console.error('Error en cleanEmptyRecords:', error);
                    showError('Error limpiando registros: ' + error.message);
                }
            }
        }

        // Funci√≥n para limpieza simple
        function simpleCleanEmptyRecords() {
            if (confirm('¬øEst√° seguro de hacer una limpieza simple? Esto eliminar√° solo los registros que no tengan nombre.')) {
                try {
                    console.log('Iniciando limpieza simple...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Limpieza simple completada:', result);
                            if (result && result.success) {
                                let message = `üßΩ ${result.message}\n\n`;
                                message += `üìä Estad√≠sticas de la Limpieza Simple:\n`;
                                message += `‚Ä¢ Registros vac√≠os eliminados: ${result.cleaned}\n`;
                                message += `‚Ä¢ Registros v√°lidos restantes: ${result.remaining}\n\n`;
                                message += `üí° Ve a Aprobaciones para ver la lista limpia.`;
                                alert(message);
                            } else {
                                const errorMsg = result && result.message ? result.message : 'Error desconocido';
                                showError('Error: ' + errorMsg);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error en limpieza simple:', error);
                            showError('Error de conexi√≥n en limpieza simple: ' + error.toString());
                        })
                        .simpleCleanEmptyRecords();
                } catch (error) {
                    console.error('Error en simpleCleanEmptyRecords:', error);
                    showError('Error en limpieza simple: ' + error.message);
                }
            }
        }

        // Funci√≥n para diagn√≥stico de datos
        function diagnoseApprovalsData() {
            try {
                console.log('Ejecutando diagn√≥stico de datos...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Diagn√≥stico completado:', result);
                        if (result && result.success) {
                            let message = `üîç ${result.message}\n\n`;
                            message += `üìä Informaci√≥n de la Hoja:\n`;
                            message += `‚Ä¢ Total de filas: ${result.totalRows}\n`;
                            message += `‚Ä¢ Filas de datos: ${result.dataRows}\n`;
                            message += `‚Ä¢ Filas v√°lidas: ${result.validRows}\n\n`;
                            
                            if (result.analysis && result.analysis.length > 0) {
                                message += `üìã An√°lisis de Filas:\n`;
                                result.analysis.forEach((item, index) => {
                                    if (index < 10) { // Mostrar solo las primeras 10
                                        message += `${item.fila}. ${item.nombre} ${item.apellidos} (${item.estado})\n`;
                                    }
                                });
                                if (result.analysis.length > 10) {
                                    message += `... y ${result.analysis.length - 10} m√°s\n`;
                                }
                                message += `\n`;
                            }
                            
                            message += `üí° Si hay 12 filas pero 0 v√°lidas, hay un problema en el filtrado.`;
                            alert(message);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error en diagn√≥stico:', error);
                        showError('Error de conexi√≥n en diagn√≥stico: ' + error.toString());
                    })
                    .diagnoseApprovalsData();
            } catch (error) {
                console.error('Error en diagnoseApprovalsData:', error);
                showError('Error en diagn√≥stico: ' + error.message);
            }
        }

        // Funci√≥n para verificar y recrear la hoja de Aprobaciones
        function verifyAndRecreateApprovalsSheet() {
            try {
                console.log('Verificando y recreando hoja de Aprobaciones...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Verificaci√≥n completada:', result);
                        if (result && result.success) {
                            let message = `üîß ${result.message}\n\n`;
                            message += `üìä Estado de la Hoja:\n`;
                            message += `‚Ä¢ Total de filas: ${result.totalRows}\n\n`;
                            
                            if (result.processed) {
                                message += `üìã Procesamiento Realizado:\n`;
                                message += `‚Ä¢ Registros procesados: ${result.processed.added || 0}\n`;
                                message += `‚Ä¢ Lotes procesados: ${result.processed.batches || 0}\n`;
                                message += `‚Ä¢ Errores: ${result.processed.errors || 0}\n\n`;
                            }
                            
                            message += `üí° Ve a Aprobaciones para ver los datos procesados.`;
                            alert(message);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error en verificaci√≥n:', error);
                        showError('Error de conexi√≥n en verificaci√≥n: ' + error.toString());
                    })
                    .verifyAndRecreateApprovalsSheet();
            } catch (error) {
                console.error('Error en verifyAndRecreateApprovalsSheet:', error);
                showError('Error en verificaci√≥n: ' + error.message);
            }
        }

        // Funci√≥n para probar obtener todos los datos
        function testGetAllApprovalsData() {
            try {
                console.log('Probando obtener todos los datos...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Datos obtenidos:', result);
                        if (Array.isArray(result)) {
                            let message = `üìä Datos Obtenidos Exitosamente\n\n`;
                            message += `‚Ä¢ Total de registros: ${result.length}\n\n`;
                            
                            if (result.length > 0) {
                                message += `üìã Primeros 5 registros:\n`;
                                result.slice(0, 5).forEach((item, index) => {
                                    const nombre = item['Nombre del Jugador'] || item['Nombre'] || 'Sin nombre';
                                    const apellidos = item['Apellidos del Jugador'] || item['Apellidos'] || 'Sin apellidos';
                                    const estado = item['Estado'] || 'Sin estado';
                                    message += `${index + 1}. ${nombre} ${apellidos} (${estado})\n`;
                                });
                                
                                if (result.length > 5) {
                                    message += `... y ${result.length - 5} m√°s\n`;
                                }
                                message += `\n`;
                            }
                            
                            message += `üí° Ve a Aprobaciones para ver todos los datos.`;
                            alert(message);
                        } else {
                            showError('Error: No se obtuvieron datos v√°lidos');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error obteniendo datos:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .getAllApprovalsData();
            } catch (error) {
                console.error('Error en testGetAllApprovalsData:', error);
                showError('Error obteniendo datos: ' + error.message);
            }
        }

        // Funci√≥n para verificar hojas financieras
        function ensureFinancialSheets() {
            try {
                console.log('Verificando hojas financieras...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Verificaci√≥n completada:', result);
                        if (result && result.success) {
                            let message = `üí∞ ${result.message}\n\n`;
                            
                            if (result.createdSheets && result.createdSheets.length > 0) {
                                message += `üìã Hojas Creadas:\n`;
                                result.createdSheets.forEach(sheet => {
                                    message += `‚Ä¢ ${sheet}\n`;
                                });
                                message += `\n`;
                            }
                            
                            message += `üí° Ahora el Dashboard deber√≠a funcionar correctamente.`;
                            alert(message);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error verificando hojas financieras:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .ensureFinancialSheetsExist();
            } catch (error) {
                console.error('Error en ensureFinancialSheets:', error);
                showError('Error verificando hojas: ' + error.message);
            }
        }

        // Funci√≥n para procesar datos de FORM_MATRICULA (mejorado)
        function processFormMatriculaDataImproved() {
            try {
                console.log('Procesando datos de FORM_MATRICULA (mejorado)...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Procesamiento mejorado completado:', result);
                        if (result && result.success) {
                            let message = `üöÄ ${result.message}\n\n`;
                            message += `üìä Resultados:\n`;
                            message += `‚Ä¢ Registros procesados: ${result.processed}\n`;
                            message += `‚Ä¢ Total en FORM_MATRICULA: ${result.total}\n`;
                            message += `‚Ä¢ Errores: ${result.errors}\n`;
                            message += `‚Ä¢ Filas finales: ${result.finalRows}\n\n`;
                            message += `üí° Ve a Aprobaciones para ver los datos procesados.`;
                            alert(message);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error procesando datos (mejorado):', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .processFormMatriculaDataImproved();
            } catch (error) {
                console.error('Error en processFormMatriculaDataImproved:', error);
                showError('Error procesando datos: ' + error.message);
            }
        }

        // Funci√≥n para reprocesar datos con archivos corregidos
        function reprocessFormDataWithFiles() {
            try {
                console.log('Reprocesando datos con archivos corregidos...');
                showMessage('üîÑ Reprocesando datos con archivos corregidos...', 'info');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Resultado del reprocesamiento:', result);
                        if (result && result.success) {
                            let message = `üìé Reprocesamiento completado con archivos corregidos\n\n`;
                            message += `üìä Resultados:\n`;
                            message += `‚Ä¢ Registros procesados: ${result.processed}\n`;
                            message += `‚Ä¢ Total en FORM_MATRICULA: ${result.total}\n`;
                            message += `‚Ä¢ Errores: ${result.errors}\n`;
                            message += `‚Ä¢ Filas finales: ${result.finalRows}\n\n`;
                            message += `üí° Los archivos ahora deber√≠an mostrar URLs correctas en Aprobaciones.`;
                            alert(message);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error en reprocesamiento:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .processFormMatriculaDataImproved();
            } catch (error) {
                console.error('Error en reprocessFormDataWithFiles:', error);
                showError('Error reprocesando datos: ' + error.message);
            }
        }

        // Funci√≥n para diagnosticar datos de archivos
        function diagnoseFileData() {
            try {
                console.log('Diagnosticando datos de archivos...');
                showMessage('üîç Diagnosticando datos de archivos...', 'info');
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Resultado del diagn√≥stico:', result);
                        if (result && result.success) {
                            let message = `üîç Diagn√≥stico de Archivos Completado\n\n`;
                            message += `üìä Total de filas analizadas: ${result.diagnosis.totalRows}\n\n`;
                            
                            result.diagnosis.fileData.forEach((rowData, index) => {
                                message += `üìã Fila ${rowData.rowNumber}:\n`;
                                Object.keys(rowData.files).forEach(column => {
                                    const fileInfo = rowData.files[column];
                                    message += `  ‚Ä¢ Columna ${column}: ${fileInfo.type} - "${fileInfo.stringValue}" (${fileInfo.length} chars)\n`;
                                });
                                message += `\n`;
                            });
                            
                            message += `üí° Revisa los logs para m√°s detalles t√©cnicos.`;
                            alert(message);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error en diagn√≥stico:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .diagnoseFileData();
            } catch (error) {
                console.error('Error en diagnoseFileData:', error);
                showError('Error diagnosticando archivos: ' + error.message);
            }
        }

        // Funci√≥n para procesar datos de FORM_MATRICULA
        function processFormMatriculaData() {
            try {
                console.log('Procesando datos de FORM_MATRICULA...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Procesamiento completado:', result);
                        if (result && result.success) {
                            let message = `üìã ${result.message}\n\n`;
                            message += `üìä Resultados:\n`;
                            message += `‚Ä¢ Registros procesados: ${result.processed}\n`;
                            message += `‚Ä¢ Total en FORM_MATRICULA: ${result.total}\n`;
                            message += `‚Ä¢ Errores: ${result.errors}\n`;
                            message += `‚Ä¢ Filas finales: ${result.finalRows}\n\n`;
                            message += `üí° Ve a Aprobaciones para ver los datos procesados.`;
                            alert(message);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error procesando datos:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .processFormMatriculaData();
            } catch (error) {
                console.error('Error en processFormMatriculaData:', error);
                showError('Error procesando datos: ' + error.message);
            }
        }

        // Funci√≥n para crear datos de prueba
        function createTestData() {
            try {
                console.log('Creando datos de prueba...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Datos de prueba creados:', result);
                        if (result && result.success) {
                            alert(`üß™ ${result.message}`);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error creando datos de prueba:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .createTestData();
            } catch (error) {
                console.error('Error en createTestData:', error);
                showError('Error creando datos de prueba: ' + error.message);
            }
        }

        // Funci√≥n para verificar datos
        function checkData() {
            try {
                console.log('Verificando datos...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Verificaci√≥n completada:', result);
                        if (result && result.success) {
                            let message = `üîç ${result.message}\n\n`;
                            message += `üìä Estado:\n`;
                            message += `‚Ä¢ Total de filas: ${result.totalRows}\n`;
                            message += `‚Ä¢ Filas de datos: ${result.dataRows}\n`;
                            message += `‚Ä¢ Headers: ${result.headers.length}\n\n`;
                            message += `üìã Headers encontrados:\n`;
                            result.headers.forEach((header, index) => {
                                message += `${index + 1}. ${header}\n`;
                            });
                            alert(message);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error verificando datos:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .checkData();
            } catch (error) {
                console.error('Error en checkData:', error);
                showError('Error verificando datos: ' + error.message);
            }
        }

        // Funci√≥n para diagnosticar FORM_MATRICULA
        function diagnoseFormMatricula() {
            try {
                console.log('Diagnosticando FORM_MATRICULA...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Diagn√≥stico completado:', result);
                        console.log('Tipo de resultado:', typeof result);
                        console.log('Result es null:', result === null);
                        
                        if (result === null || result === undefined) {
                            showError('Error: La funci√≥n devolvi√≥ null o undefined');
                            return;
                        }
                        
                        if (result && result.success) {
                            let message = `üîç ${result.message}\n\n`;
                            message += `üìä Estado:\n`;
                            message += `‚Ä¢ Total de filas: ${result.totalRows}\n`;
                            message += `‚Ä¢ Filas de datos: ${result.dataRows}\n`;
                            message += `‚Ä¢ Headers: ${result.headers ? result.headers.length : 0}\n\n`;
                            
                            if (result.headers && result.headers.length > 0) {
                                message += `üìã Headers encontrados:\n`;
                                result.headers.forEach((header, index) => {
                                    message += `${index + 1}. ${header}\n`;
                                });
                                message += '\n';
                            }
                            
                            if (result.sampleData && result.sampleData.length > 0) {
                                message += `üìä Datos de muestra (primeras 3 filas):\n`;
                                result.sampleData.forEach((item, index) => {
                                    message += `\nFila ${item.rowNumber}:\n`;
                                    if (item.data) {
                                        Object.keys(item.data).forEach(key => {
                                            if (item.data[key] && item.data[key].toString().trim() !== '') {
                                                message += `‚Ä¢ ${key}: ${item.data[key]}\n`;
                                            }
                                        });
                                    }
                                });
                            } else {
                                message += 'No hay datos de muestra disponibles.\n';
                            }
                            
                            alert(message);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error diagnosticando FORM_MATRICULA:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .diagnoseFormMatricula();
            } catch (error) {
                console.error('Error en diagnoseFormMatricula:', error);
                showError('Error diagnosticando: ' + error.message);
            }
        }

        // Funci√≥n para diagnosticar todas las hojas
        function diagnoseAllSheets() {
            try {
                console.log('Diagnosticando todas las hojas...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Diagn√≥stico completado:', result);
                        console.log('Tipo de resultado:', typeof result);
                        console.log('Result es null:', result === null);
                        console.log('Result es undefined:', result === undefined);
                        
                        if (result === null || result === undefined) {
                            showError('Error: La funci√≥n devolvi√≥ null o undefined');
                            return;
                        }
                        
                        if (result && result.success) {
                            let message = `üìã ${result.message}\n\n`;
                            
                            if (result.sheets && result.sheets.length > 0) {
                                message += `üìä Hojas encontradas:\n`;
                                result.sheets.forEach((sheet, index) => {
                                    message += `\n${index + 1}. ${sheet.name}\n`;
                                    message += `   ‚Ä¢ Filas: ${sheet.totalRows} (datos: ${sheet.totalRows - 1})\n`;
                                    message += `   ‚Ä¢ Columnas: ${sheet.lastCol}\n`;
                                    message += `   ‚Ä¢ Tiene datos: ${sheet.hasData ? 'S√≠' : 'No'}\n`;
                                    
                                    if (sheet.headers && sheet.headers.length > 0) {
                                        message += `   ‚Ä¢ Headers: ${sheet.headers.slice(0, 5).join(', ')}${sheet.headers.length > 5 ? '...' : ''}\n`;
                                    }
                                    
                                    if (sheet.error) {
                                        message += `   ‚Ä¢ Error: ${sheet.error}\n`;
                                    }
                                });
                            } else {
                                message += 'No se encontraron hojas o hay un problema con los datos.';
                            }
                            
                            alert(message);
                        } else {
                            const errorMsg = result && result.message ? result.message : 'Error desconocido';
                            showError('Error: ' + errorMsg);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error diagnosticando hojas:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .diagnoseAllSheets();
            } catch (error) {
                console.error('Error en diagnoseAllSheets:', error);
                showError('Error diagnosticando: ' + error.message);
            }
        }

        // Funci√≥n de diagn√≥stico simple
        function simpleDiagnostic() {
            try {
                console.log('Ejecutando diagn√≥stico simple...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Diagn√≥stico simple completado:', result);
                        if (result && result.success) {
                            let message = `üîß ${result.message}\n\n`;
                            message += `üìä Informaci√≥n:\n`;
                            message += `‚Ä¢ Total de hojas: ${result.totalSheets}\n`;
                            message += `‚Ä¢ Nombres de hojas:\n`;
                            if (result.sheetNames) {
                                result.sheetNames.forEach((name, index) => {
                                    message += `  ${index + 1}. ${name}\n`;
                                });
                            }
                            alert(message);
                        } else {
                            showError('Error: ' + (result.message || 'Error desconocido'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error en diagn√≥stico simple:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .simpleDiagnostic();
            } catch (error) {
                console.error('Error ejecutando diagn√≥stico simple:', error);
                showError('Error: ' + error.message);
            }
        }

        // Funci√≥n para verificar FORM_MATRICULA de forma simple
        function simpleCheckFormMatricula() {
            try {
                console.log('Verificando FORM_MATRICULA...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Verificaci√≥n completada:', result);
                        if (result && result.success) {
                            let message = `üìã ${result.message}\n\n`;
                            message += `üìä Estado:\n`;
                            message += `‚Ä¢ √öltima fila: ${result.lastRow}\n`;
                            message += `‚Ä¢ √öltima columna: ${result.lastCol}\n`;
                            message += `‚Ä¢ Tiene datos: ${result.hasData ? 'S√≠' : 'No'}\n`;
                            alert(message);
                        } else {
                            showError('Error: ' + (result.message || 'Error desconocido'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error verificando FORM_MATRICULA:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .simpleCheckFormMatricula();
            } catch (error) {
                console.error('Error verificando FORM_MATRICULA:', error);
                showError('Error: ' + error.message);
            }
        }

        // Funci√≥n para crear el men√∫ manualmente
        function createMenu() {
            try {
                console.log('Creando men√∫ del sistema...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Men√∫ creado:', result);
                        alert('‚úÖ Men√∫ creado exitosamente. Recarga la p√°gina para verlo en la barra de men√∫.');
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error creando men√∫:', error);
                        showError('Error creando men√∫: ' + error.toString());
                    })
                    .createMenu();
            } catch (error) {
                console.error('Error en createMenu:', error);
                showError('Error: ' + error.message);
            }
        }

        // Funci√≥n para probar las funciones del men√∫
        function testMenuFunctions() {
            try {
                console.log('Probando funciones del men√∫...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Prueba completada:', result);
                        alert('‚úÖ Funciones del men√∫ probadas exitosamente.');
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error probando funciones:', error);
                        showError('Error probando funciones: ' + error.toString());
                    })
                    .showMainDashboard();
            } catch (error) {
                console.error('Error en testMenuFunctions:', error);
                showError('Error: ' + error.message);
            }
        }

        // Funci√≥n para verificar el estado del sistema
        function checkSystemStatus() {
            try {
                console.log('Verificando estado del sistema...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Estado del sistema:', result);
                        if (result && result.success) {
                            let message = `üîç ${result.message}\n\n`;
                            message += `üìä Informaci√≥n del Sistema:\n`;
                            message += `‚Ä¢ Total de hojas: ${result.totalSheets}\n`;
                            message += `‚Ä¢ Men√∫ disponible: ${result.hasMenu ? 'S√≠' : 'No'}\n\n`;
                            message += `üìã Hojas disponibles:\n`;
                            if (result.sheetNames) {
                                result.sheetNames.forEach((name, index) => {
                                    message += `  ${index + 1}. ${name}\n`;
                                });
                            }
                            alert(message);
                        } else {
                            showError('Error: ' + (result.message || 'Error desconocido'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error verificando estado:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .checkSystemStatus();
            } catch (error) {
                console.error('Error en checkSystemStatus:', error);
                showError('Error: ' + error.message);
            }
        }

        // Funci√≥n para probar aprobaciones pendientes
        function testPendingApprovals() {
            try {
                console.log('Probando aprobaciones pendientes...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Aprobaciones pendientes obtenidas:', result);
                        if (Array.isArray(result)) {
                            alert(`‚úÖ Aprobaciones Pendientes\n\n‚Ä¢ Total encontradas: ${result.length}\n\n${result.length > 0 ? 'Ve a Aprobaciones para ver los datos.' : 'No hay aprobaciones pendientes.'}`);
                        } else {
                            showError('Error: Los datos no se obtuvieron correctamente');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error obteniendo aprobaciones pendientes:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .getPendingApprovalsData();
            } catch (error) {
                console.error('Error en testPendingApprovals:', error);
                showError('Error obteniendo aprobaciones pendientes: ' + error.message);
            }
        }

        // Funci√≥n para obtener todos los datos
        function getAllApprovalsData() {
            try {
                console.log('Obteniendo todos los datos...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Datos obtenidos:', result);
                        if (Array.isArray(result)) {
                            alert(`üìä Datos Obtenidos Exitosamente\n\n‚Ä¢ Total de registros: ${result.length}\n\nVe a Aprobaciones para ver todos los datos.`);
                        } else {
                            showError('Error: Los datos no se obtuvieron correctamente');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error obteniendo datos:', error);
                        showError('Error de conexi√≥n: ' + error.toString());
                    })
                    .getAllApprovalsData();
            } catch (error) {
                console.error('Error en getAllApprovalsData:', error);
                showError('Error obteniendo datos: ' + error.message);
            }
        }

        // Funciones para configuraci√≥n del logo
        function loadLogoConfig() {
            try {
                console.log('Cargando configuraci√≥n del logo...');
                google.script.run
                    .withSuccessHandler(function(config) {
                        console.log('Configuraci√≥n del logo cargada:', config);
                        document.getElementById('academyName').value = config.academyName;
                        document.getElementById('academySubtitle').value = config.academySubtitle;
                        document.getElementById('academyYear').value = config.academyYear;
                        document.getElementById('primaryColor').value = config.primaryColor;
                        document.getElementById('primaryColorText').value = config.primaryColor;
                        document.getElementById('secondaryColor').value = config.secondaryColor;
                        document.getElementById('secondaryColorText').value = config.secondaryColor;
                        document.getElementById('accentColor').value = config.accentColor;
                        document.getElementById('accentColorText').value = config.accentColor;
                        
                        updateLogoPreview();
                        showSuccess('Configuraci√≥n del logo cargada exitosamente');
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error cargando configuraci√≥n del logo:', error);
                        showError('Error cargando configuraci√≥n del logo: ' + error.toString());
                    })
                    .getLogoConfig();
            } catch (error) {
                console.error('Error en carga de configuraci√≥n:', error);
                showError('Error en carga de configuraci√≥n: ' + error.message);
            }
        }

        function saveLogoConfig() {
            try {
                const config = {
                    academyName: document.getElementById('academyName').value.trim(),
                    academySubtitle: document.getElementById('academySubtitle').value.trim(),
                    academyYear: document.getElementById('academyYear').value.trim(),
                    primaryColor: document.getElementById('primaryColor').value,
                    secondaryColor: document.getElementById('secondaryColor').value,
                    accentColor: document.getElementById('accentColor').value
                };

                // Validar campos requeridos
                if (!config.academyName || !config.academySubtitle || !config.academyYear) {
                    showError('Todos los campos de texto son requeridos');
                    return;
                }

                console.log('Guardando configuraci√≥n del logo:', config);
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Configuraci√≥n del logo guardada:', result);
                        if (result.success) {
                            showSuccess(result.message);
                        } else {
                            showError(result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error guardando configuraci√≥n del logo:', error);
                        showError('Error guardando configuraci√≥n del logo: ' + error.toString());
                    })
                    .updateLogoConfig(config);
            } catch (error) {
                console.error('Error en guardado de configuraci√≥n:', error);
                showError('Error en guardado de configuraci√≥n: ' + error.message);
            }
        }

        function updateLogoPreview() {
            const academyName = document.getElementById('academyName').value || 'SUAREZ';
            const academySubtitle = document.getElementById('academySubtitle').value || 'ACADEMY';
            const academyYear = document.getElementById('academyYear').value || '2018';
            const primaryColor = document.getElementById('primaryColor').value || '#1e3a8a';
            const secondaryColor = document.getElementById('secondaryColor').value || '#3b82f6';
            const accentColor = document.getElementById('accentColor').value || '#fbbf24';

            // Actualizar texto
            document.querySelector('.logo-preview-name').textContent = academyName;
            document.querySelector('.logo-preview-subtitle').textContent = academySubtitle;
            document.querySelector('.logo-preview-year').textContent = academyYear;

            // Actualizar colores
            document.querySelector('.logo-preview-name').style.color = primaryColor;
            document.querySelector('.logo-preview-subtitle').style.color = accentColor;
            document.querySelector('.logo-preview-circle').style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
        }

        // Funciones para manejo de logo personalizado
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tipo de archivo
            if (!file.type.startsWith('image/')) {
                showError('Por favor selecciona un archivo de imagen v√°lido');
                return;
            }

            // Validar tama√±o (m√°ximo 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showError('El archivo es demasiado grande. M√°ximo 2MB permitido');
                return;
            }

            // Convertir a base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const logoData = {
                    data: e.target.result,
                    type: file.type,
                    name: file.name
                };

                // Mostrar vista previa
                document.getElementById('logoPreviewImage').src = e.target.result;
                document.getElementById('logoPreviewContainer').style.display = 'block';

                // Guardar logo
                saveCustomLogoToServer(logoData);
            };
            reader.readAsDataURL(file);
        }

        function saveCustomLogoToServer(logoData) {
            try {
                console.log('Guardando logo personalizado...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Logo guardado:', result);
                        if (result.success) {
                            showSuccess(result.message);
                        } else {
                            showError(result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error guardando logo:', error);
                        showError('Error guardando logo: ' + error.toString());
                    })
                    .saveCustomLogo(logoData);
            } catch (error) {
                console.error('Error en guardado de logo:', error);
                showError('Error en guardado de logo: ' + error.message);
            }
        }

        function loadCustomLogo() {
            try {
                console.log('Cargando logo personalizado...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Logo cargado:', result);
                        if (result.success) {
                            document.getElementById('logoPreviewImage').src = result.data;
                            document.getElementById('logoPreviewContainer').style.display = 'block';
                            showSuccess('Logo personalizado cargado exitosamente');
                        } else {
                            showError(result.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error cargando logo:', error);
                        showError('Error cargando logo: ' + error.toString());
                    })
                    .getCustomLogo();
            } catch (error) {
                console.error('Error en carga de logo:', error);
                showError('Error en carga de logo: ' + error.message);
            }
        }

        function deleteCustomLogo() {
            if (confirm('¬øEst√° seguro de eliminar el logo personalizado? Esto restaurar√° el logo por defecto.')) {
                try {
                    console.log('Eliminando logo personalizado...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Logo eliminado:', result);
                            if (result.success) {
                                document.getElementById('logoPreviewContainer').style.display = 'none';
                                showSuccess(result.message);
                            } else {
                                showError(result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error eliminando logo:', error);
                            showError('Error eliminando logo: ' + error.toString());
                        })
                        .deleteCustomLogo();
                } catch (error) {
                    console.error('Error en eliminaci√≥n de logo:', error);
                    showError('Error en eliminaci√≥n de logo: ' + error.message);
                }
            }
        }

        // Funciones para sistema de cobro mensual
        function testMonthlyBilling() {
            if (confirm('¬øEst√° seguro de ejecutar el cobro mensual? Esto crear√° registros de pago para todos los jugadores activos.')) {
                try {
                    console.log('Ejecutando cobro mensual...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Cobro mensual completado:', result);
                            if (result.success) {
                                let message = `‚úÖ Cobro mensual completado exitosamente!\n\n`;
                                message += `üìä Estad√≠sticas:\n`;
                                message += `‚Ä¢ Total de jugadores: ${result.total}\n`;
                                message += `‚Ä¢ Procesados: ${result.processed}\n`;
                                message += `‚Ä¢ Errores: ${result.errors}\n\n`;
                                message += `üí° Los registros de pago se han creado en la hoja de Pagos.`;
                                alert(message);
                            } else {
                                showError(result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error en cobro mensual:', error);
                            showError('Error en cobro mensual: ' + error.toString());
                        })
                        .processMonthlyBilling();
                } catch (error) {
                    console.error('Error ejecutando cobro mensual:', error);
                    showError('Error ejecutando cobro mensual: ' + error.message);
                }
            }
        }

        function showMonthlyFeeInfo() {
            try {
                console.log('Obteniendo informaci√≥n de mensualidades...');
                google.script.run
                    .withSuccessHandler(function(players) {
                        console.log('Informaci√≥n de jugadores obtenida:', players);
                        
                        if (!players || players.length === 0) {
                            alert('No hay jugadores registrados en el sistema.');
                            return;
                        }

                        let message = 'üí∞ INFORMACI√ìN DE MENSUALIDADES\n\n';
                        message += `Total de jugadores: ${players.length}\n\n`;
                        
                        let totalExpected = 0;
                        let scholarshipCount = 0;
                        let customFeeCount = 0;
                        
                        players.forEach(player => {
                            const monthlyFee = getPlayerMonthlyFeeInfo(player);
                            totalExpected += monthlyFee.amount;
                            
                            if (monthlyFee.type === 'becado') {
                                scholarshipCount++;
                            } else if (monthlyFee.isCustom) {
                                customFeeCount++;
                            }
                        });
                        
                        message += `üìä Resumen:\n`;
                        message += `‚Ä¢ Jugadores becados: ${scholarshipCount}\n`;
                        message += `‚Ä¢ Mensualidades personalizadas: ${customFeeCount}\n`;
                        message += `‚Ä¢ Mensualidades por defecto: ${players.length - scholarshipCount - customFeeCount}\n`;
                        message += `‚Ä¢ Ingreso mensual esperado: $${totalExpected.toFixed(2)}\n\n`;
                        message += `üí° Los becados no pagan mensualidad. Las mensualidades personalizadas se pueden configurar en el perfil de cada jugador.`;
                        
                        alert(message);
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error obteniendo informaci√≥n:', error);
                        showError('Error obteniendo informaci√≥n: ' + error.toString());
                    })
                    .getAllPlayers();
            } catch (error) {
                console.error('Error en informaci√≥n de mensualidades:', error);
                showError('Error en informaci√≥n de mensualidades: ' + error.message);
            }
        }

        function getPlayerMonthlyFeeInfo(player) {
            // Simular la l√≥gica de mensualidad (esto deber√≠a venir del backend)
            if (player.Tipo === 'becado') {
                return { amount: 0, type: 'becado', isCustom: true };
            }
            
            const customFee = player['Mensualidad Personalizada'] || player['Mensualidad'];
            if (customFee && customFee > 0) {
                return { amount: parseFloat(customFee), type: 'personalizada', isCustom: true };
            }
            
            // Usar valores por defecto
            const isFirstInFamily = true; // Simplificado para el ejemplo
            const amount = isFirstInFamily ? 130 : 110.50;
            return { amount: amount, type: isFirstInFamily ? 'individual' : 'familiar', isCustom: false };
        }
        
        // ========== FUNCIONES DE DIAGN√ìSTICO DE ARCHIVOS ==========
        
        function diagnosticarHojaJugadores() {
            try {
                console.log('üîç Diagnosticando hoja de Jugadores...');
                google.script.run
                    .withSuccessHandler(function() {
                        alert('‚úÖ Diagn√≥stico completado. Ve a Extensions ‚Üí Apps Script ‚Üí Ver Ejecuciones para ver los logs detallados.');
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error:', error);
                        alert('‚ùå Error: ' + error.toString());
                    })
                    .diagnosticarHojaJugadores();
            } catch (error) {
                console.error('Error en diagn√≥stico:', error);
                alert('Error: ' + error.message);
            }
        }
        
        function diagnosticarArchivosEnAprobaciones() {
            try {
                console.log('üìã Diagnosticando archivos en Aprobaciones...');
                google.script.run
                    .withSuccessHandler(function() {
                        alert('‚úÖ Diagn√≥stico completado. Ve a Extensions ‚Üí Apps Script ‚Üí Ver Ejecuciones para ver los logs detallados con el contenido de los archivos adjuntos.');
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error:', error);
                        alert('‚ùå Error: ' + error.toString());
                    })
                    .diagnosticarArchivosEnAprobaciones();
            } catch (error) {
                console.error('Error en diagn√≥stico:', error);
                alert('Error: ' + error.message);
            }
        }
        
        function agregarColumnasURLsCedulas() {
            try {
                console.log('‚ûï Agregando columnas de URLs...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result && result.success) {
                            alert(`‚úÖ ${result.message}\n\nColumnas agregadas: ${result.columnasAgregadas}\n\nAhora las columnas V y W est√°n listas para almacenar las URLs de las c√©dulas.`);
                        } else {
                            alert('‚ùå Error: ' + (result ? result.message : 'Desconocido'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error:', error);
                        alert('‚ùå Error: ' + error.toString());
                    })
                    .agregarColumnasURLsCedulas();
            } catch (error) {
                console.error('Error agregando columnas:', error);
                alert('Error: ' + error.message);
            }
        }

        // Funci√≥n para procesar hojas de formularios existentes
        function processExistingSheets() {
            if (confirm('¬øEst√° seguro de procesar las hojas FORM_MATRICULA y FORM_TORNEO? Esto agregar√° todos los datos a la cola de aprobaciones.')) {
                try {
                    console.log('Procesando hojas de formularios existentes...');
                    google.script.run
                        .withSuccessHandler(function(result) {
                            console.log('Hojas procesadas:', result);
                            if (result.success) {
                                let message = `‚úÖ Hojas de formularios procesadas exitosamente!\n\n`;
                                message += `üìä Resultados:\n`;
                                message += `‚Ä¢ Registros procesados: ${result.processed}\n`;
                                message += `‚Ä¢ Errores: ${result.errors}\n\n`;
                                message += `üí° Los datos se han agregado a la cola de aprobaciones. Ve a Aprobaciones para verlos.`;
                                alert(message);
                            } else {
                                showError(result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error procesando hojas:', error);
                            showError('Error procesando hojas: ' + error.toString());
                        })
                        .processExistingFormSheets();
                } catch (error) {
                    console.error('Error en procesamiento de hojas:', error);
                    showError('Error en procesamiento de hojas: ' + error.message);
                }
            }
        }

    </script>
</body>
</html>
